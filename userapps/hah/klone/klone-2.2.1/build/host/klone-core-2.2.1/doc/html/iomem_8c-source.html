<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: iomem.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>iomem.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: iomem.c,v 1.11 2007/07/20 10:33:15 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00013 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00014 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00015 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/ioprv.h&gt;</span>
00017 
00018 <span class="keyword">struct </span>io_mem_s
00019 {
00020     <span class="keyword">struct </span>io_s io; <span class="comment">/* must be the first item */</span>
00021     <span class="keywordtype">char</span> *buf;
00022     size_t size;
00023     size_t off;
00024     <span class="keywordtype">int</span> flags;
00025 };
00026 
00027 <span class="keyword">typedef</span> <span class="keyword">struct </span>io_mem_s io_mem_t;
00028 
00029 <span class="keyword">static</span> ssize_t io_mem_read(io_mem_t *io, <span class="keywordtype">char</span> *buf, size_t size);
00030 <span class="keyword">static</span> ssize_t io_mem_write(io_mem_t *io, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, size_t size);
00031 <span class="keyword">static</span> ssize_t io_mem_seek(io_mem_t *io, size_t off);
00032 <span class="keyword">static</span> ssize_t io_mem_tell(io_mem_t *im);
00033 <span class="keyword">static</span> <span class="keywordtype">int</span> io_mem_close(io_mem_t *io);
00034 <span class="keyword">static</span> <span class="keywordtype">int</span> io_mem_free(io_mem_t *io);
00035 
00036 <span class="keyword">static</span> ssize_t io_mem_tell(io_mem_t *im)
00037 {
00038     dbg_return_if (im == NULL, -1);
00039 
00040     <span class="keywordflow">return</span> im-&gt;off;
00041 }
00042 
00043 <span class="keyword">static</span> ssize_t io_mem_seek(io_mem_t *im, size_t off)
00044 {
00045     dbg_return_if (im == NULL, -1);
00046     
00047     <span class="keywordflow">if</span>(off &gt;= im-&gt;size)
00048         <span class="keywordflow">return</span> -1;
00049 
00050     im-&gt;off = off;
00051 
00052     <span class="keywordflow">return</span> off;
00053 }
00054 
00055 <span class="keyword">static</span> ssize_t io_mem_read(io_mem_t *im, <span class="keywordtype">char</span> *buf, size_t size)
00056 {
00057     <span class="keywordtype">char</span> *ptr;
00058     size_t sz;
00059 
00060     dbg_return_if (im == NULL, -1);
00061     dbg_return_if (buf == NULL, -1);
00062 
00063     sz = MIN(size, im-&gt;size - im-&gt;off);
00064     <span class="keywordflow">if</span>(sz)
00065     {
00066         ptr = im-&gt;buf + im-&gt;off; 
00067         memcpy(buf, ptr, sz);
00068         im-&gt;off += sz;
00069     }
00070 
00071     <span class="keywordflow">return</span> sz;
00072 }
00073 
00074 <span class="keyword">static</span> ssize_t io_mem_write(io_mem_t *im, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, size_t size)
00075 {
00076     <span class="keywordtype">char</span> *ptr;
00077     size_t sz;
00078 
00079     dbg_return_if (im == NULL, -1);
00080     dbg_return_if (buf == NULL, -1);
00081 
00082     sz = MIN(size, im-&gt;size - im-&gt;off);
00083     <span class="keywordflow">if</span>(sz)
00084     {
00085         ptr = im-&gt;buf + im-&gt;off; 
00086         memcpy(ptr, buf, sz);
00087         im-&gt;off += sz;
00088     }
00089 
00090     <span class="keywordflow">return</span> sz;
00091 }
00092 
00093 <span class="keyword">static</span> <span class="keywordtype">int</span> io_mem_close(io_mem_t *im)
00094 {
00095     <span class="keywordflow">return</span> 0;
00096 }
00097 
00098 <span class="keyword">static</span> <span class="keywordtype">int</span> io_mem_free(io_mem_t *im)
00099 {
00100     dbg_return_if (im == NULL, ~0);
00101 
00102     <span class="keywordflow">if</span>(im-&gt;flags &amp; IO_MEM_FREE_BUF)
00103     {
00104         U_FREE(im-&gt;buf);
00105         im-&gt;buf = NULL;
00106         im-&gt;size = im-&gt;off = 0;
00107     }
00108 
00109     <span class="keywordflow">return</span> 0;
00110 }
00111 
00112 size_t io_mem_get_bufsz(io_t *io)
00113 {
00114     io_mem_t *im = (io_mem_t*)io;
00115 
00116     dbg_err_if(io == NULL);
00117     dbg_err_if(im-&gt;io.type != IO_TYPE_MEM);
00118 
00119     <span class="keywordflow">return</span> im-&gt;size;
00120 err:
00121     <span class="keywordflow">return</span> 0;
00122 }
00123 
00124 <span class="keywordtype">char</span> *io_mem_get_buf(io_t *io)
00125 {
00126     io_mem_t *im = (io_mem_t*)io;
00127 
00128     dbg_err_if(io == NULL);
00129     dbg_err_if(im-&gt;io.type != IO_TYPE_MEM);
00130 
00131     <span class="keywordflow">return</span> im-&gt;buf;
00132 err:
00133     <span class="keywordflow">return</span> NULL;
00134 }
00135 
00136 <span class="keywordtype">int</span> io_mem_create(<span class="keywordtype">char</span> *buf, size_t size, <span class="keywordtype">int</span> flags, io_t **pio)
00137 {
00138     io_mem_t *im = NULL;
00139 
00140     dbg_err_if (buf == NULL);
00141     dbg_err_if (pio == NULL);
00142     
00143     dbg_err_if(io_create(io_mem_t, (io_t**)&amp;im));
00144 
00145     im-&gt;io.type = IO_TYPE_MEM;
00146 
00147     im-&gt;buf = buf;
00148     im-&gt;size = size;
00149     im-&gt;flags = flags;
00150     im-&gt;off = 0;
00151     im-&gt;io.read = (io_read_op) io_mem_read;
00152     im-&gt;io.write = (io_write_op) io_mem_write;
00153     im-&gt;io.seek = (io_seek_op) io_mem_seek;
00154     im-&gt;io.tell = (io_tell_op) io_mem_tell;
00155     im-&gt;io.close = (io_close_op) io_mem_close; 
00156     im-&gt;io.free = (io_free_op) io_mem_free; 
00157 
00158     *pio = (io_t*)im;
00159 
00160     <span class="keywordflow">return</span> 0;
00161 err:
00162     <span class="keywordflow">if</span>(im)
00163         <a class="code" href="group__basic.html#ga14">io_free</a>((io_t *)im);
00164     <span class="keywordflow">return</span> ~0;
00165 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


