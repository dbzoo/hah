<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: mkstemps.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>mkstemps.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 1987, 1993</span>
00003 <span class="comment"> *  The Regents of the University of California.  All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment"> * modification, are permitted provided that the following conditions</span>
00007 <span class="comment"> * are met:</span>
00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment"> * 3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment"> *    must display the following acknowledgement:</span>
00015 <span class="comment"> *  This product includes software developed by the University of</span>
00016 <span class="comment"> *  California, Berkeley and its contributors.</span>
00017 <span class="comment"> * 4. Neither the name of the University nor the names of its contributors</span>
00018 <span class="comment"> *    may be used to endorse or promote products derived from this software</span>
00019 <span class="comment"> *    without specific prior written permission.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment"> * SUCH DAMAGE.</span>
00032 <span class="comment"> */</span>
00033 
00034 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00037 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00038 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00039 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00040 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00041 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00042 <span class="preprocessor">#include &lt;string.h&gt;</span>
00043 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00044 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00045 
00046 <span class="preprocessor">#ifdef OS_WIN</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
00048 <span class="preprocessor">#define _mkdir(dir, perm) CreateDirectory(dir, NULL)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#define lstat(path, buf) stat(path, buf)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#define _mkdir(dir, perm) mkdir(dir, perm)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00053 <span class="preprocessor"></span>
00054 <span class="preprocessor">#ifndef HAVE_MKSTEMPS</span>
00055 <span class="preprocessor"></span>
00056 <span class="keyword">static</span> <span class="keywordtype">int</span> _gettemp(<span class="keywordtype">char</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
00057 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> __time_seed (<span class="keywordtype">void</span>);
00058 
00059 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> padchar[] =
00060     <span class="stringliteral">"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"</span>;
00061 
00062 <span class="keywordtype">int</span>
00063 mkstemps(path, slen)
00064     <span class="keywordtype">char</span> *path;
00065     <span class="keywordtype">int</span> slen;
00066 {
00067     <span class="keywordtype">int</span> fd;
00068 
00069     <span class="keywordflow">return</span> (_gettemp(path, &amp;fd, 0, slen) ? fd : -1);
00070 }
00071 
00072 <span class="keyword">static</span> <span class="keywordtype">int</span>
00073 _gettemp(path, doopen, domkdir, slen)
00074     <span class="keywordtype">char</span> *path;
00075     <span class="keywordtype">int</span> *doopen;
00076     <span class="keywordtype">int</span> domkdir;
00077     <span class="keywordtype">int</span> slen;
00078 {
00079     <span class="keywordtype">char</span> *start, *trv, *suffp;
00080     <span class="keywordtype">char</span> *pad;
00081     <span class="keyword">struct </span>stat sbuf;
00082     <span class="keywordtype">int</span> rval;
00083     <span class="keywordtype">int</span> __rand;
00084 
00085     srand(__time_seed());
00086 
00087     <span class="keywordflow">if</span> (doopen != NULL &amp;&amp; domkdir) {
00088         errno = EINVAL;
00089         <span class="keywordflow">return</span> (0);
00090     }
00091 
00092     <span class="keywordflow">for</span> (trv = path; *trv != <span class="charliteral">'\0'</span>; ++trv)
00093         ;
00094     trv -= slen;
00095     suffp = trv;
00096     --trv;
00097     <span class="keywordflow">if</span> (trv &lt; path) {
00098         errno = EINVAL;
00099         <span class="keywordflow">return</span> (0);
00100     }
00101 
00102     <span class="comment">/* Fill space with random characters */</span>
00103     <span class="keywordflow">while</span> (trv &gt;= path &amp;&amp; *trv == <span class="charliteral">'X'</span>) {
00104         __rand = rand() % (<span class="keyword">sizeof</span>(padchar) - 1);
00105         *trv-- = padchar[__rand];
00106     }
00107     start = trv + 1;
00108 
00109     <span class="comment">/*</span>
00110 <span class="comment">     * check the target directory.</span>
00111 <span class="comment">     */</span>
00112     <span class="keywordflow">if</span> (doopen != NULL || domkdir) {
00113         <span class="keywordflow">for</span> (; trv &gt; path; --trv) {
00114             <span class="keywordflow">if</span> (*trv == <span class="charliteral">'/'</span>) {
00115                 *trv = <span class="charliteral">'\0'</span>;
00116                 rval = stat(path, &amp;sbuf);
00117                 *trv = <span class="charliteral">'/'</span>;
00118                 <span class="keywordflow">if</span> (rval != 0)
00119                     <span class="keywordflow">return</span> (0);
00120                 <span class="keywordflow">if</span> (!S_ISDIR(sbuf.st_mode)) {
00121                     errno = ENOTDIR;
00122                     <span class="keywordflow">return</span> (0);
00123                 }
00124                 <span class="keywordflow">break</span>;
00125             }
00126         }
00127     }
00128 
00129     <span class="keywordflow">for</span> (;;) {
00130         <span class="keywordflow">if</span> (doopen) {
00131             <span class="keywordflow">if</span> ((*doopen =
00132                 open(path, O_CREAT|O_EXCL|O_RDWR, 0600)) &gt;= 0)
00133                 <span class="keywordflow">return</span> (1);
00134             <span class="keywordflow">if</span> (errno != EEXIST)
00135                 <span class="keywordflow">return</span> (0);
00136         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (domkdir) {
00137             <span class="keywordflow">if</span> (_mkdir(path, 0700) == 0)
00138                 <span class="keywordflow">return</span> (1);
00139             <span class="keywordflow">if</span> (errno != EEXIST)
00140                 <span class="keywordflow">return</span> (0);
00141         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lstat(path, &amp;sbuf))
00142             <span class="keywordflow">return</span> (errno == ENOENT);
00143 
00144         <span class="comment">/* If we have a collision, cycle through the space of filenames */</span>
00145         <span class="keywordflow">for</span> (trv = start;;) {
00146             <span class="keywordflow">if</span> (*trv == <span class="charliteral">'\0'</span> || trv == suffp)
00147                 <span class="keywordflow">return</span> (0);
00148             pad = strchr((<span class="keyword">const</span> <span class="keywordtype">char</span> *) padchar, *trv);
00149             <span class="keywordflow">if</span> (pad == NULL || *++pad == <span class="charliteral">'\0'</span>)
00150                 *trv++ = padchar[0];
00151             <span class="keywordflow">else</span> {
00152                 *trv++ = *pad;
00153                 <span class="keywordflow">break</span>;
00154             }
00155         }
00156     }
00157     <span class="comment">/*NOTREACHED*/</span>
00158 }
00159 
00160 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> __time_seed (<span class="keywordtype">void</span>)
00161 {
00162     time_t now;
00163     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;
00164     <span class="keywordtype">unsigned</span> seed = 0;
00165     size_t i;
00166 
00167     now = time(NULL);
00168     p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;now;
00169 
00170     <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span> now; i++)
00171         seed = seed * (UCHAR_MAX + 2U) + p[i];
00172 
00173     <span class="keywordflow">return</span> seed;
00174 }
00175 
00176 <span class="preprocessor">#else</span>
00177 <span class="preprocessor"></span><span class="keywordtype">int</span> mkstemps (<span class="keywordtype">char</span> *<span class="keyword">template</span>, <span class="keywordtype">int</span> suffixlen);
00178 <span class="preprocessor">#endif  </span><span class="comment">/* !HAVE_MKSTEMPS */</span>
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
