<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: array.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>array.c</h1><div class="fragment"><pre>00001 <span class="comment">/* </span>
00002 <span class="comment"> * Copyright (c) 2005-2008 by KoanLogic s.r.l. - All rights reserved.  </span>
00003 <span class="comment"> */</span>
00004 
00005 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
00006 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00007 <span class="preprocessor">#include &lt;toolbox/array.h&gt;</span>
00008 
00009 <span class="comment">/* for C89 implementations */</span>
00010 <span class="preprocessor">#ifndef SIZE_MAX</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#define SIZE_MAX ((size_t) -1)</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00013 <span class="preprocessor"></span>
00014 <span class="keyword">struct </span>u_array_s
00015 {
00016     size_t nslots;
00017     <a class="code" href="group__array.html#ga29">u_array_type_t</a> type;
00018     <span class="keywordtype">void</span> *base;
00019 };
00020 
00021 <span class="keyword">static</span> size_t sizeof_type[U_ARRAY_TYPE_MAX + 1] =
00022 {
00023     0,                              <span class="comment">/* U_ARRAY_TYPE_UNSET  = 0          */</span>
00024 <span class="preprocessor">#ifdef HAVE_BOOL</span>
00025 <span class="preprocessor"></span>    <span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>),                   <span class="comment">/* U_ARRAY_TYPE_BOOL                */</span>
00026 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_BOOL */</span>
00027     <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>),                   <span class="comment">/* U_ARRAY_TYPE_CHAR                */</span>
00028     <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>),          <span class="comment">/* U_ARRAY_TYPE_U_CHAR              */</span>
00029     <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>),                  <span class="comment">/* U_ARRAY_TYPE_SHORT               */</span>
00030     <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>),         <span class="comment">/* U_ARRAY_TYPE_U_SHORT             */</span>
00031     <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>),                    <span class="comment">/* U_ARRAY_TYPE_INT                 */</span>
00032     <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>),           <span class="comment">/* U_ARRAY_TYPE_U_INT               */</span>
00033     <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>),                   <span class="comment">/* U_ARRAY_TYPE_LONG                */</span>
00034     <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>),          <span class="comment">/* U_ARRAY_TYPE_U_LONG              */</span>
00035 <span class="preprocessor">#ifdef HAVE_LONG_LONG</span>
00036 <span class="preprocessor"></span>    <span class="keyword">sizeof</span>(<span class="keywordtype">long</span> <span class="keywordtype">long</span>),              <span class="comment">/* U_ARRAY_TYPE_LONG_LONG           */</span>
00037     <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>),     <span class="comment">/* U_ARRAY_TYPE_U_LONG_LONG         */</span>
00038 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_LONG_LONG */</span>
00039     <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>),                  <span class="comment">/* U_ARRAY_TYPE_FLOAT               */</span>
00040     <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>),                 <span class="comment">/* U_ARRAY_TYPE_DOUBLE              */</span>
00041 <span class="preprocessor">#ifdef HAVE_LONG_DOUBLE</span>
00042 <span class="preprocessor"></span>    <span class="keyword">sizeof</span>(<span class="keywordtype">long</span> <span class="keywordtype">double</span>),            <span class="comment">/* U_ARRAY_TYPE_LONG_DOUBLE         */</span>
00043 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_LONG_DOUBLE */</span>
00044 <span class="preprocessor">#ifdef HAVE_FLOAT_COMPLEX</span>
00045 <span class="preprocessor"></span>    <span class="keyword">sizeof</span>(<span class="keywordtype">float</span> complex),          <span class="comment">/* U_ARRAY_TYPE_FLOAT_COMPLEX       */</span>
00046 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_FLOAT_COMPLEX */</span>
00047 <span class="preprocessor">#ifdef HAVE_DOUBLE_COMPLEX</span>
00048 <span class="preprocessor"></span>    <span class="keyword">sizeof</span>(<span class="keywordtype">double</span> complex),         <span class="comment">/* U_ARRAY_TYPE_DOUBLE_COMPLEX      */</span>
00049 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_DOUBLE_COMPLEX */</span>
00050 <span class="preprocessor">#ifdef HAVE_LONG_DOUBLE_COMPLEX</span>
00051 <span class="preprocessor"></span>    <span class="keyword">sizeof</span>(<span class="keywordtype">long</span> <span class="keywordtype">double</span> complex),    <span class="comment">/* U_ARRAY_TYPE_LONG_DOUBLE_COMPLEX */</span>
00052 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_LONG_DOUBLE_COMPLEX */</span>
00053     <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *)                  <span class="comment">/* U_ARRAY_TYPE_PTR                 */</span>
00054 };
00055 
00056 <span class="preprocessor">#define MAX_NSLOTS(da)  (SIZE_MAX / sizeof_type[da-&gt;type])</span>
00057 <span class="preprocessor"></span>
<a name="l00083"></a><a class="code" href="group__array.html#ga1">00083</a> <span class="keywordtype">int</span> <a class="code" href="group__array.html#ga1">u_array_create</a> (u_array_type_t t, size_t nslots, u_array_t **pda)
00084 {
00085     u_array_t *da = NULL;
00086     size_t max_nslots;
00087 
00088     dbg_return_if (pda == NULL, -1);
00089     dbg_return_if (!U_ARRAY_TYPE_IS_VALID(t), -1);
00090 
00091     da = <a class="code" href="group__alloc.html#ga6">u_zalloc</a>(<span class="keyword">sizeof</span>(u_array_t));
00092     warn_err_sif (da == NULL);
00093 
00094     da-&gt;type = t;
00095 
00096     <span class="keywordflow">if</span> (nslots == 0)
00097         da-&gt;nslots = <a class="code" href="group__array.html#ga26">U_ARRAY_NSLOTS_DFL</a>;
00098     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nslots &gt; (max_nslots = MAX_NSLOTS(da)))
00099         da-&gt;nslots = max_nslots;
00100     <span class="keywordflow">else</span>
00101         da-&gt;nslots = nslots;
00102 
00103     da-&gt;base = <a class="code" href="group__alloc.html#ga6">u_zalloc</a>(da-&gt;nslots * sizeof_type[da-&gt;type]);
00104     warn_err_sif (da-&gt;base == NULL);
00105 
00106     *pda = da;
00107 
00108     <span class="keywordflow">return</span> 0;
00109 err:
00110     <a class="code" href="group__array.html#ga2">u_array_free</a>(da);
00111     <span class="keywordflow">return</span> -1;
00112 }
00113 
<a name="l00122"></a><a class="code" href="group__array.html#ga2">00122</a> <span class="keywordtype">void</span> <a class="code" href="group__array.html#ga2">u_array_free</a> (u_array_t *da)
00123 {
00124     nop_return_if (da == NULL, );
00125 
00126     U_FREE(da-&gt;base);
00127     <a class="code" href="group__alloc.html#ga8">u_free</a>(da);
00128 
00129     <span class="keywordflow">return</span>;
00130 }
00131 
<a name="l00140"></a><a class="code" href="group__array.html#ga3">00140</a> <span class="keywordtype">int</span> <a class="code" href="group__array.html#ga3">u_array_resize</a> (u_array_t *da, size_t idx)
00141 {
00142     <span class="keywordtype">void</span> *new_base;
00143     size_t new_nslots, max_nslots;
00144 
00145     dbg_return_if (da == NULL, -1);
00146 
00147     <span class="comment">/* no need to resize, go out */</span>
00148     dbg_return_if (idx &lt; da-&gt;nslots, 0);        
00149 
00150     <span class="comment">/* can't go further, go out */</span>
00151     dbg_return_if (idx &gt;= (max_nslots = MAX_NSLOTS(da)) - 1, 0);   
00152 
00153     <span class="comment">/* decide how many new slots are needed */</span>
00154     new_nslots = ((max_nslots - <a class="code" href="group__array.html#ga27">U_ARRAY_RESIZE_PAD</a> - 1) &gt;= idx) ?
00155         idx + <a class="code" href="group__array.html#ga27">U_ARRAY_RESIZE_PAD</a> + 1 : max_nslots;
00156  
00157     <span class="comment">/* try to realloc the array base pointer with the new size */</span>
00158     new_base = <a class="code" href="group__alloc.html#ga7">u_realloc</a>(da-&gt;base, new_nslots * sizeof_type[da-&gt;type]);
00159     warn_err_sif (new_base == NULL);
00160 
00161     da-&gt;base = new_base;
00162     da-&gt;nslots = new_nslots;
00163 
00164     <span class="keywordflow">return</span> 0;
00165 err:
00166     <span class="keywordflow">return</span> -1;
00167 }
00168 
00173 <span class="preprocessor">#define U_ARRAY_GETSET_F(pfx, dtype, ctype)    \</span>
00174 <span class="preprocessor">int u_array_set##pfx (u_array_t *da, size_t idx, ctype v, ctype *pold)      \</span>
00175 <span class="preprocessor">{                                                                           \</span>
00176 <span class="preprocessor">    ctype *ep;                                                              \</span>
00177 <span class="preprocessor">                                                                            \</span>
00178 <span class="preprocessor">    dbg_return_if (da == NULL, -1);                                         \</span>
00179 <span class="preprocessor">                                                                            \</span>
00180 <span class="preprocessor">    </span><span class="comment">/* be strict over what we're assigning */</span>                               \
00181     dbg_return_if (da-&gt;type != dtype, -1);                                  \
00182                                                                             \
00183     <span class="comment">/* silently handle resize in case an element is set past the            \</span>
00184 <span class="comment">     * actual index range */</span>                                                \
00185     if (idx &gt; da-&gt;nslots - 1)                                               \
00186         warn_err_if (u_array_resize(da, idx));                              \
00187                                                                             \
00188     <span class="comment">/* get the selected slot */</span>                                             \
00189     ep = (ctype *) da-&gt;base + idx;                                          \
00190                                                                             \
00191     <span class="comment">/* if requested copy-out the old value before overriding it */</span>          \
00192     if (pold)                                                               \
00193         *pold = *ep;                                                        \
00194                                                                             \
00195     <span class="comment">/* assign */</span>                                                            \
00196     *ep = v;                                                                \
00197                                                                             \
00198     return 0;                                                               \
00199 err:                                                                        \
00200     return -1;                                                              \
00201 }                                                                           \
00202                                                                             \
00203 int u_array_get##pfx (u_array_t *da, size_t idx, ctype *pv)                 \
00204 {                                                                           \
00205     ctype *ep;                                                              \
00206                                                                             \
00207     dbg_return_if (da == NULL, -1);                                         \
00208     dbg_return_if (pv == NULL, -1);                                         \
00209     <span class="comment">/* be strict over what we're returning */</span>                               \
00210     dbg_return_if (da-&gt;type != dtype, -1);                                  \
00211                                                                             \
00212     <span class="comment">/* check overflow */</span>                                                    \
00213     warn_err_if (idx &gt; da-&gt;nslots -1);                                      \
00214                                                                             \
00215     ep = (ctype *) da-&gt;base + idx;                                          \
00216                                                                             \
00217     *pv = *ep;                                                              \
00218                                                                             \
00219     return 0;                                                               \
00220 err:                                                                        \
00221     return -1;                                                              \
00222 }
00223 
00224 U_ARRAY_GETSET_F(_char, U_ARRAY_TYPE_CHAR, <span class="keywordtype">char</span>)
00225 U_ARRAY_GETSET_F(_u_char, U_ARRAY_TYPE_U_CHAR, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)
00226 U_ARRAY_GETSET_F(_short, U_ARRAY_TYPE_SHORT, <span class="keywordtype">short</span>)
00227 U_ARRAY_GETSET_F(_u_short, U_ARRAY_TYPE_U_SHORT, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)
00228 U_ARRAY_GETSET_F(_int, U_ARRAY_TYPE_INT, <span class="keywordtype">int</span>)
00229 U_ARRAY_GETSET_F(_u_int, U_ARRAY_TYPE_U_INT, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)
00230 U_ARRAY_GETSET_F(_long, U_ARRAY_TYPE_LONG, <span class="keywordtype">long</span>)
00231 U_ARRAY_GETSET_F(_u_long, U_ARRAY_TYPE_U_LONG, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)
00232 U_ARRAY_GETSET_F(_float, U_ARRAY_TYPE_FLOAT, <span class="keywordtype">float</span>)
00233 U_ARRAY_GETSET_F(_double, U_ARRAY_TYPE_DOUBLE, <span class="keywordtype">double</span>)
00234 U_ARRAY_GETSET_F(_ptr, U_ARRAY_TYPE_PTR, <span class="keywordtype">void</span> *)
00235 
00236 #ifdef HAVE_BOOL
00237 U_ARRAY_GETSET_F(_bool, U_ARRAY_TYPE_BOOL, <span class="keywordtype">bool</span>)
00238 #endif  <span class="comment">/* HAVE_BOOL */</span>
00239 
00240 <span class="preprocessor">#ifdef HAVE_LONG_LONG</span>
00241 <span class="preprocessor"></span>U_ARRAY_GETSET_F(_long_long, U_ARRAY_TYPE_LONG_LONG, <span class="keywordtype">long</span> <span class="keywordtype">long</span>)
00242 U_ARRAY_GETSET_F(_u_long_long, U_ARRAY_TYPE_U_LONG_LONG, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)
00243 #endif  <span class="comment">/* HAVE_LONG_LONG */</span>
00244 
00245 <span class="preprocessor">#ifdef HAVE_LONG_DOUBLE</span>
00246 <span class="preprocessor"></span>U_ARRAY_GETSET_F(_long_double, U_ARRAY_TYPE_LONG_DOUBLE, <span class="keywordtype">long</span> <span class="keywordtype">double</span>)
00247 #endif  <span class="comment">/* HAVE_LONG_DOUBLE */</span>
00248 
00249 <span class="preprocessor">#ifdef HAVE_FLOAT_COMPLEX</span>
00250 <span class="preprocessor"></span>U_ARRAY_GETSET_F(_float_complex, U_ARRAY_TYPE_FLOAT_COMPLEX, <span class="keywordtype">float</span> complex)
00251 #endif  <span class="comment">/* HAVE_FLOAT_COMPLEX */</span>
00252 
00253 <span class="preprocessor">#ifdef HAVE_DOUBLE_COMPLEX</span>
00254 <span class="preprocessor"></span>U_ARRAY_GETSET_F(_double_complex, U_ARRAY_TYPE_DOUBLE_COMPLEX, <span class="keywordtype">double</span> complex)
00255 #endif  <span class="comment">/* HAVE_DOUBLE_COMPLEX */</span>
00256 
00257 <span class="preprocessor">#ifdef HAVE_LONG_DOUBLE_COMPLEX</span>
00258 <span class="preprocessor"></span>U_ARRAY_GETSET_F(_long_double_complex, U_ARRAY_TYPE_LONG_DOUBLE_COMPLEX, <span class="keywordtype">long</span> <span class="keywordtype">double</span> complex)
00259 #endif  <span class="comment">/* HAVE_LONG_DOUBLE_COMPLEX */</span>
00260 
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
