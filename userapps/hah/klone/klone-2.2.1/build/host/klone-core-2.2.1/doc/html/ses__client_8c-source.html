<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: ses_client.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>ses_client.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: ses_client.c,v 1.30 2007/08/20 16:06:08 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00013 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00014 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00015 <span class="preprocessor">#include &lt;time.h&gt;</span>
00016 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00017 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00018 <span class="preprocessor">#include &lt;openssl/hmac.h&gt;</span>
00019 <span class="preprocessor">#include &lt;openssl/evp.h&gt;</span>
00020 <span class="preprocessor">#include &lt;openssl/rand.h&gt;</span>
00021 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00022 <span class="preprocessor">#include &lt;klone/session.h&gt;</span>
00023 <span class="preprocessor">#include &lt;klone/request.h&gt;</span>
00024 <span class="preprocessor">#include &lt;<a class="code" href="response_8h.html">klone/response.h</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;klone/vars.h&gt;</span>
00026 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00027 <span class="preprocessor">#include &lt;klone/emb.h&gt;</span>
00028 <span class="preprocessor">#include &lt;klone/ses_prv.h&gt;</span>
00029 <span class="preprocessor">#include &lt;klone/codecs.h&gt;</span>
00030 
00031 <span class="preprocessor">#define KL1_CLISES_DATA     "KL1_CLISES_DATA"</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#define KL1_CLISES_MTIME    "KL1_CLISES_MTIME"</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#define KL1_CLISES_HMAC     "KL1_CLISES_HMAC"</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#define KL1_CLISES_IV       "KL1_CLISES_IV"</span>
00035 <span class="preprocessor"></span>
00036 <span class="keyword">enum</span> { HMAC_HEX_SIZE = 2*EVP_MAX_MD_SIZE + 1 };
00037 
00038 <span class="comment">/* calc the hmac of data+sid+mtime */</span>
00039 <span class="keyword">static</span> <span class="keywordtype">int</span> session_client_hmac(HMAC_CTX *ctx, <span class="keywordtype">char</span> *hmac, size_t hmac_sz, 
00040     <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *sid, <span class="keyword">const</span> <span class="keywordtype">char</span> *mtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *hex_iv)
00041 {
00042     <span class="keywordtype">char</span> mac[EVP_MAX_MD_SIZE];
00043     <span class="keywordtype">int</span> mac_len;
00044 
00045     dbg_err_if (ctx == NULL);
00046     dbg_err_if (hmac == NULL);
00047     dbg_err_if (data == NULL);
00048     dbg_err_if (sid == NULL);
00049     dbg_err_if (mtime == NULL);
00050     <span class="comment">/* hex_iv may be NULL */</span>
00051     
00052     <span class="comment">/* hmac must be at least 'EVP_MAX_MD_SIZE*2 + 1' (it will be hex encoded) */</span>
00053     dbg_err_if(hmac_sz &lt; EVP_MAX_MD_SIZE*2 + 1);
00054 
00055     <span class="comment">/* calc HMAC hash of the data buf + mtime (reuse stored key and md) */</span>
00056     HMAC_Init_ex(ctx, NULL, 0, NULL, NULL); 
00057     HMAC_Update(ctx, data, strlen(data));
00058     HMAC_Update(ctx, sid, strlen(sid));
00059     HMAC_Update(ctx, mtime, strlen(mtime));
00060     <span class="keywordflow">if</span>(hex_iv)
00061         HMAC_Update(ctx, hex_iv, strlen(hex_iv));
00062     HMAC_Final(ctx, mac, &amp;mac_len);
00063 
00064     <span class="comment">/* encode the hash */</span>
00065     dbg_err_if(<a class="code" href="group__ut.html#ga31">u_hexncpy</a>(hmac, mac, mac_len, HEXCPY_ENCODE) &lt;= 0);
00066 
00067     <span class="keywordflow">return</span> 0;
00068 err:
00069     <span class="keywordflow">return</span> -1;
00070 }
00071 
00072 <span class="keyword">static</span> <span class="keywordtype">int</span> session_client_save(session_t *ss)
00073 {
00074     <span class="comment">/* BUF_SIZE: cookie size + MAC size + gzip header + encryption padding  */</span>
00075     <span class="keyword">enum</span> { 
00076         MTIME_SIZE = 32, 
00077         BUF_SIZE = COOKIE_MAX_SIZE + EVP_MAX_BLOCK_LENGTH + 96 
00078     };
00079     session_opt_t *so = ss-&gt;so;
00080     <span class="keywordtype">char</span> hmac[HMAC_HEX_SIZE], ebuf[BUF_SIZE], mtime[MTIME_SIZE];
00081     <span class="keywordtype">char</span> *buf = NULL, cipher_iv_hex[CIPHER_IV_SIZE * 2 + 1];
00082     size_t sz;
00083 
00084     dbg_err_if (ss == NULL);
00085 
00086 <span class="preprocessor">    #ifdef HAVE_LIBOPENSSL</span>
00087 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(ss-&gt;so-&gt;encrypt)
00088     {
00089         <span class="comment">/* generate a new IV for each session */</span>
00090         dbg_err_if(!RAND_pseudo_bytes(ss-&gt;so-&gt;cipher_iv, CIPHER_IV_SIZE));
00091 
00092         <span class="comment">/* hex encode the IV and save it in a cookie */</span>
00093         dbg_err_if(<a class="code" href="group__ut.html#ga31">u_hexncpy</a>(cipher_iv_hex, ss-&gt;so-&gt;cipher_iv, CIPHER_IV_SIZE,
00094             HEXCPY_ENCODE) &lt;= 0);
00095         dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_IV, cipher_iv_hex, 
00096             0, NULL, NULL, 0));
00097     }
00098 <span class="preprocessor">    #endif</span>
00099 <span class="preprocessor"></span>
00100     <span class="comment">/* save the session data to freshly alloc'd buf of size sz */</span>
00101     dbg_err_if(session_prv_save_to_buf(ss, &amp;buf, &amp;sz));
00102 
00103     warn_err_ifm(sz &gt; COOKIE_MAX_SIZE, 
00104                 <span class="stringliteral">"session data too big for client-side sessions"</span>);
00105 
00106     <span class="comment">/* hex-encode the buffer */</span>
00107     dbg_err_if(<a class="code" href="group__ut.html#ga31">u_hexncpy</a>(ebuf, buf, sz, HEXCPY_ENCODE) &lt;= 0);
00108 
00109     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_DATA, ebuf, 0, NULL, 
00110         NULL, 0));
00111 
00112     <span class="comment">/* set mtime cookie */</span>
00113     ss-&gt;mtime = time(0);
00114     dbg_err_if(u_snprintf(mtime, MTIME_SIZE, <span class="stringliteral">"%lu"</span>, ss-&gt;mtime));
00115     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_MTIME, mtime, 0, NULL, 
00116         NULL, 0));
00117 
00118     <span class="comment">/* calc the HMAC */</span>
00119     dbg_err_if(session_client_hmac(&amp;so-&gt;hmac_ctx, hmac, HMAC_HEX_SIZE, 
00120         ebuf, ss-&gt;id, mtime, ss-&gt;so-&gt;encrypt ? cipher_iv_hex : NULL));
00121 
00122     <span class="comment">/* store the hash in a cookie */</span>
00123     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_HMAC, hmac, 0, NULL, 
00124         NULL, 0));
00125 
00126     <span class="keywordflow">return</span> 0;
00127 err:
00128     <span class="keywordflow">return</span> ~0;
00129 }
00130 
00131 <span class="keyword">static</span> <span class="keywordtype">int</span> session_client_load(session_t *ss)
00132 {
00133     session_opt_t *so = ss-&gt;so;
00134     <span class="keywordtype">char</span> hmac[HMAC_HEX_SIZE], buf[COOKIE_MAX_SIZE];
00135     <span class="keyword">const</span> <span class="keywordtype">char</span> *cli_ebuf, *cli_hmac, *cli_mtime, *cli_iv;
00136     ssize_t c;
00137 
00138     dbg_err_if (ss == NULL);
00139 
00140     <span class="comment">/* extract session data, mtime and hmac from cookies */</span>
00141     cli_ebuf = <a class="code" href="group__request.html#ga49">request_get_cookie</a>(ss-&gt;rq, KL1_CLISES_DATA);
00142     cli_mtime = <a class="code" href="group__request.html#ga49">request_get_cookie</a>(ss-&gt;rq, KL1_CLISES_MTIME);
00143     cli_hmac = <a class="code" href="group__request.html#ga49">request_get_cookie</a>(ss-&gt;rq, KL1_CLISES_HMAC);
00144     cli_iv = <a class="code" href="group__request.html#ga49">request_get_cookie</a>(ss-&gt;rq, KL1_CLISES_IV);
00145 
00146     nop_err_if(cli_ebuf == NULL || cli_mtime == NULL || cli_hmac == NULL);
00147     <span class="comment">/* cli_iv may be NULL */</span>
00148 
00149     <span class="comment">/* calc the HMAC */</span>
00150     dbg_err_if(session_client_hmac(&amp;so-&gt;hmac_ctx, hmac, HMAC_HEX_SIZE, 
00151         cli_ebuf, ss-&gt;id, cli_mtime, ss-&gt;so-&gt;encrypt ? cli_iv : NULL));
00152 
00153     <span class="comment">/* compare HMACs */</span>
00154     <span class="keywordflow">if</span>(strcmp(hmac, cli_hmac))
00155     {
00156         session_remove(ss); <span class="comment">/* remove all bad stale data */</span>
00157         warn_err(<span class="stringliteral">"HMAC don't match, rejecting session data"</span>);
00158     }
00159 
00160     <span class="comment">/* hash ckeched. decode/uncompress/decrypt session data */</span>
00161 
00162     <span class="comment">/* hex decode and save current cipher IV */</span>
00163     dbg_err_if((c = <a class="code" href="group__ut.html#ga31">u_hexncpy</a>(ss-&gt;so-&gt;cipher_iv, cli_iv, strlen(cli_iv), 
00164         HEXCPY_DECODE)) &lt;= 0);
00165 
00166     <span class="comment">/* set client provided mtime */</span>
00167     ss-&gt;mtime = strtoul(cli_mtime, NULL, 0);
00168 
00169     dbg_err_if(strlen(cli_ebuf) &gt; COOKIE_MAX_SIZE);
00170 
00171     <span class="comment">/* hex decode session data */</span>
00172     dbg_err_if((c = <a class="code" href="group__ut.html#ga31">u_hexncpy</a>(buf, cli_ebuf, strlen(cli_ebuf), 
00173         HEXCPY_DECODE)) &lt;= 0);
00174 
00175     <span class="comment">/* load session data from the buffer */</span>
00176     dbg_err_if(session_prv_load_from_buf(ss, buf, c));
00177 
00178     <span class="keywordflow">return</span> 0;
00179 err:
00180     <span class="keywordflow">return</span> ~0;
00181 }
00182 
00183 <span class="keyword">static</span> <span class="keywordtype">int</span> session_client_term(session_t *ss)
00184 {
00185     u_unused_args(ss);
00186     <span class="keywordflow">return</span> 0;
00187 }
00188 
00189 <span class="keyword">static</span> <span class="keywordtype">int</span> session_client_remove(session_t *ss)
00190 {
00191     dbg_err_if (ss == NULL);
00192     
00193     <span class="comment">/* removes all clises-related cookies */</span>
00194     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_DATA, NULL, 0, NULL, 
00195         NULL, 0));
00196     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_MTIME, NULL, 0, NULL, 
00197         NULL, 0));
00198     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_HMAC, NULL, 0, NULL, 
00199         NULL, 0));
00200     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, KL1_CLISES_IV, NULL, 0, NULL, 
00201         NULL, 0));
00202 
00203     <span class="keywordflow">return</span> 0;
00204 err:
00205     <span class="keywordflow">return</span> ~0;
00206 }
00207 
00208 <span class="keywordtype">int</span> session_client_create(session_opt_t *so, request_t *rq, response_t *rs, 
00209         session_t **pss)
00210 {
00211     session_t *ss = NULL;
00212 
00213     dbg_err_if (rq == NULL);
00214     dbg_err_if (rs == NULL);
00215     dbg_err_if (pss == NULL);
00216     dbg_err_if (so == NULL);
00217 
00218     ss = u_zalloc(<span class="keyword">sizeof</span>(session_t));
00219     dbg_err_if(ss == NULL);
00220 
00221     ss-&gt;load = session_client_load;
00222     ss-&gt;save = session_client_save;
00223     ss-&gt;remove = session_client_remove;
00224     ss-&gt;term = session_client_term;
00225     ss-&gt;mtime = time(0);
00226     ss-&gt;so = so;
00227 
00228     dbg_err_if(session_prv_init(ss, rq, rs));
00229 
00230     *pss = ss;
00231 
00232     <span class="keywordflow">return</span> 0;
00233 err:
00234     <span class="keywordflow">if</span>(ss)
00235         session_free(ss);
00236     <span class="keywordflow">return</span> ~0;
00237 }
00238 
00239 <span class="comment">/* this function will be called once by the server during startup */</span>
00240 <span class="keywordtype">int</span> session_client_module_init(u_config_t *config, session_opt_t *so)
00241 {
00242     u_config_t *c;
00243     <span class="keyword">const</span> <span class="keywordtype">char</span> *v;
00244 
00245     <span class="comment">/* config may be NULL */</span>
00246     dbg_err_if (so == NULL);
00247     
00248     <span class="comment">/* default */</span>
00249     so-&gt;hash = EVP_sha1(); 
00250 
00251     <span class="comment">/* always enable encryption for client-side sessions */</span>
00252     <span class="keywordflow">if</span>(!so-&gt;encrypt)
00253         warn(<span class="stringliteral">"encryption is required for client side session"</span>);
00254     so-&gt;encrypt = 1;
00255 
00256     <span class="keywordflow">if</span>(config &amp;&amp; !u_config_get_subkey(config, <span class="stringliteral">"client"</span>, &amp;c))
00257     {
00258         <span class="keywordflow">if</span>((v = u_config_get_subkey_value(c, <span class="stringliteral">"hash_function"</span>)) != NULL)
00259         {
00260             <span class="keywordflow">if</span>(!strcasecmp(v, <span class="stringliteral">"md5"</span>))
00261                 so-&gt;hash = EVP_md5();
00262             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v, <span class="stringliteral">"sha1"</span>))
00263                 so-&gt;hash = EVP_sha1();
00264             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v, <span class="stringliteral">"ripemd160"</span>))
00265                 so-&gt;hash = EVP_ripemd160();
00266             <span class="keywordflow">else</span>
00267                 warn_err(<span class="stringliteral">"config error: bad hash_function"</span>);
00268         } 
00269     }
00270 
00271     <span class="comment">/* initialize OpenSSL HMAC stuff */</span>
00272     HMAC_CTX_init(&amp;so-&gt;hmac_ctx);
00273 
00274     <span class="comment">/* gen HMAC key */</span>
00275     dbg_err_if(!RAND_bytes(so-&gt;hmac_key, HMAC_KEY_SIZE));
00276 
00277     <span class="comment">/* init HMAC with our key and chose hash algorithm */</span>
00278     HMAC_Init_ex(&amp;so-&gt;hmac_ctx, so-&gt;hmac_key, HMAC_KEY_SIZE, so-&gt;hash, NULL);
00279 
00280     <span class="keywordflow">return</span> 0;
00281 err:
00282     <span class="keywordflow">return</span> ~0;
00283 }
00284 
00285 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


