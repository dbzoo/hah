<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: sup_kilt.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>sup_kilt.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: sup_kilt.c,v 1.1 2008/10/27 21:28:04 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00013 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00016 <span class="preprocessor">#include &lt;regex.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/supplier.h&gt;</span>
00018 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00019 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00020 <span class="preprocessor">#include &lt;klone/request.h&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="response_8h.html">klone/response.h</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;klone/session.h&gt;</span>
00023 <span class="preprocessor">#include &lt;klone/kilt.h&gt;</span>
00024 <span class="preprocessor">#include &lt;klone/kilt_urls.h&gt;</span>
00025 <span class="preprocessor">#include &lt;klone/emb.h&gt;</span>
00026 
00027 <span class="keyword">typedef</span> <span class="keyword">struct </span>url_to_ku_s
00028 {
00029     regex_t re;
00030     kilt_url_t *ku;
00031 } url_to_ku_t;
00032 
00033 <span class="keyword">static</span> url_to_ku_t *url_to_ku = NULL;
00034 
00035 <span class="keywordtype">void</span> kilt_run_script(dypage_args_t *args) 
00036 { 
00037     embpage_t *e;
00038     <span class="keyword">const</span> <span class="keywordtype">char</span> *script;
00039 
00040     script = dypage_get_param(args, <span class="stringliteral">"script"</span>);
00041     crit_err_ifm(script == NULL, <span class="stringliteral">"missing 'script' param"</span>);
00042 
00043     crit_err_ifm(emb_lookup(script, (embres_t**)&amp;e), 
00044             <span class="stringliteral">"script %s not found"</span>, script);
00045 
00046     args-&gt;fun = e-&gt;fun;
00047 
00048     <span class="comment">/* run the page code */</span>
00049     e-&gt;fun(args);
00050 
00051     <span class="keywordflow">return</span>; 
00052 err:
00053     <a class="code" href="group__response.html#ga6">response_set_status</a>(args-&gt;rs, HTTP_STATUS_NOT_FOUND); 
00054     <span class="keywordflow">return</span>;
00055 }
00056 
00057 <span class="keywordtype">void</span> kilt_show_params(dypage_args_t *args) 
00058 { 
00059     io_t *out = <a class="code" href="group__response.html#ga16">response_io</a>(args-&gt;rs);
00060     <span class="keywordtype">int</span> i;
00061 
00062     <a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"argc: %u&lt;br&gt;"</span>, args-&gt;argc);
00063     <span class="keywordflow">for</span>(i = 0; i &lt; args-&gt;argc; ++i)
00064         <a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"argv[%d]: %s&lt;br&gt;"</span>, i, args-&gt;argv[i]);
00065 
00066     <a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"&lt;p&gt;"</span>);
00067 
00068     <a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"nparams: %u&lt;br&gt;"</span>, args-&gt;nparams);
00069     <span class="keywordflow">for</span>(i = 0; i &lt; args-&gt;nparams; ++i)
00070         <a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"param['%s']: %s&lt;br&gt;"</span>, args-&gt;params[i].key, 
00071                 args-&gt;params[i].val);
00072 
00073     <span class="keywordflow">return</span>; 
00074 }
00075 
00076 <span class="keyword">static</span> <span class="keywordtype">int</span> kilt_is_valid_uri(http_t *h, request_t *rq, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri, 
00077         size_t len, <span class="keywordtype">void</span> **handle, time_t *mtime)
00078 {
00079     url_to_ku_t *utk;
00080     <span class="keywordtype">char</span> url[U_FILENAME_MAX];
00081     <span class="keywordtype">int</span> i;
00082 
00083     u_unused_args(h, rq);
00084 
00085     dbg_return_if (uri == NULL, 0);
00086     dbg_return_if (mtime == NULL, 0);
00087     dbg_return_if (len &gt;= U_FILENAME_MAX, 0);
00088     dbg_return_if (url_to_ku == NULL, 0);
00089 
00090     memcpy(url, uri, len);
00091     url[len] = 0;
00092 
00093     <span class="keywordflow">for</span>(i = 0; i &lt; kilt_nurls; ++i)
00094     {
00095         utk = &amp;url_to_ku[i];
00096 
00097         <span class="keywordflow">if</span>(regexec(&amp;utk-&gt;re, url, 0, NULL, 0) == 0)
00098         {
00099             *handle = (<span class="keywordtype">void</span>*)utk;
00100             *mtime = 0;
00101             <span class="keywordflow">return</span> 1; <span class="comment">/* found */</span>
00102         }
00103     }
00104 
00105     <span class="keywordflow">return</span> 0; 
00106 }
00107 
00108 <span class="keyword">static</span> <span class="keywordtype">int</span> kilt_serve(request_t *rq, response_t *rs)
00109 {
00110     url_to_ku_t *utk;
00111     dypage_args_t args;
00112     regmatch_t subs[DYPAGE_MAX_PARAMS + 1];
00113     <span class="keyword">const</span> <span class="keywordtype">char</span> *file_name;
00114     <span class="keywordtype">char</span> *argv[DYPAGE_MAX_PARAMS + 1];
00115     <span class="keywordtype">int</span> i, argc;
00116     <span class="keywordtype">void</span> *handle;
00117 
00118     <span class="comment">/* get cached utk pointer (avoid running all regex's on this url again) */</span>
00119     request_get_sup_info(rq, NULL, &amp;handle, NULL);
00120     dbg_err_if(handle == NULL);
00121 
00122     utk = handle;
00123 
00124     file_name = <a class="code" href="group__request.html#ga17">request_get_filename</a>(rq);
00125     dbg_err_if(file_name == NULL);
00126 
00127     dbg_err_if(regexec(&amp;utk-&gt;re, file_name, DYPAGE_MAX_PARAMS, subs, 0));
00128 
00129     <span class="keywordflow">for</span>(i = 0, argc = 0; subs[i].rm_so != subs[i].rm_eo; ++i, ++argc)
00130     {
00131         argv[i] = u_strndup(file_name + subs[i].rm_so, 
00132                         subs[i].rm_eo - subs[i].rm_so);
00133         dbg_err_if(argv[i] == NULL);
00134     }
00135 
00136     <span class="comment">/* set dypage args first */</span>
00137     args.rq = rq;
00138     args.rs = rs;
00139     args.ss = NULL; <span class="comment">/* set by dypage_serve */</span>
00140     args.fun = utk-&gt;ku-&gt;fun;
00141     args.opaque = NULL;
00142 
00143     <span class="comment">/* kilt args */</span>
00144 
00145     <span class="comment">/* regex submatches */</span>
00146     args.argc = argc;
00147     args.argv = argv;
00148 
00149     <span class="comment">/* user provided named arguments */</span>
00150     args.params = utk-&gt;ku-&gt;params;
00151     <span class="keywordflow">for</span>(args.nparams  = 0; args.params[args.nparams].key; ++args.nparams)
00152         <span class="keywordflow">continue</span>;
00153 
00154     <span class="comment">/* run the function! */</span>
00155     dypage_serve((dypage_args_t*)&amp;args);
00156 
00157     <span class="keywordflow">for</span>(i = 0; i &lt; argc; ++i)
00158         u_free(argv[i]);
00159 
00160     <span class="keywordflow">return</span> 0;
00161 err:
00162     <span class="keywordflow">return</span> ~0;
00163 }
00164 
00165 <span class="keyword">static</span> <span class="keywordtype">int</span> kilt_init(<span class="keywordtype">void</span>)
00166 {
00167     kilt_url_t *u;
00168     url_to_ku_t *utk;
00169     <span class="keywordtype">int</span> i;
00170 
00171     url_to_ku = u_zalloc( (kilt_nurls + 1) * <span class="keyword">sizeof</span>(url_to_ku_t));
00172     dbg_err_if(url_to_ku == NULL);
00173 
00174     <span class="keywordflow">for</span>(u = kilt_urls, i = 0; i &lt; kilt_nurls; ++u, ++i)
00175     {
00176         utk = &amp;url_to_ku[i];
00177 
00178         <span class="comment">/* save the compiled regex in utk.re */</span>
00179         dbg_err_if(regcomp(&amp;utk-&gt;re, u-&gt;pattern, REG_EXTENDED));
00180 
00181         <span class="comment">/* save the ptr to the kilt_url object */</span>
00182         utk-&gt;ku = u;
00183 
00184         dbg_err_if(utk-&gt;re.re_nsub &gt; DYPAGE_MAX_PARAMS);
00185     }
00186 
00187     <span class="keywordflow">return</span> 0;
00188 err:
00189     <span class="keywordflow">return</span> ~0;
00190 }
00191 
00192 <span class="keyword">static</span> <span class="keywordtype">void</span> kilt_term(<span class="keywordtype">void</span>)
00193 {
00194     url_to_ku_t *utk;
00195     <span class="keywordtype">int</span> i;
00196 
00197     <span class="keywordflow">if</span>(url_to_ku)
00198     {
00199         <span class="keywordflow">for</span>(i = 0; i &lt; kilt_nurls; ++i)
00200         {
00201             utk = &amp;url_to_ku[i];
00202             regfree(&amp;utk-&gt;re);
00203         }
00204         u_free(url_to_ku); url_to_ku = NULL;
00205     }
00206 
00207     <span class="keywordflow">return</span>;
00208 }
00209 
00210 supplier_t sup_kilt = {
00211     <span class="stringliteral">"kilt supplier"</span>,
00212     kilt_init,
00213     kilt_term,
00214     kilt_is_valid_uri,
00215     kilt_serve
00216 };
00217 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


