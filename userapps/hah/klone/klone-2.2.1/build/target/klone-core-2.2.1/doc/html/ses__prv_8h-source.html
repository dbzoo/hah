<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: ses_prv.h Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>ses_prv.h</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: ses_prv.h,v 1.19 2009/05/31 18:50:27 tho Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#ifndef _KLONE_SESPRV_H_</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define _KLONE_SESPRV_H_</span>
00013 <span class="preprocessor"></span>
00014 <span class="preprocessor">#include "klone_conf.h"</span>
00015 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#include &lt;openssl/hmac.h&gt;</span>
00017 <span class="preprocessor">#include &lt;openssl/evp.h&gt;</span>
00018 <span class="preprocessor">#include &lt;openssl/rand.h&gt;</span>
00019 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_LIBOPENSSL */</span>
00020 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00021 <span class="preprocessor">#include &lt;klone/session.h&gt;</span>
00022 <span class="preprocessor">#include &lt;klone/request.h&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="response_8h.html">klone/response.h</a>&gt;</span>
00024 <span class="preprocessor">#include &lt;klone/vars.h&gt;</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="http_8h.html">klone/http.h</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;klone/atom.h&gt;</span>
00027 <span class="preprocessor">#include &lt;klone/md5.h&gt;</span>
00028 
00029 <span class="preprocessor">#ifdef __cplusplus</span>
00030 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 <span class="keyword">typedef</span> int (*session_load_t)(session_t*);
00034 <span class="keyword">typedef</span> int (*session_save_t)(session_t*);
00035 <span class="keyword">typedef</span> int (*session_remove_t)(session_t*);
00036 <span class="keyword">typedef</span> int (*session_term_t)(session_t*);
00037 
00038 <span class="comment">/* session type */</span>
00039 <span class="keyword">enum</span> { 
00040     SESSION_TYPE_UNKNOWN, 
00041     SESSION_TYPE_FILE, 
00042     SESSION_TYPE_MEMORY, 
00043     SESSION_TYPE_CLIENT
00044 };
00045 
00046 <span class="keyword">enum</span> { 
00047     SESSION_ID_LENGTH = MD5_DIGEST_LEN,         <span class="comment">/* sid length       */</span>
00048     SESSION_ID_BUFSZ = 1 + SESSION_ID_LENGTH    <span class="comment">/* sid buffer size  */</span>
00049 };
00050 
00051 <span class="comment">/* hmac and cipher key size */</span>
00052 <span class="keyword">enum</span> { 
00053     HMAC_KEY_SIZE = 64, 
00054 <span class="preprocessor">    #ifdef HAVE_LIBOPENSSL</span>
00055 <span class="preprocessor"></span>    CIPHER_KEY_SIZE = EVP_MAX_KEY_LENGTH, 
00056     CIPHER_IV_SIZE = EVP_MAX_IV_LENGTH
00057 <span class="preprocessor">    #else</span>
00058 <span class="preprocessor"></span>    CIPHER_KEY_SIZE = 64, CIPHER_IV_SIZE = 64
00059 <span class="preprocessor">    #endif</span>
00060 <span class="preprocessor"></span> };
00061 
00062 <span class="comment">/* session runtime parameters */</span>
00063 <span class="keyword">typedef</span> <span class="keyword">struct </span>session_opt_s
00064 {
00065     <span class="comment">/* common session options */</span>
00066     <span class="keywordtype">int</span> type;       <span class="comment">/* type of sessions (file, memory, client-side)  */</span>
00067     <span class="keywordtype">int</span> max_age;    <span class="comment">/* max allowed age of sessions                   */</span>
00068     <span class="keywordtype">int</span> encrypt;    <span class="comment">/* &gt;0 when client-side session encryption is on  */</span>
00069     <span class="keywordtype">int</span> compress;   <span class="comment">/* &gt;0 when client-side session compression is on */</span>
00070     <span class="keywordtype">char</span> name[128]; <span class="comment">/* cookie name                                   */</span>
00071 <span class="preprocessor">    #ifdef HAVE_LIBOPENSSL</span>
00072 <span class="preprocessor"></span>    <span class="keyword">const</span> EVP_CIPHER *cipher; <span class="comment">/* encryption cipher algorithm         */</span>
00073     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cipher_key[CIPHER_KEY_SIZE]; <span class="comment">/* cipher secret key  */</span>
00074     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cipher_iv[CIPHER_IV_SIZE];   <span class="comment">/* cipher Init Vector */</span>
00075 <span class="preprocessor">    #endif</span>
00076 <span class="preprocessor"></span>
00077     <span class="comment">/* file session options/struct                                   */</span>
00078     <span class="keywordtype">char</span> path[U_FILENAME_MAX]; <span class="comment">/* session save path                  */</span>
00079     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> session_key[CIPHER_KEY_SIZE]; <span class="comment">/* session secret key*/</span>
00080     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> session_iv[CIPHER_IV_SIZE];   <span class="comment">/* session init vect */</span>
00081 
00082     <span class="comment">/* in-memory session options/struct                              */</span>
00083     atoms_t *atoms; <span class="comment">/* atom list used to store in-memory sessions    */</span>
00084     size_t max_count;   <span class="comment">/* max # of in-memory sessions               */</span>
00085     size_t mem_limit;   <span class="comment">/* max (total) size of in-memory sessions    */</span>
00086 
00087     <span class="comment">/* client-side options/structs                                   */</span>
00088 <span class="preprocessor">    #ifdef HAVE_LIBOPENSSL</span>
00089 <span class="preprocessor"></span>    HMAC_CTX hmac_ctx;  <span class="comment">/* openssl HMAC context                      */</span>
00090     <span class="keyword">const</span> EVP_MD *hash; <span class="comment">/* client-side session HMAC hash algorithm   */</span>
00091     <span class="keywordtype">char</span> hmac_key[HMAC_KEY_SIZE]; <span class="comment">/* session HMAC secret key         */</span>
00092 <span class="preprocessor">    #endif</span>
00093 <span class="preprocessor"></span>} session_opt_t;
00094 
00095 <span class="keyword">struct </span>session_s
00096 {
00097     vars_t *vars;               <span class="comment">/* variable list                              */</span>
00098     request_t *rq;              <span class="comment">/* request bound to this session              */</span>
00099     response_t *rs;             <span class="comment">/* response bound to this session             */</span>
00100     <span class="keywordtype">char</span> filename[U_FILENAME_MAX];<span class="comment">/* session filename                         */</span>
00101     <span class="keywordtype">char</span> <span class="keywordtype">id</span>[SESSION_ID_BUFSZ];  <span class="comment">/* session ID                                 */</span>
00102     <span class="keywordtype">int</span> removed;                <span class="comment">/* &gt;0 if the calling session has been deleted */</span>
00103     <span class="keywordtype">int</span> mtime;                  <span class="comment">/* last modified time                         */</span>
00104     session_load_t load;        <span class="comment">/* ptr to the driver load function            */</span>
00105     session_save_t save;        <span class="comment">/* ptr to the driver save function            */</span>
00106     session_remove_t remove;    <span class="comment">/* ptr to the driver remove function          */</span>
00107     session_term_t term;        <span class="comment">/* ptr to the driver term function            */</span>
00108     session_opt_t *so;          <span class="comment">/* runtime option                             */</span>
00109 };
00110 
00111 <span class="comment">/* main c'tor */</span>
00112 <span class="keywordtype">int</span> session_create(session_opt_t*, request_t*, response_t*, session_t**);
00113 
00114 <span class="comment">/* driver c'tor */</span>
00115 <span class="keywordtype">int</span> session_client_create(session_opt_t*, request_t*, response_t*, session_t**);
00116 <span class="keywordtype">int</span> session_file_create(session_opt_t*, request_t*, response_t*, session_t**);
00117 <span class="keywordtype">int</span> session_mem_create(session_opt_t*, request_t*, response_t*, session_t**);
00118 
00119 <span class="comment">/* private functions */</span>
00120 <span class="keywordtype">int</span> session_prv_init(session_t *, request_t *, response_t *);
00121 <span class="keywordtype">int</span> session_prv_load_from_io(session_t *, io_t *);
00122 <span class="keywordtype">int</span> session_prv_save_to_io(session_t*, io_t *);
00123 <span class="keywordtype">int</span> session_prv_save_var(var_t *, <span class="keywordtype">void</span>*);
00124 <span class="keywordtype">int</span> session_prv_calc_maxsize(var_t *v, <span class="keywordtype">void</span> *p);
00125 <span class="keywordtype">int</span> session_prv_save_to_buf(session_t *ss, <span class="keywordtype">char</span> **pbuf, size_t *psz);
00126 <span class="keywordtype">int</span> session_prv_load_from_buf(session_t *ss, <span class="keywordtype">char</span> *buf, size_t size);
00127 <span class="keywordtype">int</span> session_prv_set_id(session_t *ss, <span class="keyword">const</span> <span class="keywordtype">char</span> *sid);
00128 
00129 <span class="comment">/* init/term funcs */</span>
00130 <span class="keywordtype">int</span> session_module_init(u_config_t *config, session_opt_t **pso);
00131 <span class="keywordtype">int</span> session_file_module_init(u_config_t *config, session_opt_t *pso);
00132 <span class="keywordtype">int</span> session_mem_module_init(u_config_t *config, session_opt_t *pso);
00133 <span class="keywordtype">int</span> session_client_module_init(u_config_t *config, session_opt_t *pso);
00134 <span class="keywordtype">int</span> session_module_term(session_opt_t *so);
00135 <span class="keywordtype">int</span> session_module_term(session_opt_t *so);
00136 
00137 <span class="preprocessor">#ifdef __cplusplus</span>
00138 <span class="preprocessor"></span>}
00139 <span class="preprocessor">#endif </span>
00140 <span class="preprocessor"></span>
00141 <span class="preprocessor">#endif</span>
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


