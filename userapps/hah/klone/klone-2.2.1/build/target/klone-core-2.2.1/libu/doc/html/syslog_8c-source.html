<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: syslog.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>syslog.c</h1><div class="fragment"><pre>00001 <span class="comment">/* $Id: syslog.c,v 1.1 2006/11/20 13:38:01 tho Exp $ */</span>
00002 
00003 <span class="preprocessor">#include &lt;u/libu_conf.h&gt;</span>
00004 <span class="preprocessor">#include &lt;u/missing.h&gt;</span>
00005 <span class="preprocessor">#ifndef HAVE_SYSLOG</span>
00006 <span class="preprocessor"></span>
00007 <span class="preprocessor">#ifdef OS_WIN</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
00009 <span class="preprocessor">#include &lt;io.h&gt;</span>
00010 <span class="preprocessor">#include &lt;sys/locking.h&gt;</span>
00011 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00012 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00014 
00015 <span class="keywordtype">void</span> vsyslog(<span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, va_list ap)
00016 {
00017 <span class="preprocessor">    #define LIBU_WIN_LOGFILE "libu.log"</span>
00018 <span class="preprocessor"></span>    <span class="keyword">enum</span> { BUFSZ = 1024 };
00019     <span class="keyword">static</span> FILE *df = NULL, *lock = NULL;
00020     <span class="keywordtype">char</span> buf[BUFSZ];
00021     <span class="keywordtype">int</span> i;
00022 
00023     <span class="comment">/* first time open the log file and the lock file */</span>
00024     <span class="keywordflow">if</span>(df == NULL)
00025     {
00026         df = fopen(LIBU_WIN_LOGFILE, <span class="stringliteral">"a+"</span>);
00027         lock = fopen(LIBU_WIN_LOGFILE <span class="stringliteral">".lock"</span>, <span class="stringliteral">"a+"</span>);
00028         <span class="keywordflow">if</span>(df == NULL || lock == NULL)
00029             exit(1);
00030     }
00031 
00032     vsnprintf(buf, BUFSZ, fmt, ap);
00033 
00034     <span class="comment">/* get the lock (i.e. lock the first byte of the lock file) */</span>
00035     <span class="keywordflow">for</span>(i = 0; 
00036         _locking(fileno(lock), _LK_NBLCK, 1) == EACCES &amp;&amp; i &lt; 10; ++i)
00037         Sleep(100);
00038 
00039     <span class="keywordflow">if</span>(i &lt; 10)
00040     {   <span class="comment">/* we have the lock, write the log msg */</span>
00041         fprintf(df, <span class="stringliteral">"%s\n"</span>, buf);
00042         fflush(df);
00043         <span class="comment">/* unlock the file */</span>
00044         _locking(fileno(lock), _LK_UNLCK, 1);
00045     } <span class="keywordflow">else</span> {
00046         <span class="comment">/* file is still locked after 10 tries, give up */</span>
00047         ;
00048     }
00049 
00050     <span class="keywordflow">return</span>;
00051 }
00052 
00053 <span class="keywordtype">void</span> syslog(<span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
00054 {
00055     va_list ap;
00056 
00057     va_start(ap, fmt); <span class="comment">/* init variable list arguments */</span>
00058 
00059     vsyslog(priority, fmt, ap);
00060 
00061     va_end(ap);
00062 }
00063 
00064 <span class="preprocessor">#endif </span><span class="comment">/* ifdef OS_WIN */</span>
00065 
00066 <span class="preprocessor">#else </span><span class="comment">/* ifndef HAVE_SYSLOG */</span>
00067 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
00068 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00069 <span class="keywordtype">void</span> syslog(<span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...);
00070 <span class="keywordtype">void</span> vsyslog(<span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, va_list args);
00071 <span class="preprocessor">#endif </span>
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
