<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: gzip.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>gzip.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: gzip.c,v 1.25 2007/10/26 08:57:59 tho Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00013 <span class="preprocessor">#include &lt;klone/codec.h&gt;</span>
00014 <span class="preprocessor">#include &lt;klone/cgzip.h&gt;</span>
00015 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00016 
00017 <span class="preprocessor">#include &lt;zlib.h&gt;</span>
00018 
00019 <span class="keyword">struct </span>codec_gzip_s
00020 {
00021     codec_t codec;              <span class="comment">/* parent structure block           */</span>
00022     <span class="keywordtype">int</span> action;                 <span class="comment">/* GZIP_COMPRESS or GZIP_UNCOMPRESS */</span>
00023     <span class="keywordtype">int</span> err;                    <span class="comment">/* last error code                  */</span>
00024     z_stream zstr;              <span class="comment">/* zlib internal structure          */</span>
00025     int (*op)(z_streamp, <span class="keywordtype">int</span>);  <span class="comment">/* inflate or deflate               */</span>
00026     int (*opEnd)(z_streamp);    <span class="comment">/* inflateEnd or deflateEnd         */</span>
00027     <span class="keywordtype">char</span> dummy;                 <span class="comment">/* ZLIB &lt; 1.2 workaround dummy byte */</span>
00028 };
00029 
00030 <span class="keyword">typedef</span> <span class="keyword">struct </span>codec_gzip_s codec_gzip_t;
00031 
00032 <span class="keyword">static</span> ssize_t gzip_flush(codec_t *codec, <span class="keywordtype">char</span> *dst, size_t *dcount)
00033 {
00034     codec_gzip_t *iz;
00035 
00036     dbg_return_if (codec == NULL, -1);
00037     dbg_return_if (dst == NULL, -1);
00038     dbg_return_if (dcount == NULL, -1);
00039 
00040     iz = (codec_gzip_t*)codec;
00041     
00042     <span class="comment">/* can't set it to NULL even if zlib must not use it (avail_in == 0) */</span>
00043     iz-&gt;zstr.next_in = (<span class="keywordtype">char</span>*)0xDEADBEEF;
00044     iz-&gt;zstr.avail_in = 0;
00045 
00046 <span class="preprocessor">#if !defined(ZLIB_VERNUM) || ZLIB_VERNUM &lt; 0x1200</span>
00047 <span class="preprocessor"></span>    <span class="comment">/* zlib &lt; 1.2.0 workaround: push a dummy byte at the end of the </span>
00048 <span class="comment">       stream when inflating (see zlib ChangeLog) */</span>
00049     <span class="keywordflow">if</span>(iz-&gt;action == GZIP_UNCOMPRESS &amp;&amp; iz-&gt;dummy == 0)
00050     { 
00051         iz-&gt;zstr.next_in = &amp;iz-&gt;dummy; <span class="comment">/* dummy byte */</span>
00052         iz-&gt;zstr.avail_in = 1; 
00053         iz-&gt;dummy++;
00054     }
00055 <span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span>
00057     iz-&gt;zstr.next_out = dst;
00058     iz-&gt;zstr.avail_out = *dcount;
00059 
00060     <span class="comment">/* should be Z_STREAM_END while uncompressing */</span>
00061     <span class="keywordflow">if</span>(iz-&gt;err != Z_STREAM_END)
00062     {
00063         iz-&gt;err = iz-&gt;op(&amp;iz-&gt;zstr, 
00064             iz-&gt;action == GZIP_COMPRESS ? Z_FINISH : Z_NO_FLUSH);
00065         dbg_err_if(iz-&gt;err != Z_OK &amp;&amp; iz-&gt;err != Z_STREAM_END);
00066     } 
00067 
00068     *dcount = *dcount - iz-&gt;zstr.avail_out;   <span class="comment">/* written */</span>
00069 
00070     <span class="keywordflow">return</span> iz-&gt;err == Z_STREAM_END &amp;&amp; *dcount == 0 ? 
00071         CODEC_FLUSH_COMPLETE : CODEC_FLUSH_CHUNK;
00072 err:
00073     dbg(<span class="stringliteral">"%s"</span>, zError(iz-&gt;err));
00074     <span class="keywordflow">return</span> -1;
00075 }
00076 
00077 <span class="keyword">static</span> ssize_t gzip_transform(codec_t *codec, <span class="keywordtype">char</span> *dst, size_t *dcount, 
00078         <span class="keyword">const</span> <span class="keywordtype">char</span> *src, size_t src_sz)
00079 {
00080     codec_gzip_t *iz;
00081     size_t consumed;
00082  
00083     dbg_return_if (codec == NULL, -1);
00084     dbg_return_if (src == NULL, -1);
00085     dbg_return_if (dst == NULL, -1); 
00086     dbg_return_if (dcount == NULL || *dcount == 0, -1);
00087     dbg_return_if (src_sz == 0, -1);
00088 
00089     iz = (codec_gzip_t*)codec;
00090     
00091     iz-&gt;zstr.next_out = dst;
00092     iz-&gt;zstr.avail_out = *dcount;
00093 
00094     iz-&gt;zstr.next_in = (<span class="keywordtype">char</span>*)src;
00095     iz-&gt;zstr.avail_in = src_sz;
00096 
00097     iz-&gt;err = iz-&gt;op(&amp;iz-&gt;zstr, Z_NO_FLUSH);
00098     dbg_err_if(iz-&gt;err != Z_OK &amp;&amp; iz-&gt;err != Z_STREAM_END);
00099 
00100     consumed = src_sz - iz-&gt;zstr.avail_in;  <span class="comment">/* consumed */</span>
00101     *dcount = *dcount - iz-&gt;zstr.avail_out; <span class="comment">/* written */</span>
00102 
00103     <span class="keywordflow">return</span> consumed; <span class="comment">/* # of consumed input bytes */</span>
00104 err:
00105     dbg(<span class="stringliteral">"%s"</span>, zError(iz-&gt;err));
00106     <span class="keywordflow">return</span> -1;
00107 }
00108 
00109 <span class="keyword">static</span> <span class="keywordtype">int</span> gzip_free(codec_t *codec)
00110 {
00111     codec_gzip_t *iz;
00112     <span class="keywordtype">int</span> err;
00113 
00114     nop_return_if (codec == NULL, 0);
00115     
00116     iz = (codec_gzip_t*)codec;
00117     dbg_err_if((err = iz-&gt;opEnd(&amp;iz-&gt;zstr)) != Z_OK);
00118     U_FREE(iz);
00119 
00120     <span class="keywordflow">return</span> 0;
00121 err:
00122     dbg(<span class="stringliteral">"%s"</span>, zError(err));
00123     <span class="keywordflow">return</span> ~0;
00124 }
00125 
<a name="l00142"></a><a class="code" href="group__filters.html#ga2">00142</a> <span class="keywordtype">int</span> <a class="code" href="group__filters.html#ga2">codec_gzip_create</a>(<span class="keywordtype">int</span> op, codec_t **piz)
00143 {
00144     codec_gzip_t *iz = NULL;
00145 
00146     dbg_return_if (piz == NULL, ~0);
00147 
00148     iz = u_zalloc(<span class="keyword">sizeof</span>(codec_gzip_t));
00149     dbg_err_if(iz == NULL);
00150 
00151     iz-&gt;codec.transform = gzip_transform;
00152     iz-&gt;codec.flush = gzip_flush;
00153     iz-&gt;codec.free = gzip_free;
00154     iz-&gt;action = op; 
00155 
00156     <span class="keywordflow">switch</span>(op)
00157     {
00158     <span class="keywordflow">case</span> GZIP_COMPRESS:
00159         iz-&gt;op = deflate;
00160         iz-&gt;opEnd = deflateEnd;
00161         dbg_err_if(deflateInit2(&amp;iz-&gt;zstr, Z_DEFAULT_COMPRESSION, Z_DEFLATED,
00162                     -MAX_WBITS, 8, Z_DEFAULT_STRATEGY));
00163         <span class="keywordflow">break</span>;
00164     <span class="keywordflow">case</span> GZIP_UNCOMPRESS:
00165         iz-&gt;op = inflate;
00166         iz-&gt;opEnd = inflateEnd;
00167         dbg_err_if(inflateInit2(&amp;iz-&gt;zstr, -MAX_WBITS) != Z_OK);
00168         <span class="keywordflow">break</span>;
00169     <span class="keywordflow">default</span>:
00170         dbg_err_if(<span class="stringliteral">"bad gzip op"</span>);
00171     }
00172 
00173     *piz = (codec_t*)iz;
00174 
00175     <span class="keywordflow">return</span> 0;
00176 err:
00177     U_FREE(iz);
00178     <span class="keywordflow">return</span> ~0;
00179 }
00180 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


