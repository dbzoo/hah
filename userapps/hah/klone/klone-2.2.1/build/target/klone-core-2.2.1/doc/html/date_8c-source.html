<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: date.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>date.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: date.c,v 1.12 2008/12/17 08:40:53 tho Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00013 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00014 <span class="preprocessor">#include &lt;time.h&gt;</span>
00015 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00016 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00017 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00018 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00019 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00020 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00021 <span class="preprocessor">#include &lt;klone/os.h&gt;</span>
00022 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00023 
00029 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* days3[] = { 
00030     <span class="stringliteral">"Sun"</span>, <span class="stringliteral">"Mon"</span>, <span class="stringliteral">"Tue"</span>, <span class="stringliteral">"Wed"</span>, <span class="stringliteral">"Thu"</span>, <span class="stringliteral">"Fri"</span>, <span class="stringliteral">"Sat"</span> 
00031 };
00032 
00033 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* months[] = { 
00034     <span class="stringliteral">"Jan"</span>, <span class="stringliteral">"Feb"</span>, <span class="stringliteral">"Mar"</span>, <span class="stringliteral">"Apr"</span>, <span class="stringliteral">"May"</span>, <span class="stringliteral">"Jun"</span>, 
00035     <span class="stringliteral">"Jul"</span>, <span class="stringliteral">"Aug"</span>, <span class="stringliteral">"Sep"</span>, <span class="stringliteral">"Oct"</span>, <span class="stringliteral">"Nov"</span>, <span class="stringliteral">"Dec"</span> 
00036 };
00037 
00038 <span class="keyword">static</span> <span class="keywordtype">int</span> month_idx(<span class="keyword">const</span> <span class="keywordtype">char</span> *mon)
00039 {
00040     <span class="keywordtype">int</span> i;
00041 
00042     dbg_return_if (mon == NULL, -1);
00043     
00044     <span class="keywordflow">for</span>(i = 0; i &lt; 12; ++i)
00045         <span class="keywordflow">if</span>(strcasecmp(months[i], mon) == 0)
00046             <span class="keywordflow">return</span> i;
00047 
00048     <span class="keywordflow">return</span> -1;
00049 }
00050 
<a name="l00063"></a><a class="code" href="group__ut.html#ga54">00063</a> <span class="keywordtype">int</span> <a class="code" href="group__ut.html#ga54">u_asctime_to_tt</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, time_t *tp)
00064 {
00065     <span class="keyword">enum</span> { BUFSZ = 64 };
00066     <span class="keywordtype">char</span> wday[BUFSZ], mon[BUFSZ];
00067     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> day, year, hour, min, sec;
00068     <span class="keyword">struct </span>tm tm;
00069     <span class="keywordtype">int</span> i;
00070 
00071     dbg_return_if (str == NULL, ~0);
00072     dbg_return_if (tp == NULL, ~0);
00073     dbg_return_if (strlen(str) &gt;= BUFSZ, ~0);
00074 
00075     dbg_err_if((i = sscanf(str, <span class="stringliteral">"%s %s %u %u:%u:%u %u"</span>, wday, 
00076         mon, &amp;day, &amp;hour, &amp;min, &amp;sec, &amp;year)) != 7);
00077 
00078     memset(&amp;tm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm));
00079 
00080     <span class="comment">/* time */</span>
00081     tm.tm_sec = sec; tm.tm_min = min; tm.tm_hour = hour;
00082 
00083     <span class="comment">/* date */</span>
00084     tm.tm_mday = day; 
00085     tm.tm_mon = month_idx(mon);
00086     tm.tm_year = year - 1900;
00087 
00088     dbg_err_if(tm.tm_mon &lt; 0);
00089 
00090     *tp = timegm(&amp;tm);
00091     
00092     <span class="keywordflow">return</span> 0;
00093 err:
00094     <span class="keywordflow">return</span> ~0;
00095 }
00096 
<a name="l00109"></a><a class="code" href="group__ut.html#ga53">00109</a> <span class="keywordtype">int</span> <a class="code" href="group__ut.html#ga53">u_rfc850_to_tt</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, time_t *tp)
00110 {
00111     <span class="keyword">enum</span> { BUFSZ = 64 };
00112     <span class="keywordtype">char</span> wday[BUFSZ], mon[BUFSZ], tzone[BUFSZ];
00113     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> day, year, hour, min, sec;
00114     <span class="keyword">struct </span>tm tm;
00115     <span class="keywordtype">int</span> i;
00116     <span class="keywordtype">char</span> c;
00117 
00118     dbg_return_if (str == NULL, ~0);
00119     dbg_return_if (tp == NULL, ~0);
00120     dbg_return_if (strlen(str) &gt;= BUFSZ, ~0);
00121 
00122     dbg_err_if((i = sscanf(str, <span class="stringliteral">"%[^,], %u%c%[^-]%c%u %u:%u:%u %s"</span>, wday, 
00123         &amp;day, &amp;c, mon, &amp;c, &amp;year, &amp;hour, &amp;min, &amp;sec, tzone)) != 10);
00124 
00125     memset(&amp;tm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm));
00126 
00127     <span class="comment">/* time */</span>
00128     tm.tm_sec = sec; tm.tm_min = min; tm.tm_hour = hour;
00129 
00130     <span class="comment">/* date */</span>
00131     tm.tm_mday = day; 
00132     tm.tm_mon = month_idx(mon);
00133     tm.tm_year = year - 1900;
00134 
00135     dbg_err_if(tm.tm_mon &lt; 0);
00136 
00137 <span class="preprocessor">#ifdef HAVE_TMZONE</span>
00138 <span class="preprocessor"></span>    <span class="comment">/* time zone */</span>
00139     tm.tm_zone = tzone;
00140 <span class="preprocessor">#endif</span>
00141 <span class="preprocessor"></span>
00142     *tp = timegm(&amp;tm);
00143 
00144     <span class="keywordflow">return</span> 0;
00145 err:
00146     <span class="keywordflow">return</span> ~0;
00147 }
00148 
<a name="l00161"></a><a class="code" href="group__ut.html#ga52">00161</a> <span class="keywordtype">int</span> <a class="code" href="group__ut.html#ga52">u_rfc822_to_tt</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, time_t *tp)
00162 {
00163     <span class="keyword">enum</span> { BUFSZ = 64 };
00164     <span class="keywordtype">char</span> wday[BUFSZ], mon[BUFSZ], tzone[BUFSZ];
00165     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> day, year, hour, min, sec;
00166     <span class="keyword">struct </span>tm tm;
00167 
00168     dbg_return_if (str == NULL, ~0);
00169     dbg_return_if (tp == NULL, ~0);
00170     dbg_return_if (strlen(str) &gt;= BUFSZ, ~0);
00171 
00172     dbg_err_if(sscanf(str, <span class="stringliteral">"%[^,], %u %s %u %u:%u:%u %s"</span>, wday, 
00173         &amp;day, mon, &amp;year, &amp;hour, &amp;min, &amp;sec, tzone) != 8);
00174 
00175     memset(&amp;tm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm));
00176 
00177     <span class="comment">/* time */</span>
00178     tm.tm_sec = sec; tm.tm_min = min; tm.tm_hour = hour;
00179 
00180     <span class="comment">/* date */</span>
00181     tm.tm_mday = day; 
00182     tm.tm_mon = month_idx(mon);
00183     tm.tm_year = year - 1900; 
00184 
00185     dbg_err_if(tm.tm_mon &lt; 0);
00186 
00187 <span class="preprocessor">#ifdef HAVE_TMZONE</span>
00188 <span class="preprocessor"></span>    <span class="comment">/* time zone */</span>
00189     tm.tm_zone = tzone;
00190 <span class="preprocessor">#endif</span>
00191 <span class="preprocessor"></span>
00192     *tp = timegm(&amp;tm);
00193 
00194     <span class="keywordflow">return</span> 0;
00195 err:
00196     <span class="keywordflow">return</span> ~0;
00197 }
00198 
<a name="l00211"></a><a class="code" href="group__ut.html#ga51">00211</a> <span class="keywordtype">int</span> <a class="code" href="group__ut.html#ga51">u_httpdate_to_tt</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, time_t *tp)
00212 {
00213     dbg_return_if (str == NULL, ~0);
00214     dbg_return_if (tp == NULL, ~0);
00215     dbg_return_if (strlen(str) &lt; 4, ~0);
00216 
00217     <span class="keywordflow">if</span>(str[3] == <span class="charliteral">','</span>)
00218         <span class="keywordflow">return</span> <a class="code" href="group__ut.html#ga52">u_rfc822_to_tt</a>(str, tp);
00219     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(str[3] == <span class="charliteral">' '</span>)
00220         <span class="keywordflow">return</span> <a class="code" href="group__ut.html#ga54">u_asctime_to_tt</a>(str, tp);
00221 
00222     <span class="keywordflow">return</span> <a class="code" href="group__ut.html#ga53">u_rfc850_to_tt</a>(str, tp);
00223 }
00224 
<a name="l00239"></a><a class="code" href="group__ut.html#ga50">00239</a> <span class="keywordtype">int</span> <a class="code" href="group__ut.html#ga50">u_tt_to_rfc822</a>(<span class="keywordtype">char</span> dst[], time_t ts)
00240 {
00241     <span class="keyword">enum</span> { RFC822_DATE_BUFSZ = 32 };
00242     <span class="keywordtype">char</span> buf[RFC822_DATE_BUFSZ];
00243     <span class="keyword">struct </span>tm tm;
00244 
00245     dbg_return_if (dst == NULL, ~0);
00246 
00247 <span class="preprocessor">#ifdef OS_WIN</span>
00248 <span class="preprocessor"></span>    memcpy(&amp;tm, gmtime(&amp;ts), <span class="keyword">sizeof</span>(tm));
00249 <span class="preprocessor">#else</span>
00250 <span class="preprocessor"></span>    dbg_err_if(gmtime_r(&amp;ts, &amp;tm) == NULL);
00251 <span class="preprocessor">#endif</span>
00252 <span class="preprocessor"></span>
00253     dbg_err_if(tm.tm_wday &gt; 6 || tm.tm_wday &lt; 0);
00254     dbg_err_if(tm.tm_mon &gt; 11 || tm.tm_mon &lt; 0);
00255 
00256     dbg_err_if(u_snprintf(buf, RFC822_DATE_BUFSZ, 
00257                 <span class="stringliteral">"%s, %02u %s %02u %02u:%02u:%02u GMT"</span>,
00258                 days3[tm.tm_wday], 
00259                 tm.tm_mday, months[tm.tm_mon], tm.tm_year + 1900, 
00260                 tm.tm_hour, tm.tm_min, tm.tm_sec));
00261 
00262     <span class="comment">/* copy out */</span>
00263     u_sstrncpy(dst, buf, RFC822_DATE_BUFSZ - 1);
00264 
00265     <span class="keywordflow">return</span> 0;
00266 err:
00267     <span class="keywordflow">return</span> ~0;
00268 }
00269 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


