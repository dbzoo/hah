<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: ppc_log_add.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>ppc_log_add.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: ppc_log_add.c,v 1.13 2007/11/09 22:06:26 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
00013 <span class="preprocessor">#include &lt;klone/klog.h&gt;</span>
00014 <span class="preprocessor">#include &lt;klone/context.h&gt;</span>
00015 <span class="preprocessor">#include &lt;klone/server.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/ppc.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/ppc_cmd.h&gt;</span>
00018 <span class="preprocessor">#include &lt;klone/server_ppc_cmd.h&gt;</span>
00019 <span class="preprocessor">#include "server_s.h"</span>
00020 
00021 <span class="comment">/* struct used for ppc command PPC_CMD_LOG_ADD */</span>
00022 <span class="keyword">struct </span>ppc_log_add_s
00023 {
00024     <span class="keywordtype">int</span> bid;                        <span class="comment">/* calling backend ID       */</span>
00025     <span class="keywordtype">int</span> level;                      <span class="comment">/* log level                */</span>
00026     <span class="keywordtype">char</span> log[U_MAX_LOG_LENGTH];     <span class="comment">/* log line                 */</span>
00027 };
00028 
00029 <span class="keyword">typedef</span> <span class="keyword">struct </span>ppc_log_add_s ppc_log_add_t;
00030 
00031 <span class="keywordtype">int</span> syslog_to_klog(<span class="keywordtype">int</span> level)
00032 {
00033     <span class="keyword">static</span> <span class="keywordtype">int</span> klog_lev[] = 
00034     { 
00035         KLOG_EMERG,
00036         KLOG_ALERT,
00037         KLOG_CRIT,
00038         KLOG_ERR,
00039         KLOG_WARNING,
00040         KLOG_NOTICE,
00041         KLOG_INFO,
00042         KLOG_DEBUG
00043     };
00044 
00045     <span class="keywordflow">if</span>(level &lt; LOG_EMERG || level &gt; LOG_DEBUG)
00046         <span class="keywordflow">return</span> KLOG_ALERT;
00047 
00048     <span class="keywordflow">return</span> klog_lev[level];
00049 }
00050 
00051 <span class="comment">/* client function */</span>
00052 <span class="keywordtype">int</span> server_ppc_cmd_log_add(server_t *s, <span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *str)
00053 {
00054     ppc_log_add_t la;
00055 
00056     nop_err_if (s == NULL);
00057     nop_err_if (s-&gt;ppc == NULL);
00058     nop_err_if (str == NULL);
00059 
00060     memset(&amp;la, 0, <span class="keyword">sizeof</span>(ppc_log_add_t));
00061 
00062     la.bid = ctx-&gt;backend-&gt;id;
00063     la.level = level;
00064     strncpy(la.log, str, U_MAX_LOG_LENGTH);
00065     la.log[U_MAX_LOG_LENGTH -1] = 0;
00066 
00067     <span class="comment">/* send the command request */</span>
00068     nop_err_if(ppc_write(s-&gt;ppc, ctx-&gt;pipc, PPC_CMD_LOG_ADD, (<span class="keywordtype">char</span>*)&amp;la, 
00069         <span class="keyword">sizeof</span>(la)) &lt; 0);
00070 
00071     <span class="keywordflow">return</span> 0;
00072 err:
00073     <span class="keywordflow">return</span> ~0;
00074 }
00075 
00076 <span class="comment">/* [parent] log a new message */</span>
00077 <span class="keywordtype">int</span> server_ppc_cb_log_add(ppc_t *ppc, <span class="keywordtype">int</span> fd, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmd, <span class="keywordtype">char</span> *data, 
00078     size_t size, <span class="keywordtype">void</span> *vso)
00079 {
00080     server_t *s;
00081     ppc_log_add_t *pla;
00082     backend_t *be;
00083     klog_t *kl;
00084 
00085     u_unused_args(ppc, fd, cmd, size);
00086 
00087     nop_err_if (vso == NULL);
00088     nop_err_if (data == NULL);
00089 
00090     pla = (ppc_log_add_t *) data;
00091     s = (server_t *) vso;
00092 
00093     <span class="comment">/* by default use server logger */</span>
00094     kl = s-&gt;klog;
00095 
00096     <span class="comment">/* get the logger obj of the calling backend (if any) */</span>
00097     <span class="keywordflow">if</span>(!server_get_backend_by_id(s, pla-&gt;bid, &amp;be) &amp;&amp; be-&gt;klog)
00098         kl = be-&gt;klog;
00099 
00100     <span class="comment">/* log the line */</span>
00101     <span class="keywordflow">if</span>(kl)
00102         nop_err_if(klog(kl, syslog_to_klog(pla-&gt;level), <span class="stringliteral">"%s"</span>, pla-&gt;log));
00103 
00104     <span class="keywordflow">return</span> 0;
00105 err:
00106     <span class="keywordflow">return</span> ~0;
00107 }
00108 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


