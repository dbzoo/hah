<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: config_fs.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>config_fs.c</h1><div class="fragment"><pre>00001 <span class="comment">/* </span>
00002 <span class="comment"> * Copyright (c) 2005-2008 by KoanLogic s.r.l. - All rights reserved.  </span>
00003 <span class="comment"> */</span>
00004 
00005 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00006 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00007 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00008 <span class="preprocessor">#include &lt;string.h&gt;</span>
00009 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00010 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;toolbox/carpal.h&gt;</span>
00013 <span class="preprocessor">#include &lt;toolbox/config.h&gt;</span>
00014 <span class="preprocessor">#include &lt;toolbox/misc.h&gt;</span>
00015 <span class="preprocessor">#include &lt;toolbox/memory.h&gt;</span>
00016 <span class="preprocessor">#include &lt;toolbox/str.h&gt;</span>
00017 
00018 <span class="keyword">static</span> <span class="keywordtype">int</span> drv_fs_open(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">void</span> **parg)
00019 {
00020     <span class="keywordtype">int</span> fd = -1;
00021     FILE *file = NULL;
00022 
00023     dbg_err_if(path == NULL);
00024     dbg_err_if(parg == NULL);
00025 
00026     <span class="comment">/* open the file */</span>
00027 again:
00028     fd = open (path, O_RDONLY);
00029     <span class="keywordflow">if</span>(fd == -1 &amp;&amp; (errno == EINTR))
00030         <span class="keywordflow">goto</span> again; <span class="comment">/* interrupted */</span>
00031 
00032     crit_err_sif(fd &lt; 0);
00033 
00034     <span class="comment">/* stdio will handle buffering */</span>
00035     file = fdopen(fd, <span class="stringliteral">"r"</span>);
00036     dbg_err_if(file == NULL);
00037 
00038     *parg = file;
00039 
00040     <span class="keywordflow">return</span> 0;
00041 err:
00042     <span class="keywordflow">if</span>(file)
00043         fclose(file);
00044     <span class="keywordflow">if</span>(fd &gt;= 0)
00045         close(fd);
00046     <span class="keywordflow">return</span> ~0;
00047 }
00048 
00049 <span class="keyword">static</span> <span class="keywordtype">int</span> drv_fs_close(<span class="keywordtype">void</span> *arg)
00050 {
00051     FILE *file = (FILE*)arg;
00052 
00053     dbg_err_if(file == NULL);
00054 
00055     fclose(file);
00056 
00057     <span class="keywordflow">return</span> 0;
00058 err:
00059     <span class="keywordflow">return</span> ~0;
00060 }
00061 
00062 <span class="keyword">static</span> <span class="keywordtype">char</span>* drv_fs_gets(<span class="keywordtype">void</span> *arg, <span class="keywordtype">char</span> *buf, size_t size)
00063 {
00064     FILE *file = (FILE*)arg;
00065 
00066     dbg_err_if(file == NULL);
00067     dbg_err_if(buf == NULL);
00068 
00069     <span class="keywordflow">return</span> fgets(buf, size, file);
00070 err:
00071     <span class="keywordflow">return</span> NULL;
00072 }
00073 
00074 <span class="comment">/* pre-set driver for filesystem access */</span>
00075 u_config_driver_t u_config_drv_fs = { 
00076     drv_fs_open, 
00077     drv_fs_close, 
00078     drv_fs_gets,
00079     NULL <span class="comment">/* include resolver */</span>
00080 };
00081 
00082 
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
