<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: test.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>test.c</h1><div class="fragment"><pre>00001 <span class="comment">/* </span>
00002 <span class="comment"> * Copyright (c) 2005-2008 by KoanLogic s.r.l. - All rights reserved.  </span>
00003 <span class="comment"> */</span>
00004 
00005 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00006 
00007 <span class="keyword">enum</span> { MAX_MODS = 1024 };
00008 
00009 test_runner_t _mods[MAX_MODS] = { NULL };
00010 test_runner_t *_top = _mods;
00011 
00012 <span class="keywordtype">char</span> *_mods_nm[MAX_MODS] = { NULL };
00013 <span class="keywordtype">char</span> **_top_nm = _mods_nm;
00014 
00015 <span class="keywordtype">int</span> _test_cnt = 0;
00016 <span class="keywordtype">int</span> _test_fail = 0;
00017 <span class="keywordtype">int</span> _test_ok = 0;
00018 <span class="keywordtype">int</span> _verbose = 0;
00019 
00020 <span class="keyword">static</span> <span class="keywordtype">char</span> **arg;
00021 <span class="keyword">static</span> <span class="keywordtype">int</span> narg;
00022 
00023 <span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prog)
00024 {
00025     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *us = 
00026         <span class="stringliteral">"usage: %s OPTIONS [ MODULE ... ]\n"</span>
00027         <span class="stringliteral">"\n"</span>
00028         <span class="stringliteral">"    -h          display this help   \n"</span>
00029         <span class="stringliteral">"    -v          be verbose          \n"</span>
00030         <span class="stringliteral">"\n"</span>
00031         <span class="stringliteral">"    Available modules:\n"</span>;
00032     <span class="keywordtype">char</span> **p;
00033 
00034     fprintf(stderr, us, prog);
00035 
00036     <span class="keywordflow">for</span>(p = _mods_nm; p != _top_nm; ++p)
00037         fprintf(stderr, <span class="stringliteral">"        %s\n"</span>, *p);
00038     fprintf(stderr, <span class="stringliteral">"\n"</span>);
00039 
00040     exit(1);
00041 }
00042 
00043 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_opt(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00044 {
00045     <span class="keywordtype">int</span> ret;
00046 
00047     <span class="keywordflow">while</span>((ret = getopt(argc, argv, <span class="stringliteral">"vh"</span>)) != -1)
00048     {
00049         <span class="keywordflow">switch</span>(ret)
00050         {
00051         <span class="keywordflow">case</span> <span class="charliteral">'v'</span>: 
00052             _verbose = 1;
00053             <span class="keywordflow">break</span>;
00054         <span class="keywordflow">default</span>:
00055         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>: 
00056             usage(argv[0]);
00057         }
00058     }
00059 
00060     narg = argc - optind;
00061     arg = argv + optind;
00062 
00063     <span class="keywordflow">return</span> 0;
00064 }
00065 
00066 <span class="keyword">static</span> <span class="keywordtype">int</span> run_test_module(<span class="keyword">const</span> <span class="keywordtype">char</span> *module)
00067 {
00068     <span class="keywordtype">char</span> **m;
00069     <span class="keywordtype">int</span> i;
00070 
00071     <span class="keywordflow">for</span>(i = 0, m = _mods_nm; m &lt; _top_nm; ++m, ++i)
00072     {
00073         <span class="keywordflow">if</span>(!strcasecmp(*m, module))
00074         {
00075             _mods[i]();  <span class="comment">/* run module tests */</span>
00076             <span class="keywordflow">return</span> 0;
00077         }
00078     }
00079 
00080     con_return_ifm (1, ~0, <span class="stringliteral">"unknown module %s"</span>, module);
00081 }
00082 
<a name="l00083"></a><a class="code" href="group__test.html#ga14">00083</a> <span class="keywordtype">int</span> <a class="code" href="group__test.html#ga14">u_test_run</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00084 {
00085     test_runner_t *p;
00086     <span class="keywordtype">int</span> i;
00087 
00088     dbg_err_if(parse_opt(argc, argv));
00089 
00090     <span class="keywordflow">if</span>(narg)
00091     {
00092         <span class="comment">/* run only user provided modules */</span>
00093         <span class="keywordflow">for</span>(i = 0; i &lt; narg; ++i)
00094             dbg_err_if(run_test_module(arg[i]));
00095     } <span class="keywordflow">else</span> {
00096         <span class="comment">/* run all modules */</span>
00097         <span class="keywordflow">for</span>(i = 0, p = _mods; p &lt; _top; ++p, ++i)
00098             (*p)();
00099     }
00100 
00101     <span class="comment">/* free strdup'd module names */</span>
00102     <span class="keywordflow">for</span>(p = _mods_nm; p != _top_nm; ++p)
00103         <a class="code" href="group__alloc.html#ga8">u_free</a>(*p), *p = NULL;
00104 
00105     printf(<span class="stringliteral">"%d test run, %d failed\n"</span>, _test_cnt, _test_fail);
00106 
00107     <span class="keywordflow">return</span> 0;
00108 err:
00109     <span class="keywordflow">return</span> ~0;
00110 }
00111 
00112 
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
