<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: session.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>session.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: session.c,v 1.46 2009/10/23 14:08:28 tho Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00013 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00014 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00015 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00016 <span class="preprocessor">#include &lt;time.h&gt;</span>
00017 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00018 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00019 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#include &lt;openssl/hmac.h&gt;</span>
00021 <span class="preprocessor">#include &lt;openssl/evp.h&gt;</span>
00022 <span class="preprocessor">#include &lt;openssl/rand.h&gt;</span>
00023 <span class="preprocessor">#include &lt;klone/ccipher.h&gt;</span>
00024 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_LIBOPENSSL */</span>
00025 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00026 <span class="preprocessor">#include &lt;klone/session.h&gt;</span>
00027 <span class="preprocessor">#include &lt;klone/request.h&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="response_8h.html">klone/response.h</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;klone/vars.h&gt;</span>
00030 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00031 <span class="preprocessor">#include &lt;klone/ses_prv.h&gt;</span>
00032 <span class="preprocessor">#include &lt;klone/codecs.h&gt;</span>
00033 
00034 <span class="keyword">enum</span> { DEFAULT_SESSION_EXPIRATION = 60*20 }; <span class="comment">/* 20 minutes */</span>
00035 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> SID_NAME[] = <span class="stringliteral">"klone_sid"</span>;
00036 
00037 <span class="keyword">struct </span>save_cb_params_s
00038 {
00039     session_t *ss;
00040     io_t *io;
00041 };
00042 
00043 <span class="keyword">typedef</span> <span class="keyword">struct </span>save_cb_params_s save_cb_params_t;
00044 
00045 <span class="keywordtype">int</span> session_module_term(session_opt_t *so)
00046 {
00047     U_FREE(so);
00048 
00049     <span class="keywordflow">return</span> 0;
00050 }
00051 
00052 <span class="keywordtype">int</span> session_module_init(u_config_t *config, session_opt_t **pso)
00053 {
00054     session_opt_t *so = NULL;
00055     u_config_t *c = NULL;
00056     <span class="keyword">const</span> <span class="keywordtype">char</span> *v;
00057 
00058     dbg_err_if (config == NULL);
00059     dbg_err_if (pso == NULL);
00060 
00061     so = u_zalloc(<span class="keyword">sizeof</span>(session_opt_t));
00062     dbg_err_if(so == NULL);
00063 
00064     <span class="comment">/* defaults values */</span>
00065     so-&gt;type = SESSION_TYPE_FILE;
00066     so-&gt;max_age = DEFAULT_SESSION_EXPIRATION;
00067     so-&gt;compress = 0;
00068     so-&gt;encrypt = 0;
00069     (<span class="keywordtype">void</span>) u_strlcpy(so-&gt;name, SID_NAME, <span class="keyword">sizeof</span> so-&gt;name);
00070 
00071     <span class="keywordflow">if</span>(!u_config_get_subkey(config, <span class="stringliteral">"session"</span>, &amp;c))
00072     {
00073         <span class="comment">/* no 'session' subsection, defaults will be used */</span>
00074 
00075         <span class="comment">/* set session type */</span>
00076         <span class="keywordflow">if</span>((v = u_config_get_subkey_value(c, <span class="stringliteral">"type"</span>)) != NULL)
00077         {
00078             <span class="keywordflow">if</span>(!strcasecmp(v, <span class="stringliteral">"memory"</span>)) {
00079                 so-&gt;type = SESSION_TYPE_MEMORY;
00080             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v, <span class="stringliteral">"file"</span>)) {
00081                 so-&gt;type = SESSION_TYPE_FILE;
00082 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00083 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v, <span class="stringliteral">"client"</span>)) {
00084                 so-&gt;type = SESSION_TYPE_CLIENT;
00085 <span class="preprocessor">#endif</span>
00086 <span class="preprocessor"></span>            } <span class="keywordflow">else</span>
00087                warn_err(<span class="stringliteral">"config error: bad session type (typo or missing "</span>
00088                         <span class="stringliteral">"library)"</span>);
00089         }
00090 
00091         <span class="comment">/* set max_age */</span>
00092         <span class="keywordflow">if</span>((v = u_config_get_subkey_value(c, <span class="stringliteral">"max_age"</span>)) != NULL)
00093             so-&gt;max_age = MAX(atoi(v) * 60, 60); <span class="comment">/* min value: 1 min */</span>
00094 
00095         <span class="comment">/* set compression flag */</span>
00096         dbg_err_if(u_config_get_subkey_value_b(c, <span class="stringliteral">"compress"</span>, 0,
00097             &amp;so-&gt;compress));
00098 
00099         <span class="comment">/* set encryption flag */</span>
00100         dbg_err_if(u_config_get_subkey_value_b(c, <span class="stringliteral">"encrypt"</span>, 0, &amp;so-&gt;encrypt));
00101 
00102         <span class="comment">/* set cookie name */</span>
00103         <span class="keywordflow">if</span> ((v = u_config_get_subkey_value(c, <span class="stringliteral">"sid_name"</span>)) != NULL)
00104             dbg_err_if (u_strlcpy(so-&gt;name, v, <span class="keyword">sizeof</span> so-&gt;name));
00105 
00106 <span class="preprocessor">#ifndef HAVE_LIBZ</span>
00107 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(so-&gt;compress)
00108             warn_err(<span class="stringliteral">"config error: compression is enabled but libz is not "</span>
00109                      <span class="stringliteral">"linked"</span>);
00110 <span class="preprocessor">#endif</span>
00111 <span class="preprocessor"></span>
00112 <span class="preprocessor">#ifndef HAVE_LIBOPENSSL</span>
00113 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(so-&gt;encrypt)
00114             warn_err(<span class="stringliteral">"config error: encryption is enabled but OpenSSL is not "</span>
00115                      <span class="stringliteral">"linked"</span>);
00116 <span class="preprocessor">#else</span>
00117 <span class="preprocessor"></span>        <span class="comment">/* init cipher EVP algo, the random key and IV */</span>
00118         so-&gt;cipher = EVP_aes_256_cbc(); <span class="comment">/* use AES-256 in CBC mode */</span>
00119 
00120         EVP_add_cipher(so-&gt;cipher);
00121 
00122         <span class="comment">/* key and iv for client-side session */</span>
00123         dbg_err_if(!RAND_bytes(so-&gt;cipher_key, CIPHER_KEY_SIZE));
00124         dbg_err_if(!RAND_pseudo_bytes(so-&gt;cipher_iv, CIPHER_IV_SIZE));
00125 
00126         <span class="comment">/* create a random key and iv to crypt the KLONE_CIPHER_KEY variable */</span>
00127         dbg_err_if(!RAND_bytes(so-&gt;session_key, CIPHER_KEY_SIZE));
00128         dbg_err_if(!RAND_pseudo_bytes(so-&gt;session_iv, CIPHER_IV_SIZE));
00129 
00130 <span class="preprocessor">#endif</span>
00131 <span class="preprocessor"></span>    } <span class="comment">/* if "session" exists */</span>
00132 
00133     <span class="comment">/* per-type configuration init */</span>
00134     <span class="keywordflow">if</span>(so-&gt;type == SESSION_TYPE_MEMORY)
00135         warn_err_ifm(session_mem_module_init(c, so), 
00136             <span class="stringliteral">"in-memory session engine init error"</span>);
00137     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(so-&gt;type == SESSION_TYPE_FILE)
00138         warn_err_ifm(session_file_module_init(c, so), 
00139             <span class="stringliteral">"file session engine init error"</span>);
00140 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00141 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(so-&gt;type == SESSION_TYPE_CLIENT)
00142         warn_err_ifm(session_client_module_init(c, so),
00143             <span class="stringliteral">"client-side session engine init error"</span>);
00144 <span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>
00146     *pso = so;
00147 
00148     <span class="keywordflow">return</span> 0;
00149 err:
00150     U_FREE(so);
00151     <span class="keywordflow">return</span> ~0;
00152 }
00153 
00154 <span class="keywordtype">int</span> session_prv_calc_maxsize(var_t *v, <span class="keywordtype">void</span> *p)
00155 {
00156     <span class="keyword">const</span> <span class="keywordtype">char</span> *value = NULL;
00157     size_t *psz = (size_t*)p;
00158 
00159     dbg_err_if (v == NULL);
00160     dbg_err_if (var_get_name(v) == NULL);
00161     dbg_err_if (psz == NULL);
00162 
00163 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00164 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(*psz == 0)
00165     {   <span class="comment">/* first time here */</span>
00166         *psz = CODEC_CIPHER_BLOCK_SIZE;
00167     }
00168 <span class="preprocessor">#endif</span>
00169 <span class="preprocessor"></span>
00170     <span class="comment">/* name= */</span>
00171     *psz += 3 * strlen(var_get_name(v)) + 3;
00172 
00173     <span class="comment">/* value */</span>
00174     <span class="keywordflow">if</span>((value = var_get_value(v)) != NULL)
00175         *psz += 3 * strlen(value) + 1; <span class="comment">/* worse case (i.e. longest string) */</span>
00176 
00177     <span class="keywordflow">return</span> 0;
00178 err:
00179     <span class="keywordflow">return</span> ~0;
00180 }
00181 
00182 <span class="keywordtype">int</span> session_prv_load_from_buf(session_t *ss, <span class="keywordtype">char</span> *buf, size_t size)
00183 {
00184     io_t *io = NULL;
00185 
00186     dbg_err_if (ss == NULL);
00187     dbg_err_if (buf == NULL);
00188 
00189     <span class="comment">/* build an io_t around the buffer */</span>
00190     dbg_err_if(io_mem_create(buf, size, 0, &amp;io));
00191 
00192     <span class="comment">/* load data */</span>
00193     dbg_err_if(session_prv_load_from_io(ss, io));
00194 
00195     <a class="code" href="group__basic.html#ga14">io_free</a>(io);
00196 
00197     <span class="keywordflow">return</span> 0;
00198 err:
00199     <span class="keywordflow">if</span>(io)
00200         <a class="code" href="group__basic.html#ga14">io_free</a>(io);
00201     <span class="keywordflow">return</span> ~0;
00202 }
00203 
00204 <span class="keywordtype">int</span> session_prv_save_to_buf(session_t *ss, <span class="keywordtype">char</span> **pbuf, size_t *psz)
00205 {
00206     io_t *io = NULL;
00207     <span class="keywordtype">char</span> *buf = NULL;
00208     size_t sz = 0;
00209 
00210     dbg_err_if (ss == NULL);
00211     dbg_err_if (pbuf == NULL);
00212     dbg_err_if (psz == NULL);
00213  
00214     <span class="comment">/* calc the maximum session data size (exact calc requires url encoding and</span>
00215 <span class="comment">       codec transformation knowledge) */</span>
00216     vars_foreach(ss-&gt;vars, session_prv_calc_maxsize, (<span class="keywordtype">void</span>*)&amp;sz);
00217 
00218     <span class="comment">/* alloc a big-enough block to save the session data */</span>
00219     buf = u_malloc(sz);
00220     dbg_err_if(buf == NULL);
00221 
00222     <span class="comment">/* create a big-enough in-memory io object */</span>
00223     dbg_err_if(io_mem_create(buf, sz, 0, &amp;io));
00224 
00225     <span class="comment">/* save the session to the in-memory io */</span>
00226     dbg_err_if(session_prv_save_to_io(ss, io));
00227 
00228     <span class="comment">/* remove all codecs to get the right size of 'buf'. we need to remove </span>
00229 <span class="comment">       the codecs because some of them buffer data until last codec-&gt;flush() </span>
00230 <span class="comment">       is called (and it's not possible to flush codecs without removing them */</span>
00231     dbg_err_if(<a class="code" href="group__basic.html#ga33">io_codecs_remove</a>(io));
00232 
00233     <span class="comment">/* get the number of bytes written to the io (so to 'buf') */</span>
00234     sz = <a class="code" href="group__basic.html#ga22">io_tell</a>(io);
00235 
00236     <a class="code" href="group__basic.html#ga14">io_free</a>(io);
00237     io = NULL;
00238 
00239     *pbuf = buf;
00240     *psz = sz;
00241 
00242     <span class="keywordflow">return</span> 0;
00243 err:
00244     <span class="keywordflow">if</span>(io)
00245         <a class="code" href="group__basic.html#ga14">io_free</a>(io);
00246     U_FREE(buf);
00247     <span class="keywordflow">return</span> ~0;
00248 }
00249 
00250 <span class="keyword">static</span> <span class="keywordtype">int</span> session_is_good_id(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
00251 {
00252     <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
00253     size_t len;
00254 
00255     dbg_return_if (<span class="keywordtype">id</span> == NULL, 0);
00256 
00257     dbg_ifb((len = strlen(<span class="keywordtype">id</span>)) != SESSION_ID_LENGTH)
00258         <span class="keywordflow">return</span> 0; <span class="comment">/* wrong length */</span>
00259 
00260     <span class="keywordflow">for</span>(p = <span class="keywordtype">id</span>; len; --len, ++p)
00261     {
00262         <span class="comment">/* if is hex */</span>
00263         <span class="keywordflow">if</span>(! ((*p &gt;= <span class="charliteral">'A'</span> &amp;&amp; *p &lt;= 'F') || (*p &gt;= <span class="charliteral">'a'</span> &amp;&amp; *p &lt;= <span class="charliteral">'f'</span>) || 
00264               (*p &gt;= <span class="charliteral">'0'</span> &amp;&amp; *p &lt;= <span class="charliteral">'9'</span>)) )
00265         <span class="keywordflow">return</span> 0; <span class="comment">/* not safe */</span>
00266     }
00267 
00268     <span class="keywordflow">return</span> 1; <span class="comment">/* good */</span>
00269 }
00270 
00271 <span class="keyword">static</span> <span class="keywordtype">int</span> session_set_filename(session_t *ss)
00272 {
00273     kaddr_t *addr = NULL;
00274 
00275     dbg_err_if(strlen(ss-&gt;id) == 0);
00276 
00277     dbg_err_if((addr = <a class="code" href="group__request.html#ga9">request_get_addr</a>(ss-&gt;rq)) == NULL);
00278     <span class="keywordflow">switch</span>(addr-&gt;type)
00279     {
00280     <span class="keywordflow">case</span> ADDR_IPV4:
00281         dbg_err_if(u_path_snprintf(ss-&gt;filename, U_FILENAME_MAX, 
00282             U_PATH_SEPARATOR, <span class="stringliteral">"%s/klone_sess_%s_%lu"</span>, ss-&gt;so-&gt;path, ss-&gt;id, 
00283             addr-&gt;sa.sin.sin_addr));
00284         <span class="keywordflow">break</span>;
00285     <span class="keywordflow">case</span> ADDR_IPV6:
00286         <span class="comment">/* FIXME: add ipv6 address in session filename */</span>
00287         dbg_err_if(u_path_snprintf(ss-&gt;filename, U_FILENAME_MAX, 
00288             U_PATH_SEPARATOR, <span class="stringliteral">"%s/klone_sess_%s"</span>, ss-&gt;so-&gt;path, ss-&gt;id));
00289         <span class="keywordflow">break</span>;
00290 <span class="preprocessor">#ifdef OS_UNIX</span>
00291 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ADDR_UNIX:
00292         <span class="comment">/* FIXME: add unix address in session filename */</span>
00293         dbg_err_if(u_path_snprintf(ss-&gt;filename, U_FILENAME_MAX, 
00294             U_PATH_SEPARATOR, <span class="stringliteral">"%s/klone_sess_%s"</span>, ss-&gt;so-&gt;path, ss-&gt;id));
00295         <span class="keywordflow">break</span>;
00296 <span class="preprocessor">#endif</span>
00297 <span class="preprocessor"></span>    }
00298 
00299     <span class="keywordflow">return</span> 0;
00300 err:
00301     <span class="keywordflow">return</span> 0;
00302 }
00303 
00304 <span class="keyword">static</span> <span class="keywordtype">int</span> session_gen_id(session_t *ss)
00305 {
00306     <span class="keyword">enum</span> { BUFSZ = 256 };
00307     <span class="keywordtype">char</span> buf[BUFSZ];
00308     <span class="keyword">struct </span>timeval tv;
00309 
00310     dbg_err_if (ss == NULL);
00311 
00312     <span class="comment">/* gen a new one */</span>
00313     gettimeofday(&amp;tv, NULL);
00314 
00315     dbg_err_if(u_snprintf(buf, BUFSZ, <span class="stringliteral">"%lu%d%lu%d"</span>, tv.tv_sec, getpid(), 
00316         tv.tv_usec, rand()));
00317 
00318     <span class="comment">/* return the md5 (in hex) buf */</span>
00319     dbg_err_if(<a class="code" href="group__ut.html#ga42">u_md5</a>(buf, strlen(buf), ss-&gt;id));
00320 
00321     <span class="comment">/* remove previous sid if any */</span> 
00322     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, ss-&gt;so-&gt;name, NULL, 0, NULL, 
00323                 NULL, 0));
00324 
00325     <span class="comment">/* set the cookie ID */</span>
00326     dbg_err_if(<a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, ss-&gt;so-&gt;name, ss-&gt;id, 0, NULL, 
00327                 NULL, 0));
00328 
00329     <span class="keywordflow">return</span> 0;
00330 err:
00331     <span class="keywordflow">return</span> ~0;
00332 }
00333 
00334 <span class="keywordtype">int</span> session_priv_set_id(session_t *ss, <span class="keyword">const</span> <span class="keywordtype">char</span> *sid)
00335 {
00336     <span class="comment">/* set or generate a session id */</span>
00337     <span class="keywordflow">if</span>(sid &amp;&amp; session_is_good_id(sid))
00338     {
00339         dbg_err_if(u_snprintf(ss-&gt;id, SESSION_ID_BUFSZ, <span class="stringliteral">"%s"</span>, sid));
00340         ss-&gt;id[SESSION_ID_BUFSZ-1] = 0;
00341     } <span class="keywordflow">else</span>
00342         dbg_err_if(session_gen_id(ss));
00343 
00344     <span class="comment">/* set the filename accordingly */</span>
00345     dbg_err_if(session_set_filename(ss));
00346 
00347     <span class="keywordflow">return</span> 0;
00348 err:
00349     <span class="keywordflow">return</span> ~0;
00350 }
00351 
00352 <span class="keywordtype">int</span> session_load(session_t *ss)
00353 {
00354     dbg_return_if (ss == NULL, ~0);
00355     dbg_return_if (ss-&gt;load == NULL, ~0);
00356 
00357     <span class="keywordflow">return</span> ss-&gt;load(ss);
00358 }
00359 
00360 <span class="keywordtype">int</span> session_save(session_t *ss)
00361 {
00362     size_t vcount;
00363     dbg_err_if (ss == NULL);
00364     dbg_err_if (ss-&gt;save == NULL);
00365 
00366     vcount = vars_count(ss-&gt;vars);
00367 
00368     <span class="keywordflow">if</span>(ss-&gt;id[0] == 0 &amp;&amp; vcount == 0)
00369         <span class="keywordflow">return</span> 0; <span class="comment">/* new user, no vars set -&gt; nothing to save */</span>
00370 
00371     <span class="keywordflow">if</span>(ss-&gt;id[0] != 0 &amp;&amp; vcount == 0)
00372         <span class="keywordflow">return</span> session_remove(ss); <span class="comment">/* old user, all vars removed */</span>
00373 
00374     <span class="keywordflow">if</span>(ss-&gt;id[0] == 0)
00375     {
00376         <span class="comment">/* new user, need to save some vars */</span>
00377 
00378         <span class="comment">/* generate a new SID and set session filename accordingly */</span>
00379         dbg_err_if(session_priv_set_id(ss, NULL)); 
00380     }
00381 
00382     <span class="keywordflow">return</span> ss-&gt;save(ss);
00383 err:
00384     <span class="keywordflow">return</span> ~0;
00385 }
00386 
00387 <span class="keywordtype">int</span> session_remove(session_t *ss)
00388 {
00389     dbg_return_if (ss == NULL, ~0);
00390     dbg_return_if (ss-&gt;remove == NULL, ~0);
00391 
00392     <span class="comment">/* remove the cookie */</span>
00393     <a class="code" href="group__response.html#ga26">response_set_cookie</a>(ss-&gt;rs, ss-&gt;so-&gt;name, NULL, 0, NULL, NULL, 0);
00394 
00395     ss-&gt;removed = 1;
00396 
00397     <span class="keywordflow">return</span> ss-&gt;remove(ss);
00398 }
00399 
00400 <span class="keywordtype">int</span> session_prv_init(session_t *ss, request_t *rq, response_t *rs)
00401 {
00402     <span class="keyword">const</span> <span class="keywordtype">char</span> *sid;
00403 
00404     dbg_err_if (ss == NULL);
00405     dbg_err_if (rq == NULL);
00406     dbg_err_if (rs == NULL);
00407     
00408     dbg_err_if(vars_create(&amp;ss-&gt;vars));
00409 
00410     ss-&gt;rq = rq;
00411     ss-&gt;rs = rs;
00412 
00413     <span class="comment">/* if the client has a SID set and it's a good one then use it */</span>
00414     sid = <a class="code" href="group__request.html#ga49">request_get_cookie</a>(ss-&gt;rq, ss-&gt;so-&gt;name);
00415     <span class="keywordflow">if</span>(sid)
00416         dbg_err_if(session_priv_set_id(ss, sid));
00417 
00418     <span class="keywordflow">return</span> 0;
00419 err:
00420     <span class="keywordflow">return</span> ~0;
00421 }
00422 
00423 <span class="keywordtype">int</span> session_prv_load_from_io(session_t *ss, io_t *io)
00424 {
00425     u_string_t *line = NULL;
00426     var_t *v = NULL;
00427     codec_t *unzip = NULL, *decrypt = NULL;
00428     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[CODEC_CIPHER_KEY_SIZE];
00429     size_t ksz;
00430 
00431     dbg_return_if (ss == NULL, ~0);
00432     dbg_return_if (io == NULL, ~0);
00433 
00434 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00435 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(ss-&gt;so-&gt;encrypt)
00436     {
00437         dbg_err_if(<a class="code" href="group__filters.html#ga0">codec_cipher_create</a>(CIPHER_DECRYPT, ss-&gt;so-&gt;cipher, 
00438             ss-&gt;so-&gt;cipher_key, ss-&gt;so-&gt;cipher_iv, &amp;decrypt)); 
00439         dbg_err_if(<a class="code" href="group__basic.html#ga32">io_codec_add_tail</a>(io, decrypt));
00440         decrypt = NULL; <span class="comment">/* io_t owns it after io_codec_add_tail */</span>
00441     }
00442 <span class="preprocessor">#else</span>
00443 <span class="preprocessor"></span>    u_unused_args(key, ksz);
00444 <span class="preprocessor">#endif</span>
00445 <span class="preprocessor"></span>
00446 <span class="preprocessor">#ifdef HAVE_LIBZ</span>
00447 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(ss-&gt;so-&gt;compress)
00448     {
00449         dbg_err_if(<a class="code" href="group__filters.html#ga2">codec_gzip_create</a>(GZIP_UNCOMPRESS, &amp;unzip));
00450         dbg_err_if(<a class="code" href="group__basic.html#ga32">io_codec_add_tail</a>(io, unzip));
00451         unzip = NULL; <span class="comment">/* io_t owns it after io_codec_add_tail */</span>
00452     }
00453 <span class="preprocessor">#endif</span>
00454 <span class="preprocessor"></span>
00455     dbg_err_if(u_string_create(NULL, 0, &amp;line));
00456 
00457     <span class="keywordflow">while</span>(<a class="code" href="group__ut.html#ga37">u_getline</a>(io, line) == 0)
00458     {
00459         <span class="keywordflow">if</span>(u_string_len(line))
00460         {
00461             dbg_err_if(vars_add_urlvar(ss-&gt;vars, u_string_c(line), &amp;v));
00462 
00463 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00464 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(!strcmp(var_get_name(v), <span class="stringliteral">"KLONE_CIPHER_KEY"</span>))
00465             {
00466                 <span class="comment">/* decrypt key and save it to key */</span>
00467                 memset(key, 0, <span class="keyword">sizeof</span>(key));
00468                 dbg_ifb(u_cipher_decrypt(EVP_aes_256_cbc(), ss-&gt;so-&gt;session_key,
00469                     ss-&gt;so-&gt;session_iv, key, &amp;ksz, 
00470                     var_get_value(v), var_get_value_size(v)))
00471                 {
00472                     v = vars_get(ss-&gt;vars, <span class="stringliteral">"KLONE_CIPHER_KEY"</span>);
00473                     vars_del(ss-&gt;vars, v);
00474                 } <span class="keywordflow">else</span> {
00475                     <span class="comment">/* save it to the var list */</span>
00476                     dbg_err_if(var_set_bin_value(v, key, ksz));
00477                 }
00478             }
00479 <span class="preprocessor">#endif</span>
00480 <span class="preprocessor"></span>        }
00481     }
00482 
00483     <span class="comment">/* remove set codecs and flush */</span>
00484     <a class="code" href="group__basic.html#ga33">io_codecs_remove</a>(io);
00485 
00486     u_string_free(line);
00487 
00488     <span class="keywordflow">return</span> 0;
00489 err:
00490     <span class="keywordflow">if</span>(io)
00491         <a class="code" href="group__basic.html#ga33">io_codecs_remove</a>(io);
00492     <span class="keywordflow">if</span>(decrypt)
00493         <a class="code" href="group__filters.html#ga9">codec_free</a>(decrypt);
00494     <span class="keywordflow">if</span>(unzip)
00495         <a class="code" href="group__filters.html#ga9">codec_free</a>(unzip);
00496     <span class="keywordflow">if</span>(line)
00497         u_string_free(line);
00498     <span class="keywordflow">return</span> ~0;
00499 }
00500 
00501 <span class="keywordtype">int</span> session_free(session_t *ss)
00502 {
00503     <span class="keywordflow">if</span> (ss)
00504     { 
00505         <span class="keywordflow">if</span>(!ss-&gt;removed)
00506             dbg_if(session_save(ss));
00507 
00508         <span class="comment">/* driver cleanup */</span>
00509         dbg_if(ss-&gt;term(ss));
00510 
00511         <span class="keywordflow">if</span>(ss-&gt;vars)
00512             vars_free(ss-&gt;vars);
00513 
00514         U_FREE(ss);
00515     }
00516 
00517     <span class="keywordflow">return</span> 0;
00518 }
00519 
<a name="l00530"></a><a class="code" href="group__session.html#ga5">00530</a> vars_t *<a class="code" href="group__session.html#ga5">session_get_vars</a>(session_t *ss)
00531 {
00532     dbg_return_if (ss == NULL, NULL);
00533 
00534     <span class="keywordflow">return</span> ss-&gt;vars;
00535 }
00536 
<a name="l00549"></a><a class="code" href="group__session.html#ga6">00549</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__session.html#ga6">session_get</a>(session_t *ss, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00550 {
00551     var_t *v;
00552 
00553     dbg_return_if (ss == NULL, NULL);
00554     dbg_return_if (name == NULL, NULL);
00555     
00556     v = vars_get(ss-&gt;vars, name);
00557     <span class="keywordflow">return</span> v ? var_get_value(v): NULL;
00558 }
00559 
<a name="l00570"></a><a class="code" href="group__session.html#ga7">00570</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="group__session.html#ga7">session_get_id</a> (session_t *ss)
00571 {
00572     dbg_return_if (ss == NULL, NULL);
00573 
00574     <span class="keywordflow">return</span> ss-&gt;id;
00575 }
00576 
<a name="l00589"></a><a class="code" href="group__session.html#ga8">00589</a> <span class="keywordtype">int</span> <a class="code" href="group__session.html#ga8">session_set</a>(session_t *ss, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
00590 {
00591     var_t *v = NULL;
00592 
00593     dbg_err_if (ss == NULL);
00594     dbg_err_if (name == NULL);
00595     dbg_err_if (value == NULL);
00596     dbg_err_if (strlen(name) == 0);
00597 
00598     <span class="keywordflow">if</span>((v = vars_get(ss-&gt;vars, name)) == NULL)
00599     {
00600         <span class="comment">/* add a new session variable */</span>
00601         dbg_err_if(var_create(name, value, &amp;v));
00602 
00603         dbg_err_if(vars_add(ss-&gt;vars, v));
00604     } <span class="keywordflow">else</span> {
00605         <span class="comment">/* update an existing var */</span>
00606         dbg_ifb(var_set_value(v, value))
00607             <span class="keywordflow">return</span> ~0;
00608     }
00609 
00610     <span class="keywordflow">return</span> 0;
00611 err:
00612     <span class="keywordflow">if</span>(v)
00613         var_free(v);
00614     <span class="keywordflow">return</span> ~0;
00615 }
00616 
<a name="l00629"></a><a class="code" href="group__session.html#ga4">00629</a> <span class="keywordtype">int</span> <a class="code" href="group__session.html#ga4">session_age</a>(session_t *ss)
00630 {
00631     time_t now;
00632 
00633     dbg_return_if (ss == NULL, -1);
00634 
00635     now = time(0);
00636 
00637     <span class="comment">/* ss-&gt;mtime must has been set into session_X_create funcs */</span>
00638     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(now - ss-&gt;mtime); <span class="comment">/* in seconds */</span>
00639 }
00640 
<a name="l00651"></a><a class="code" href="group__session.html#ga3">00651</a> <span class="keywordtype">int</span> <a class="code" href="group__session.html#ga3">session_clean</a>(session_t *ss)
00652 {
00653     var_t *v = NULL;
00654 
00655     dbg_err_if (ss == NULL);
00656 
00657     <span class="keywordflow">while</span>((v = vars_getn(ss-&gt;vars, 0)) != NULL)
00658     {
00659         dbg_err_if(vars_del(ss-&gt;vars, v));
00660         var_free(v);
00661     }
00662 
00663     <span class="keywordflow">return</span> 0;
00664 err:
00665     <span class="keywordflow">return</span> ~0;
00666 }
00667 
<a name="l00681"></a><a class="code" href="group__session.html#ga9">00681</a> <span class="keywordtype">int</span> <a class="code" href="group__session.html#ga9">session_del</a>(session_t *ss, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00682 {
00683     var_t *v = NULL;
00684 
00685     dbg_err_if (ss == NULL);
00686     dbg_err_if (name == NULL);
00687     
00688     dbg_err_if((v = vars_get(ss-&gt;vars, name)) == NULL);
00689     dbg_err_if(vars_del(ss-&gt;vars, v));
00690     var_free(v);
00691 
00692     <span class="keywordflow">return</span> 0;
00693 err:
00694     <span class="keywordflow">return</span> ~0;
00695 }
00696 
00697 <span class="keywordtype">int</span> session_prv_save_to_io(session_t *ss, io_t *out)
00698 {
00699     save_cb_params_t prm; 
00700     codec_t *zip = NULL, *cencrypt = NULL;
00701 
00702     dbg_err_if (ss == NULL);
00703     dbg_err_if (out == NULL);
00704 
00705 <span class="preprocessor">#ifdef HAVE_LIBZ</span>
00706 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(ss-&gt;so-&gt;compress)
00707     {
00708         dbg_err_if(<a class="code" href="group__filters.html#ga2">codec_gzip_create</a>(GZIP_COMPRESS, &amp;zip));
00709         dbg_err_if(<a class="code" href="group__basic.html#ga32">io_codec_add_tail</a>(out, zip));
00710         zip = NULL; <span class="comment">/* io_t owns it after io_codec_add_tail */</span>
00711     }
00712 <span class="preprocessor">#endif</span>
00713 <span class="preprocessor"></span>
00714 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00715 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(ss-&gt;so-&gt;encrypt)
00716     {
00717         dbg_err_if(<a class="code" href="group__filters.html#ga0">codec_cipher_create</a>(CIPHER_ENCRYPT, ss-&gt;so-&gt;cipher, 
00718             ss-&gt;so-&gt;cipher_key, ss-&gt;so-&gt;cipher_iv, &amp;cencrypt));
00719         dbg_err_if(<a class="code" href="group__basic.html#ga32">io_codec_add_tail</a>(out, cencrypt));
00720         cencrypt = NULL; <span class="comment">/* io_t owns it after io_codec_add_tail */</span>
00721     }
00722 <span class="preprocessor">#endif</span>
00723 <span class="preprocessor"></span>
00724     <span class="comment">/* pass io and session poiters to the callback function */</span>
00725     prm.io = out;
00726     prm.ss = ss;
00727 
00728     vars_foreach(ss-&gt;vars, session_prv_save_var, (<span class="keywordtype">void</span>*)&amp;prm);
00729 
00730     <span class="comment">/* remove all codecs and flush */</span>
00731     <a class="code" href="group__basic.html#ga33">io_codecs_remove</a>(out);
00732 
00733     <span class="keywordflow">return</span> 0;
00734 err:
00735     <span class="keywordflow">if</span>(out)
00736         <a class="code" href="group__basic.html#ga33">io_codecs_remove</a>(out);
00737     <span class="keywordflow">if</span>(zip)
00738         <a class="code" href="group__filters.html#ga9">codec_free</a>(zip);
00739     <span class="keywordflow">if</span>(cencrypt)
00740         <a class="code" href="group__filters.html#ga9">codec_free</a>(cencrypt);
00741     <span class="keywordflow">return</span> ~0;
00742 }
00743 
00744 <span class="comment">/* save a var_t (text or binary) to the session io_t */</span>
00745 <span class="keywordtype">int</span> session_prv_save_var(var_t *v, <span class="keywordtype">void</span> *vp)
00746 {
00747     <span class="keyword">enum</span> { NAMESZ = 256, VALSZ = 4096 };
00748     <span class="keywordtype">char</span> sname[NAMESZ], svalue[VALSZ];
00749     <span class="keywordtype">char</span> *uname = sname, *uvalue = svalue;
00750     save_cb_params_t *pprm = (save_cb_params_t*)vp;
00751     <span class="comment">/* encrypted key buffer */</span>
00752     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ekey[CODEC_CIPHER_KEY_SIZE + CODEC_CIPHER_BLOCK_SIZE + 1]; 
00753     size_t eksz, nsz, vsz;
00754     <span class="keywordtype">int</span> rc = ~0;
00755 
00756     dbg_err_if (v == NULL);
00757     <span class="comment">/* dbg_err_if (vp == NULL); */</span>
00758 
00759     <span class="comment">/* buffers must be at least three times the src data to URL-encode  */</span>
00760     nsz = 1 + 3 * strlen(var_get_name(v));  <span class="comment">/* name buffer size  */</span>
00761     vsz = 1 + 3 * var_get_value_size(v);    <span class="comment">/* value buffer size */</span>
00762 
00763 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00764 <span class="preprocessor"></span>    vsz += CODEC_CIPHER_BLOCK_SIZE; <span class="comment">/* encryption may enlarge the content up </span>
00765 <span class="comment">                                       to CODEC_CIPHER_BLOCK_SIZE -1         */</span>
00766 <span class="preprocessor">#else</span>
00767 <span class="preprocessor"></span>    u_unused_args(ekey, eksz);
00768 <span class="preprocessor">#endif</span>
00769 <span class="preprocessor"></span>
00770     <span class="comment">/* if the buffer on the stack is too small alloc a bigger one */</span>
00771     <span class="keywordflow">if</span>(NAMESZ &lt;= nsz)
00772         dbg_err_if((uname = u_zalloc(nsz)) == NULL);
00773 
00774     <span class="comment">/* url encode name */</span>
00775     dbg_err_if(<a class="code" href="group__ut.html#ga30">u_urlncpy</a>(uname, var_get_name(v), strlen(var_get_name(v)), 
00776         URLCPY_ENCODE) &lt;= 0);
00777 
00778     <span class="keywordflow">if</span>(var_get_value(v))
00779     {
00780         <span class="comment">/* if the buffer on the stack is too small alloc a bigger one */</span>
00781         <span class="keywordflow">if</span>(VALSZ &lt;= vsz)
00782             dbg_err_if((uvalue = u_zalloc(vsz)) == NULL);
00783 
00784 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00785 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(!strcmp(var_get_name(v), <span class="stringliteral">"KLONE_CIPHER_KEY"</span>))
00786         {
00787             <span class="comment">/* encrypt key and save it to ekey */</span>
00788             dbg_err_if(u_cipher_encrypt(EVP_aes_256_cbc(), 
00789                 pprm-&gt;ss-&gt;so-&gt;session_key, pprm-&gt;ss-&gt;so-&gt;session_iv, 
00790                 ekey, &amp;eksz, var_get_value(v), var_get_value_size(v)));
00791 
00792             <span class="comment">/* save it to the var list */</span>
00793             dbg_err_if(var_set_bin_value(v, ekey, eksz));
00794         }
00795 <span class="preprocessor">#endif</span>
00796 <span class="preprocessor"></span>
00797         dbg_err_if(<a class="code" href="group__ut.html#ga30">u_urlncpy</a>(uvalue, var_get_value(v), var_get_value_size(v), 
00798             URLCPY_ENCODE) &lt;= 0);
00799 
00800         dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(pprm-&gt;io, <span class="stringliteral">"%s=%s\n"</span>, uname, uvalue) &lt; 0);
00801     } <span class="keywordflow">else</span> 
00802         dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(pprm-&gt;io, <span class="stringliteral">"%s=\n"</span>, uname) &lt; 0);
00803 
00804     rc = 0; <span class="comment">/* success */</span>
00805 err:
00806     <span class="comment">/* free heap buffers */</span>
00807     <span class="keywordflow">if</span>(uname &amp;&amp; uname != sname)
00808         U_FREE(uname);
00809 
00810     <span class="keywordflow">if</span>(uvalue &amp;&amp; uvalue != svalue)
00811         U_FREE(uvalue);
00812 
00813     <span class="keywordflow">return</span> rc;
00814 }
00815 
00816 <span class="keywordtype">int</span> session_create(session_opt_t *so, request_t *rq, response_t *rs, 
00817     session_t **pss)
00818 {
00819     session_t *ss = NULL;
00820 
00821     dbg_err_if (so == NULL);
00822     dbg_err_if (rq == NULL);
00823     dbg_err_if (rs == NULL);
00824     dbg_err_if (pss == NULL);
00825 
00826     <span class="keywordflow">switch</span>(so-&gt;type)
00827     {
00828     <span class="keywordflow">case</span> SESSION_TYPE_FILE:
00829         dbg_err_if(session_file_create(so, rq, rs, &amp;ss));
00830         <span class="keywordflow">break</span>;
00831     <span class="keywordflow">case</span> SESSION_TYPE_MEMORY:
00832         dbg_err_if(session_mem_create(so, rq, rs, &amp;ss));
00833         <span class="keywordflow">break</span>;
00834 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00835 <span class="preprocessor"></span>    <span class="keywordflow">case</span> SESSION_TYPE_CLIENT:
00836         dbg_err_if(session_client_create(so, rq, rs, &amp;ss));
00837         <span class="keywordflow">break</span>;
00838 <span class="preprocessor">#endif</span>
00839 <span class="preprocessor"></span>    <span class="keywordflow">default</span>:
00840         warn_err(<span class="stringliteral">"bad session type"</span>);
00841     }
00842 
00843     <span class="comment">/* may fail if the session does not exist */</span>
00844     <span class="keywordflow">if</span>(ss-&gt;id[0] != 0)
00845     {
00846         session_load(ss);
00847 
00848         dbg_ifb(<a class="code" href="group__session.html#ga4">session_age</a>(ss) &gt; so-&gt;max_age)
00849         {
00850             <a class="code" href="group__session.html#ga3">session_clean</a>(ss);  <span class="comment">/* remove all session variables */</span>
00851             session_remove(ss); <span class="comment">/* remove the session itself    */</span>
00852         }
00853     } 
00854 
00855     *pss = ss;
00856 
00857     <span class="keywordflow">return</span> 0;
00858 err:
00859     <span class="keywordflow">if</span>(ss)
00860         session_free(ss);
00861     <span class="keywordflow">return</span> ~0;
00862 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


