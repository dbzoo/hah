<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: config.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>config.c</h1><div class="fragment"><pre>00001 <span class="comment">/* </span>
00002 <span class="comment"> * Copyright (c) 2005-2008 by KoanLogic s.r.l. - All rights reserved.  </span>
00003 <span class="comment"> */</span>
00004 
00005 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00006 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00007 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00008 <span class="preprocessor">#include &lt;string.h&gt;</span>
00009 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00010 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;toolbox/carpal.h&gt;</span>
00013 <span class="preprocessor">#include &lt;toolbox/queue.h&gt;</span>
00014 <span class="preprocessor">#include &lt;toolbox/list.h&gt;</span>
00015 <span class="preprocessor">#include &lt;toolbox/config.h&gt;</span>
00016 <span class="preprocessor">#include &lt;toolbox/misc.h&gt;</span>
00017 <span class="preprocessor">#include &lt;toolbox/memory.h&gt;</span>
00018 <span class="preprocessor">#include &lt;toolbox/str.h&gt;</span>
00019 
00032 TAILQ_HEAD(u_config_list_s, u_config_s);
00033 <span class="keyword">typedef</span> <span class="keyword">struct </span>u_config_list_s u_config_list_t;
00034 
00035 <span class="keyword">struct </span>u_config_s
00036 {
00037     TAILQ_ENTRY(u_config_s) np; <span class="comment">/* next &amp; prev pointers */</span>
00038     <span class="keywordtype">char</span> *key;                  <span class="comment">/* config item key name */</span>
00039     <span class="keywordtype">char</span> *value;                <span class="comment">/* config item value    */</span>
00040     u_config_list_t children;   <span class="comment">/* subkeys              */</span>
00041     u_config_t *parent;         <span class="comment">/* parent config obj    */</span>
00042 };
00043 
00044 <span class="comment">/* file system pre-defined driver */</span>
00045 <span class="keyword">extern</span> u_config_driver_t u_config_drv_fs;
00046 <span class="keyword">extern</span> u_config_driver_t u_config_drv_mem;
00047 
00048 <span class="comment">/* forward declarations */</span>
00049 <span class="keyword">static</span> <span class="keywordtype">int</span> u_config_include(u_config_t*, u_config_driver_t*, u_config_t*, <span class="keywordtype">int</span>);
00050 
<a name="l00065"></a><a class="code" href="group__config.html#ga5">00065</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga5">u_config_sort_children</a>(u_config_t *c, 
00066         <span class="keywordtype">int</span>(*config_cmp)(u_config_t**, u_config_t**))
00067 {
00068     u_config_t *child;
00069     <span class="keywordtype">int</span> i, count;
00070     u_config_t **children = NULL;
00071 
00072     <span class="comment">/* count children */</span>
00073     count = 0;
00074     TAILQ_FOREACH(child, &amp;c-&gt;children, np)
00075         count++;
00076 
00077     <span class="comment">/* create an array of pointers */</span>
00078     children = <a class="code" href="group__alloc.html#ga6">u_zalloc</a>(count * <span class="keyword">sizeof</span>(u_config_t*));
00079     dbg_err_if(children == NULL);
00080 
00081     <span class="comment">/* populate the array of children */</span>
00082     i = 0;
00083     TAILQ_FOREACH(child, &amp;c-&gt;children, np)
00084         children[i++] = child;
00085 
00086     <span class="comment">/* sort the list */</span>
00087     qsort(children, count, <span class="keyword">sizeof</span>(u_config_t*), 
00088             (<span class="keywordtype">int</span>(*)(<span class="keyword">const</span> <span class="keywordtype">void</span>*,<span class="keyword">const</span> <span class="keywordtype">void</span>*))config_cmp);
00089 
00090     <span class="comment">/* remove all items from the list */</span>
00091     <span class="keywordflow">while</span>((child = TAILQ_FIRST(&amp;c-&gt;children)) != NULL)
00092         TAILQ_REMOVE(&amp;c-&gt;children, child, np);
00093 
00094     <span class="comment">/* reinsert sorted items */</span>
00095     <span class="keywordflow">for</span>(i = 0; i &lt; count; ++i)
00096         TAILQ_INSERT_TAIL(&amp;c-&gt;children, children[i], np);
00097 
00098     U_FREE(children);
00099 
00100     <span class="keywordflow">return</span> 0;
00101 err:
00102     <span class="keywordflow">if</span>(children)
00103         <a class="code" href="group__alloc.html#ga8">u_free</a>(children);
00104     <span class="keywordflow">return</span> ~0;
00105 }
00106 
<a name="l00119"></a><a class="code" href="group__config.html#ga6">00119</a> <span class="keywordtype">void</span> <a class="code" href="group__config.html#ga6">u_config_print_to_fp</a>(u_config_t *c, FILE *fp, <span class="keywordtype">int</span> lev)
00120 {
00121     u_config_t *item;
00122     <span class="keywordtype">int</span> i;
00123 
00124     <span class="keywordflow">for</span>(i = 0; i &lt; lev; ++i)
00125         fprintf(fp, <span class="stringliteral">"  "</span>);
00126 
00127     <span class="keywordflow">if</span> (c-&gt;key)
00128         fprintf(fp, <span class="stringliteral">"%s  %s\n"</span>, c-&gt;key, c-&gt;value == NULL ? <span class="stringliteral">""</span> : c-&gt;value);
00129 
00130     ++lev;
00131     TAILQ_FOREACH(item, &amp;c-&gt;children, np)
00132         <a class="code" href="group__config.html#ga6">u_config_print_to_fp</a>(item, fp, lev);
00133 }
00134 
<a name="l00146"></a><a class="code" href="group__config.html#ga7">00146</a> <span class="keywordtype">void</span> <a class="code" href="group__config.html#ga7">u_config_print</a>(u_config_t *c, <span class="keywordtype">int</span> lev)
00147 {
00148     <a class="code" href="group__config.html#ga6">u_config_print_to_fp</a>(c, stdout, lev);
00149     <span class="keywordflow">return</span>;
00150 }
00151 
00152 <span class="keywordtype">int</span> u_config_add_child(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *key, u_config_t **pc)
00153 {
00154     u_config_t *child = NULL;
00155 
00156     dbg_err_if(<a class="code" href="group__config.html#ga24">u_config_create</a>(&amp;child));
00157 
00158     child-&gt;parent = c;
00159     child-&gt;key = <a class="code" href="group__misc.html#ga5">u_strdup</a>(key);
00160     dbg_err_if(child-&gt;key == NULL);
00161 
00162     TAILQ_INSERT_TAIL(&amp;c-&gt;children, child, np);
00163 
00164     *pc = child;
00165 
00166     <span class="keywordflow">return</span> 0;
00167 err:
00168     <span class="keywordflow">return</span> ~0;
00169 }
00170 
00171 <span class="comment">/* get n-th child item called key */</span>
00172 u_config_t* u_config_get_child_n(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *key, <span class="keywordtype">int</span> n)
00173 {
00174     u_config_t *item;
00175 
00176     TAILQ_FOREACH(item, &amp;c-&gt;children, np)
00177     {
00178         <span class="keywordflow">if</span>((key == NULL || strcmp(item-&gt;key, key) == 0) &amp;&amp; n-- == 0)
00179             <span class="keywordflow">return</span> item;  <span class="comment">/* found */</span>
00180     }
00181 
00182     <span class="keywordflow">return</span> NULL; <span class="comment">/* not found */</span>
00183 }
00184 
00185 u_config_t* u_config_get_child(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *key)
00186 {
00187     <span class="keywordflow">return</span> u_config_get_child_n(c, key, 0);
00188 }
00189 
00190 <span class="keywordtype">int</span> u_config_get_subkey_nth(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *subkey, <span class="keywordtype">int</span> n, 
00191     u_config_t **pc)
00192 {
00193     u_config_t *child = NULL;
00194     <span class="keywordtype">char</span> *first_key = NULL, *p;
00195 
00196     <span class="keywordflow">if</span>((p = strchr(subkey, <span class="charliteral">'.'</span>)) == NULL)
00197     {
00198         <span class="keywordflow">if</span>((child = u_config_get_child_n(c, subkey, n)) != NULL)
00199         {
00200             *pc = child;
00201             <span class="keywordflow">return</span> 0;
00202         } 
00203     } <span class="keywordflow">else</span> {
00204         <span class="keywordflow">if</span>((first_key = <a class="code" href="group__misc.html#ga4">u_strndup</a>(subkey, p-subkey)) != NULL)
00205         {
00206             child = u_config_get_child(c, first_key);
00207             U_FREE(first_key);
00208         }
00209         <span class="keywordflow">if</span>(child != NULL)
00210             <span class="keywordflow">return</span> u_config_get_subkey(child, ++p, pc);
00211     }
00212     <span class="keywordflow">return</span> ~0; <span class="comment">/* not found */</span>
00213 
00214 }
00215 
00216 <span class="keywordtype">int</span> u_config_get_subkey(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *subkey, u_config_t **pc)
00217 {
00218     <span class="keywordflow">return</span> u_config_get_subkey_nth(c, subkey, 0, pc);
00219 }
00220 
00221 <span class="keyword">static</span> u_config_t* u_config_get_root(u_config_t *c)
00222 {
00223     <span class="keywordflow">while</span>(c-&gt;parent)
00224         c = c-&gt;parent;
00225     <span class="keywordflow">return</span> c;
00226 }
00227 
00228 <span class="keywordtype">int</span> u_config_set_value(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *val)
00229 {
00230     u_config_t *root, *ignore;
00231     <span class="keyword">const</span> <span class="keywordtype">char</span> *varval, *vs, *ve, *p;
00232     u_string_t *var = NULL, *value = NULL;
00233 
00234     dbg_err_if(c == NULL);
00235 
00236     <span class="comment">/* free() previous value if any */</span>
00237     <span class="keywordflow">if</span>(c-&gt;value)
00238     {
00239         U_FREE(c-&gt;value);
00240         c-&gt;value = NULL;
00241     } 
00242 
00243     <span class="keywordflow">if</span>(val)
00244     {
00245         dbg_err_if(<a class="code" href="group__string.html#ga9">u_string_create</a>(NULL, 0, &amp;var));
00246         dbg_err_if(<a class="code" href="group__string.html#ga9">u_string_create</a>(NULL, 0, &amp;value));
00247 
00248         root = u_config_get_root(c);
00249         dbg_err_if(root == NULL);
00250 
00251         <span class="comment">/* search and replace ${variables} */</span>
00252         vs = ve = val;
00253         <span class="keywordflow">for</span>(; vs &amp;&amp; *vs &amp;&amp; (p = strstr(vs, <span class="stringliteral">"${"</span>)) != NULL; vs = ++ve)
00254         {   <span class="comment">/* variable substituion */</span>
00255             dbg_err_if(<a class="code" href="group__string.html#ga14">u_string_append</a>(value, vs, p-vs));
00256 
00257             <span class="comment">/* skip ${ */</span>
00258             vs = p+2;               
00259 
00260             <span class="comment">/* look for closig bracket */</span>
00261             ve = strchr(vs, <span class="charliteral">'}'</span>);
00262             dbg_err_if(ve == NULL); <span class="comment">/* closing bracket missing */</span>
00263 
00264             <span class="comment">/* get the variable name/path */</span>
00265             dbg_err_if(<a class="code" href="group__string.html#ga11">u_string_set</a>(var, vs, ve-vs));
00266 
00267             <span class="comment">/* first see if the variable can be resolved in the local scope</span>
00268 <span class="comment">               otherwise resolve it from the root */</span>
00269             root = c-&gt;parent;
00270             <span class="keywordflow">if</span>(u_config_get_subkey(root, <a class="code" href="group__string.html#ga6">u_string_c</a>(var), &amp;ignore))
00271                 root = u_config_get_root(c);
00272             dbg_err_if(root == NULL);
00273 
00274             <span class="comment">/* append the variable value */</span>
00275             varval = <a class="code" href="group__config.html#ga29">u_config_get_subkey_value</a>(root, <a class="code" href="group__string.html#ga6">u_string_c</a>(var));
00276             <span class="keywordflow">if</span>(varval != NULL)
00277                 dbg_err_if(<a class="code" href="group__string.html#ga14">u_string_append</a>(value, varval, strlen(varval)));
00278         }
00279         <span class="keywordflow">if</span>(ve &amp;&amp; *ve)
00280             dbg_err_if(<a class="code" href="group__string.html#ga14">u_string_append</a>(value, ve, strlen(ve)));
00281 
00282         <a class="code" href="group__string.html#ga3">u_string_trim</a>(value); <span class="comment">/* remove leading and trailing spaces */</span>
00283 
00284         c-&gt;value = <a class="code" href="group__misc.html#ga5">u_strdup</a>(<a class="code" href="group__string.html#ga6">u_string_c</a>(value));;
00285         dbg_err_if(c-&gt;value == NULL);
00286 
00287         <a class="code" href="group__string.html#ga10">u_string_free</a>(value);
00288         <a class="code" href="group__string.html#ga10">u_string_free</a>(var);
00289     }
00290 
00291     <span class="keywordflow">return</span> 0;
00292 err:
00293     <span class="keywordflow">if</span>(value)
00294         <a class="code" href="group__string.html#ga10">u_string_free</a>(value);
00295     <span class="keywordflow">if</span>(var)
00296         <a class="code" href="group__string.html#ga10">u_string_free</a>(var);
00297     <span class="keywordflow">return</span> ~0;
00298 }
00299 
00300 <span class="keyword">static</span> <span class="keywordtype">int</span> u_config_do_set_key(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *val, 
00301     <span class="keywordtype">int</span> overwrite, u_config_t **pchild)
00302 {
00303     u_config_t *child = NULL;
00304     <span class="keywordtype">char</span> *p, *child_key;
00305 
00306     <span class="keywordflow">if</span>((p = strchr(key, <span class="charliteral">'.'</span>)) == NULL)
00307     {
00308         child = u_config_get_child(c, key);
00309         <span class="keywordflow">if</span>(child == NULL || !overwrite)
00310         {   <span class="comment">/* there's no such child, add a new child */</span>
00311             dbg_err_if(u_config_add_child(c, key, &amp;child));
00312         } 
00313         dbg_err_if(u_config_set_value(child, val));
00314 
00315         <span class="comment">/* return the child we just added/modified */</span>
00316         <span class="keywordflow">if</span>(pchild)
00317             *pchild = child;
00318     } <span class="keywordflow">else</span> {
00319         child_key = <a class="code" href="group__misc.html#ga4">u_strndup</a>(key, p-key);
00320         dbg_err_if(child_key == NULL);
00321         <span class="keywordflow">if</span>((child = u_config_get_child(c, child_key)) == NULL)
00322             dbg_err_if(u_config_add_child(c, child_key, &amp;child));
00323         U_FREE(child_key);
00324         <span class="keywordflow">return</span> u_config_do_set_key(child, ++p, val, overwrite, NULL);
00325     }
00326     <span class="keywordflow">return</span> 0;
00327 err:
00328     <span class="keywordflow">return</span> ~0;
00329 }
00330 
00331 <span class="keywordtype">int</span> u_config_add_key(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *val)
00332 {
00333     <span class="keywordflow">return</span> u_config_do_set_key(c, key, val, 0 <span class="comment">/* don't overwrite */</span>, NULL);
00334 }
00335 
00336 <span class="keywordtype">int</span> u_config_set_key(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *val)
00337 {
00338     <span class="keywordflow">return</span> u_config_do_set_key(c, key, val, 1 <span class="comment">/* overwrite */</span>, NULL);
00339 }
00340 
00341 <span class="keyword">static</span> <span class="keywordtype">int</span> cs_getline(u_config_gets_t cb, <span class="keywordtype">void</span> *arg, u_string_t *ln)
00342 {
00343     <span class="keyword">enum</span> { BUFSZ = 1024 };
00344     <span class="keywordtype">char</span> buf[BUFSZ], *p = NULL;
00345     ssize_t len;
00346 
00347     <a class="code" href="group__string.html#ga8">u_string_clear</a>(ln);
00348 
00349     <span class="keywordflow">while</span>((p = cb(arg, buf, BUFSZ)) != NULL)
00350     {
00351         len = strlen(buf);
00352         <span class="keywordflow">if</span>(len == 0)
00353             <span class="keywordflow">break</span>; <span class="comment">/* empty line */</span>
00354         dbg_err_if(<a class="code" href="group__string.html#ga14">u_string_append</a>(ln, buf, --len));
00355         <span class="keywordflow">if</span>(!<a class="code" href="group__misc.html#ga3">u_isnl</a>(buf[len]))
00356             <span class="keywordflow">continue</span>; <span class="comment">/* line's longer the bufsz (or eof);get next line chunk */</span>
00357         <span class="keywordflow">else</span>
00358             <span class="keywordflow">break</span>;
00359     }
00360 
00361     nop_err_if(p == NULL); <span class="comment">/* eof */</span>
00362 
00363     <span class="keywordflow">return</span> 0;
00364 err:
00365     <span class="keywordflow">return</span> ~0;
00366 }
00367 
00368 <span class="keyword">static</span> <span class="keywordtype">int</span> u_config_do_load_drv(u_config_t *c, u_config_driver_t *drv, 
00369         <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> overwrite)
00370 {
00371     <span class="keyword">enum</span> { MAX_NEST_LEV = 20 };
00372     u_string_t *line = NULL, *key = NULL, *lastkey = NULL, *value = NULL;
00373     <span class="keyword">const</span> <span class="keywordtype">char</span> *ln, *p;
00374     size_t len;
00375     <span class="keywordtype">int</span> lineno = 1;
00376     u_config_t *child = NULL;
00377     u_config_t *subkey;
00378 
00379     dbg_err_if(<a class="code" href="group__string.html#ga9">u_string_create</a>(NULL, 0, &amp;line));
00380     dbg_err_if(<a class="code" href="group__string.html#ga9">u_string_create</a>(NULL, 0, &amp;key));
00381     dbg_err_if(<a class="code" href="group__string.html#ga9">u_string_create</a>(NULL, 0, &amp;value));
00382     dbg_err_if(<a class="code" href="group__string.html#ga9">u_string_create</a>(NULL, 0, &amp;lastkey));
00383 
00384     dbg_err_if(drv-&gt;gets == NULL);
00385 
00386     <span class="keywordflow">for</span>(; cs_getline(drv-&gt;gets, arg, line) == 0; <a class="code" href="group__string.html#ga8">u_string_clear</a>(line), ++lineno)
00387     {
00388         <span class="comment">/* remove comments if any */</span>
00389         <span class="keywordflow">if</span>((p = strchr(<a class="code" href="group__string.html#ga6">u_string_c</a>(line), <span class="charliteral">'#'</span>)) != NULL)
00390             dbg_err_if(<a class="code" href="group__string.html#ga4">u_string_set_length</a>(line, p - <a class="code" href="group__string.html#ga6">u_string_c</a>(line)));
00391 
00392         <span class="comment">/* remove leading and trailing blanks */</span>
00393         dbg_err_if(<a class="code" href="group__string.html#ga3">u_string_trim</a>(line));
00394 
00395         ln = <a class="code" href="group__string.html#ga6">u_string_c</a>(line);
00396         len = <a class="code" href="group__string.html#ga5">u_string_len</a>(line);
00397 
00398         <span class="comment">/* remove trailing nl(s) */</span>
00399         <span class="keywordflow">while</span>(len &amp;&amp; <a class="code" href="group__misc.html#ga3">u_isnl</a>(ln[len-1]))
00400             <a class="code" href="group__string.html#ga4">u_string_set_length</a>(line, --len);
00401 
00402         <span class="keywordflow">if</span>(len == 0)
00403             <span class="keywordflow">continue</span>; <span class="comment">/* empty line */</span>
00404 
00405         <span class="comment">/* eat leading blanks */</span>
00406         <span class="keywordflow">for</span>(; <a class="code" href="group__misc.html#ga0">u_isblank</a>(*ln); ++ln);
00407 
00408         <span class="keywordflow">if</span>(ln[0] == <span class="charliteral">'{'</span>)
00409         {   <span class="comment">/* group config values */</span>
00410             <span class="keywordflow">if</span>(<a class="code" href="group__string.html#ga5">u_string_len</a>(lastkey) == 0)
00411                 crit_err(<span class="stringliteral">"config error [line %d]: { not after a no-value key"</span>, 
00412                          lineno);
00413             <span class="keywordflow">if</span>(!<a class="code" href="group__misc.html#ga2">u_isblank_str</a>(++ln))
00414                 crit_err(<span class="stringliteral">"config error [line %d]: { or } must be the "</span>
00415                          <span class="stringliteral">"only not-blank char in a line"</span>, lineno);
00416 
00417             <span class="comment">/* modify the existing child (when overwriting) or add a new one */</span>
00418             <span class="keywordflow">if</span>(!overwrite || 
00419                (child = u_config_get_child(c, <a class="code" href="group__string.html#ga6">u_string_c</a>(lastkey))) == NULL)
00420             {
00421                 dbg_err_if(u_config_add_child(c, <a class="code" href="group__string.html#ga6">u_string_c</a>(lastkey), &amp;child));
00422             }
00423 
00424             dbg_err_if(u_config_do_load_drv(child, drv, arg, overwrite));
00425 
00426             dbg_err_if(<a class="code" href="group__string.html#ga8">u_string_clear</a>(lastkey));
00427 
00428             <span class="keywordflow">continue</span>;
00429         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ln[0] == <span class="charliteral">'}'</span>) {
00430             crit_err_ifm(c-&gt;parent == NULL,<span class="stringliteral">"config error: unmatched '}'"</span>);
00431             <span class="keywordflow">if</span>(!<a class="code" href="group__misc.html#ga2">u_isblank_str</a>(++ln))
00432                 dbg_err(<span class="stringliteral">"config error [line %d]: { or } must be the "</span>
00433                          <span class="stringliteral">"only not-blank char in a line"</span>, lineno);
00434             <span class="keywordflow">break</span>; <span class="comment">/* exit */</span>
00435         }
00436 
00437         <span class="comment">/* find the end of the key string */</span>
00438         <span class="keywordflow">for</span>(p = ln; *p &amp;&amp; !<a class="code" href="group__misc.html#ga0">u_isblank</a>(*p); ++p);
00439 
00440         <span class="comment">/* set the key */</span>
00441         dbg_err_if(<a class="code" href="group__string.html#ga11">u_string_set</a>(key, ln, p-ln));
00442 
00443         <span class="comment">/* set the value */</span>
00444         dbg_err_if(<a class="code" href="group__string.html#ga11">u_string_set</a>(value, p, strlen(p)));
00445         dbg_err_if(<a class="code" href="group__string.html#ga3">u_string_trim</a>(value));
00446 
00447         <span class="keywordflow">if</span>(!strcmp(<a class="code" href="group__string.html#ga6">u_string_c</a>(key), <span class="stringliteral">"include"</span>) ||       <span class="comment">/* forced dependency */</span>
00448                 !strcmp(<a class="code" href="group__string.html#ga6">u_string_c</a>(key), <span class="stringliteral">"-include"</span>))   <span class="comment">/* optional dependency */</span>
00449         {
00450             crit_err_ifm(<a class="code" href="group__string.html#ga5">u_string_len</a>(value) == 0, <span class="stringliteral">"missing include filename"</span>);
00451 
00452             <span class="comment">/* add to the include key to the list to resolve ${} vars */</span>
00453             dbg_err_if(u_config_do_set_key(c, <a class="code" href="group__string.html#ga6">u_string_c</a>(key), 
00454                         <a class="code" href="group__string.html#ga6">u_string_c</a>(value), 0, &amp;subkey));
00455 
00456             <span class="comment">/* load the included file */</span>
00457             <span class="keywordflow">if</span> (<a class="code" href="group__string.html#ga6">u_string_c</a>(key)[0] == <span class="charliteral">'-'</span>)  <span class="comment">/* failure is not critical */</span>
00458                 dbg_if(u_config_include(c, drv, subkey, overwrite));
00459             <span class="keywordflow">else</span>                            <span class="comment">/* failure is critical */</span>
00460                 dbg_err_if(u_config_include(c, drv, subkey, overwrite));
00461         } 
00462 
00463         <span class="comment">/* if the valus is empty an open bracket will follow, save the key */</span>
00464         <span class="keywordflow">if</span>(<a class="code" href="group__string.html#ga5">u_string_len</a>(value) == 0)
00465         {
00466             dbg_err_if(<a class="code" href="group__string.html#ga11">u_string_set</a>(lastkey, ln, p-ln));
00467             <span class="keywordflow">continue</span>;
00468         }
00469 
00470         <span class="comment">/* add to the var list */</span>
00471         dbg_err_if(u_config_do_set_key(c, 
00472                         <a class="code" href="group__string.html#ga6">u_string_c</a>(key), 
00473                         <a class="code" href="group__string.html#ga5">u_string_len</a>(value) ? <a class="code" href="group__string.html#ga6">u_string_c</a>(value) : NULL, 
00474                         overwrite, NULL));
00475 
00476     }
00477     
00478     <a class="code" href="group__string.html#ga10">u_string_free</a>(lastkey);
00479     <a class="code" href="group__string.html#ga10">u_string_free</a>(value);
00480     <a class="code" href="group__string.html#ga10">u_string_free</a>(key);
00481     <a class="code" href="group__string.html#ga10">u_string_free</a>(line);
00482 
00483     <span class="keywordflow">return</span> 0;
00484 err:
00485     <span class="keywordflow">if</span>(lastkey)
00486         <a class="code" href="group__string.html#ga10">u_string_free</a>(lastkey);
00487     <span class="keywordflow">if</span>(key)
00488         <a class="code" href="group__string.html#ga10">u_string_free</a>(key);
00489     <span class="keywordflow">if</span>(value)
00490         <a class="code" href="group__string.html#ga10">u_string_free</a>(value);
00491     <span class="keywordflow">if</span>(line)
00492         <a class="code" href="group__string.html#ga10">u_string_free</a>(line);
00493     <span class="keywordflow">return</span> ~0;
00494 }
00495 
00496 <span class="keyword">static</span> <span class="keywordtype">int</span> u_config_include(u_config_t *c, u_config_driver_t *drv, 
00497         u_config_t *inckey, <span class="keywordtype">int</span> overwrite)
00498 {
00499     u_config_t *subkey;
00500     <span class="keywordtype">int</span> i;
00501     <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *path;
00502     <span class="keywordtype">void</span> *arg = NULL;
00503     <span class="keywordtype">char</span> uri[U_FILENAME_MAX + 1];
00504 
00505     dbg_err_if(c == NULL);
00506 
00507     path = <a class="code" href="group__config.html#ga28">u_config_get_value</a>(inckey);
00508     dbg_err_if(path == NULL);
00509 
00510     <span class="keywordflow">for</span>(i = 0; u_config_get_subkey_nth(c, <span class="stringliteral">"include"</span>, i, &amp;subkey) == 0; ++i)
00511     {
00512         <span class="keywordflow">if</span>(subkey != inckey &amp;&amp; !strcmp(path, <a class="code" href="group__config.html#ga28">u_config_get_value</a>(subkey)))
00513             crit_err(<span class="stringliteral">"circular dependency error loading %s"</span>, path);
00514     }
00515 
00516     <span class="comment">/* find the end of the key string */</span>
00517     <span class="keywordflow">for</span>(p = path; *p &amp;&amp; <a class="code" href="group__misc.html#ga0">u_isblank</a>(*p); ++p);
00518 
00519     dbg_err_if(p == NULL);
00520 
00521     crit_err_ifm ( drv-&gt;open == NULL,
00522         <span class="stringliteral">"'include' feature used but the 'open' driver callback is not defined"</span>);
00523 
00524     <span class="comment">/* resolv the include filename */</span>
00525     <span class="keywordflow">if</span>(drv-&gt;resolv)
00526     {
00527         dbg_err_if (drv-&gt;resolv(p, uri, <span class="keyword">sizeof</span>(uri)));
00528 
00529         p = uri;
00530     } 
00531 
00532     crit_err_ifm (drv-&gt;open(p, &amp;arg),
00533         <span class="stringliteral">"unable to access input file: %s"</span>, p);
00534 
00535     dbg_err_if (u_config_do_load_drv(c, drv, arg, overwrite));
00536 
00537     <span class="keywordflow">if</span>(drv-&gt;close)
00538         crit_err_ifm (drv-&gt;close(arg),
00539             <span class="stringliteral">"unable to close input file: %s"</span>, p);
00540     <span class="keywordflow">else</span>
00541         warn(<span class="stringliteral">"the 'close' driver callback is not defined, not closing..."</span>);
00542 
00543     <span class="keywordflow">return</span> 0;
00544 err:
00545     <span class="keywordflow">if</span>(arg &amp;&amp; drv-&gt;close)
00546         drv-&gt;close(arg);
00547     <span class="keywordflow">return</span> ~0;
00548 }
00549 
00559 <span class="keyword">static</span> <span class="keywordtype">void</span> u_config_del_key(u_config_t *c, u_config_t *child)
00560 {
00561     TAILQ_REMOVE(&amp;c-&gt;children, child, np);
00562 }
00563 
<a name="l00579"></a><a class="code" href="group__config.html#ga21">00579</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga21">u_config_load_from</a>(u_config_t *c, u_config_gets_t cb, 
00580     <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> overwrite)
00581 {
00582     u_config_driver_t drv = { NULL, NULL, cb, NULL };
00583 
00584     dbg_err_if(u_config_do_load_drv(c, &amp;drv, arg, overwrite));
00585 
00586     <span class="keywordflow">return</span> 0;
00587 err:
00588     <span class="keywordflow">return</span> ~0;
00589 }
00590 
<a name="l00606"></a><a class="code" href="group__config.html#ga22">00606</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga22">u_config_load</a>(u_config_t *c, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> overwrite)
00607 {
00608     FILE *file = NULL;
00609 
00610     <span class="comment">/* must dup because fclose() calls close(2) on fd */</span>
00611     file = fdopen(dup(fd), <span class="stringliteral">"r"</span>);
00612     dbg_err_if(file == NULL);
00613 
00614     dbg_err_if(u_config_do_load_drv(c, &amp;u_config_drv_fs, file, overwrite));
00615 
00616     fclose(file);
00617 
00618     <span class="keywordflow">return</span> 0;
00619 err:
00620     U_FCLOSE(file);
00621     <span class="keywordflow">return</span> ~0;
00622 }
00623 
<a name="l00634"></a><a class="code" href="group__config.html#ga23">00634</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga23">u_config_load_from_file</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *file, u_config_t **pc)
00635 {
00636     dbg_return_if (file == NULL, ~0);
00637     dbg_return_if (pc == NULL, ~0);
00638 
00639     dbg_err_if (u_config_load_from_drv(file, &amp;u_config_drv_fs, 0, pc));
00640 
00641     <span class="keywordflow">return</span> 0;
00642 err:
00643     <span class="keywordflow">return</span> ~0;
00644 }
00645 
<a name="l00656"></a><a class="code" href="group__config.html#ga24">00656</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga24">u_config_create</a>(u_config_t **pc)
00657 {
00658     u_config_t *c = NULL;
00659 
00660     c = <a class="code" href="group__alloc.html#ga6">u_zalloc</a>(<span class="keyword">sizeof</span>(u_config_t));
00661     dbg_err_if(c == NULL);
00662 
00663     TAILQ_INIT(&amp;c-&gt;children);
00664 
00665     *pc = c;
00666 
00667     <span class="keywordflow">return</span> 0;
00668 err:
00669     <span class="keywordflow">if</span>(c)
00670         <a class="code" href="group__config.html#ga26">u_config_free</a>(c);
00671     <span class="keywordflow">return</span> ~0;
00672 }
00673 
<a name="l00684"></a><a class="code" href="group__config.html#ga25">00684</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga25">u_config_del_child</a>(u_config_t *c, u_config_t *child)
00685 {
00686     u_config_t *item;
00687 
00688     TAILQ_FOREACH(item, &amp;c-&gt;children, np)
00689     {
00690         <span class="keywordflow">if</span>(item == child)
00691         {   <span class="comment">/* found */</span>
00692             u_config_del_key(c, child);
00693             dbg_err_if(<a class="code" href="group__config.html#ga26">u_config_free</a>(child));
00694             <span class="keywordflow">return</span> 0;
00695         }
00696     }
00697 
00698 err:
00699     <span class="keywordflow">return</span> ~0;
00700 }
00701 
<a name="l00711"></a><a class="code" href="group__config.html#ga26">00711</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga26">u_config_free</a>(u_config_t *c)
00712 {
00713     u_config_t *child = NULL;
00714     <span class="keywordflow">if</span>(c)
00715     {
00716         <span class="comment">/* free all children */</span>
00717         <span class="keywordflow">while</span>((child = TAILQ_FIRST(&amp;c-&gt;children)) != NULL)
00718         {
00719             u_config_del_key(c, child);
00720             dbg_err_if(<a class="code" href="group__config.html#ga26">u_config_free</a>(child));
00721         }
00722         <span class="comment">/* free parent */</span>
00723         <span class="keywordflow">if</span>(c-&gt;key)
00724             U_FREE(c-&gt;key);
00725         <span class="keywordflow">if</span>(c-&gt;value)
00726             U_FREE(c-&gt;value);
00727         U_FREE(c);
00728     }
00729     <span class="keywordflow">return</span> 0;
00730 err:
00731     <span class="keywordflow">return</span> ~0;
00732 }
00733 
<a name="l00743"></a><a class="code" href="group__config.html#ga27">00743</a> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="group__config.html#ga27">u_config_get_key</a>(u_config_t *c)
00744 {
00745     dbg_err_if(!c);
00746 
00747     <span class="keywordflow">return</span> c-&gt;key;
00748 err:
00749     <span class="keywordflow">return</span> NULL;
00750 }
00751 
<a name="l00761"></a><a class="code" href="group__config.html#ga28">00761</a> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="group__config.html#ga28">u_config_get_value</a>(u_config_t *c)
00762 {
00763     dbg_err_if(!c);
00764     
00765     <span class="keywordflow">return</span> c-&gt;value;
00766 err:
00767     <span class="keywordflow">return</span> NULL;
00768 }
00769 
<a name="l00780"></a><a class="code" href="group__config.html#ga29">00780</a> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="group__config.html#ga29">u_config_get_subkey_value</a>(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *subkey)
00781 {
00782     u_config_t *skey;
00783 
00784     nop_err_if(u_config_get_subkey(c, subkey, &amp;skey));
00785 
00786     <span class="keywordflow">return</span> <a class="code" href="group__config.html#ga28">u_config_get_value</a>(skey);
00787 err:
00788     <span class="keywordflow">return</span> NULL;
00789 }
00790 
<a name="l00804"></a><a class="code" href="group__config.html#ga30">00804</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga30">u_config_get_subkey_value_i</a>(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *subkey, <span class="keywordtype">int</span> def, 
00805     <span class="keywordtype">int</span> *out)
00806 {
00807     <span class="keyword">const</span> <span class="keywordtype">char</span> *v;
00808     <span class="keywordtype">char</span> *ep = NULL;
00809     <span class="keywordtype">long</span> l;
00810 
00811     <span class="keywordflow">if</span>((v = <a class="code" href="group__config.html#ga29">u_config_get_subkey_value</a>(c, subkey)) == NULL)
00812     {
00813         *out = def; 
00814         <span class="keywordflow">return</span> 0;
00815     }
00816 
00817     l = strtol(v, &amp;ep, 0);
00818     dbg_err_if(*ep != <span class="charliteral">'\0'</span>); <span class="comment">/* dirty int value (for ex. 123text) */</span>
00819 
00820     <span class="comment">/* same cast used by atoi */</span>
00821     *out = (<span class="keywordtype">int</span>)l;
00822 
00823     <span class="keywordflow">return</span> 0;
00824 err:
00825     <span class="keywordflow">return</span> ~0;
00826 }
00827 
<a name="l00842"></a><a class="code" href="group__config.html#ga31">00842</a> <span class="keywordtype">int</span> <a class="code" href="group__config.html#ga31">u_config_get_subkey_value_b</a>(u_config_t *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *subkey, <span class="keywordtype">int</span> def,  
00843     <span class="keywordtype">int</span> *out)
00844 {
00845     <span class="keyword">const</span> <span class="keywordtype">char</span> *true_words[]  = { <span class="stringliteral">"yes"</span>, <span class="stringliteral">"enable"</span>, <span class="stringliteral">"1"</span>, <span class="stringliteral">"on"</span>, NULL };
00846     <span class="keyword">const</span> <span class="keywordtype">char</span> *false_words[] = { <span class="stringliteral">"no"</span>, <span class="stringliteral">"disable"</span>, <span class="stringliteral">"0"</span>, <span class="stringliteral">"off"</span>, NULL };
00847     <span class="keyword">const</span> <span class="keywordtype">char</span> *v, *w;
00848     <span class="keywordtype">int</span> i;
00849 
00850     <span class="keywordflow">if</span>((v = <a class="code" href="group__config.html#ga29">u_config_get_subkey_value</a>(c, subkey)) == NULL)
00851     {
00852         *out = def;
00853         <span class="keywordflow">return</span> 0;
00854     }
00855 
00856     <span class="keywordflow">for</span>(i = 0; (w = true_words[i]) != NULL; ++i)
00857     {
00858         <span class="keywordflow">if</span>(!strcasecmp(v, w))
00859         {
00860             *out = 1;
00861             <span class="keywordflow">return</span> 0; <span class="comment">/* ok */</span>
00862         }
00863     }
00864 
00865     <span class="keywordflow">for</span>(i = 0; (w = false_words[i]) != NULL; ++i)
00866     {
00867         <span class="keywordflow">if</span>(!strcasecmp(v, w))
00868         {
00869             *out = 0;
00870             <span class="keywordflow">return</span> 0; <span class="comment">/* ok */</span>
00871         }
00872     }
00873 
00874     <span class="keywordflow">return</span> ~0; <span class="comment">/* not-bool value */</span>
00875 }
00876 
00877 <span class="keywordtype">int</span> u_config_load_from_drv(<span class="keyword">const</span> <span class="keywordtype">char</span> *uri, u_config_driver_t *drv, 
00878         <span class="keywordtype">int</span> overwrite, u_config_t **pc)
00879 {
00880     u_config_t *c = NULL;
00881     <span class="keywordtype">void</span> *arg = NULL;
00882 
00883     dbg_err_if (uri == NULL);
00884     dbg_err_if (pc == NULL);
00885     dbg_err_if (drv == NULL);
00886 
00887     dbg_err_if (drv-&gt;gets == NULL);
00888 
00889     dbg_err_if (<a class="code" href="group__config.html#ga24">u_config_create</a>(&amp;c));
00890 
00891     <span class="keywordflow">if</span>(drv-&gt;open)
00892         dbg_err_if (drv-&gt;open(uri, &amp;arg));
00893 
00894     dbg_err_if (u_config_do_load_drv(c, drv, arg, overwrite));
00895 
00896     <span class="keywordflow">if</span>(drv-&gt;close)
00897         dbg_err_if (drv-&gt;close(arg));
00898 
00899     *pc = c;
00900 
00901     <span class="keywordflow">return</span> 0;
00902 err:
00903     <span class="keywordflow">if</span>(arg &amp;&amp; drv-&gt;close)
00904         drv-&gt;close(arg);
00905     <span class="keywordflow">if</span>(c)
00906         <a class="code" href="group__config.html#ga26">u_config_free</a>(c);
00907     <span class="keywordflow">return</span> ~0;
00908 }
00909 
00910 <span class="keywordtype">int</span> u_config_has_children(u_config_t *c)
00911 {
00912     <span class="keywordflow">return</span> (TAILQ_FIRST(&amp;c-&gt;children) != NULL);
00913 }
00914 
00915 <span class="keyword">static</span> <span class="keywordtype">int</span> u_config_to_str(u_config_t *c, u_string_t *s)
00916 {
00917     u_config_t *item;
00918 
00919     dbg_err_if(c == NULL);
00920     dbg_err_if(s == NULL);
00921 
00922     <span class="keywordflow">if</span>(c-&gt;key)
00923         <a class="code" href="group__string.html#ga16">u_string_aprintf</a>(s, <span class="stringliteral">"%s %s\n"</span>, c-&gt;key, (c-&gt;value ? c-&gt;value : <span class="stringliteral">""</span>));
00924     
00925     <span class="keywordflow">if</span>(u_config_has_children(c))
00926     {
00927         <span class="keywordflow">if</span>(c-&gt;parent)
00928             <a class="code" href="group__string.html#ga16">u_string_aprintf</a>(s, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"{\n"</span>);
00929 
00930         TAILQ_FOREACH(item, &amp;c-&gt;children, np)
00931             u_config_to_str(item, s);
00932 
00933         <span class="keywordflow">if</span>(c-&gt;parent)
00934             <a class="code" href="group__string.html#ga16">u_string_aprintf</a>(s, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"}\n"</span>);
00935     }
00936 
00937     <span class="keywordflow">return</span> 0;
00938 err:
00939     <span class="keywordflow">return</span> ~0;
00940 }
00941 
00942 <span class="keywordtype">int</span> u_config_save_to_buf(u_config_t *c, <span class="keywordtype">char</span> *buf, size_t size)
00943 {
00944     u_string_t *s = NULL;
00945 
00946     dbg_err_if(<a class="code" href="group__string.html#ga9">u_string_create</a>(NULL, 0, &amp;s));
00947 
00948     dbg_err_if(u_config_to_str(c, s));
00949 
00950     <span class="comment">/* buffer too small */</span>
00951     warn_err_if(<a class="code" href="group__string.html#ga5">u_string_len</a>(s) &gt;= size);
00952 
00953     strlcpy(buf, <a class="code" href="group__string.html#ga6">u_string_c</a>(s), size);
00954 
00955     <a class="code" href="group__string.html#ga10">u_string_free</a>(s);
00956 
00957     <span class="keywordflow">return</span> 0;
00958 err:
00959     <span class="keywordflow">if</span>(s)
00960         <a class="code" href="group__string.html#ga10">u_string_free</a>(s);
00961     <span class="keywordflow">return</span> ~0;
00962 }
00963 
00964 <span class="comment">/* gets() callback helper struct */</span>
00965 <span class="keyword">struct </span>u_config_buf_s
00966 {
00967     <span class="keywordtype">char</span> *data;
00968     size_t len;
00969 };
00970 
00971 <span class="keyword">static</span> <span class="keywordtype">char</span>* u_config_buf_gets(<span class="keywordtype">void</span> *arg, <span class="keywordtype">char</span> *buf, size_t size)
00972 {
00973     <span class="keyword">struct </span>u_config_buf_s *g = (<span class="keyword">struct </span>u_config_buf_s*)arg;
00974     <span class="keywordtype">char</span> *s = buf;
00975     <span class="keywordtype">int</span> c;
00976 
00977     dbg_err_if(arg == NULL);
00978     dbg_err_if(buf == NULL);
00979     dbg_err_if(size == 0);
00980 
00981     <span class="keywordflow">if</span>(g-&gt;len == 0 || g-&gt;data[0] == <span class="charliteral">'\0'</span>)
00982         <span class="keywordflow">return</span> NULL;
00983 
00984     size--; <span class="comment">/* save a char for the trailing \0 */</span>
00985 
00986     <span class="keywordflow">for</span>(; size &amp;&amp; g-&gt;len; --size)
00987     {
00988         c = *g-&gt;data;
00989 
00990         g-&gt;data++, g-&gt;len--;
00991 
00992         *s++ = c;
00993 
00994         <span class="keywordflow">if</span>(c == <span class="charliteral">'\n'</span>)
00995             <span class="keywordflow">break</span>;
00996     }
00997     *s = <span class="charliteral">'\0'</span>;
00998 
00999     <span class="comment">/* dbg("ln: [%s]", buf); */</span>
01000 
01001     <span class="keywordflow">return</span> buf;
01002 err:
01003     <span class="keywordflow">return</span> NULL;
01004 }
01005 
01006 <span class="keywordtype">int</span> u_config_load_from_buf(<span class="keywordtype">char</span> *buf, size_t len, u_config_t **pc)
01007 {
01008     u_config_driver_t drv = { NULL, NULL, u_config_buf_gets, NULL };
01009     <span class="keyword">struct </span>u_config_buf_s arg = { buf, len };
01010     u_config_t *c = NULL;
01011 
01012     dbg_err_if(<a class="code" href="group__config.html#ga24">u_config_create</a>(&amp;c));
01013 
01014     dbg_err_if(u_config_do_load_drv(c, &amp;drv, &amp;arg, 0));
01015 
01016     *pc = c;
01017 
01018     <span class="keywordflow">return</span> 0;
01019 err:
01020     <span class="keywordflow">if</span>(c)
01021         <a class="code" href="group__config.html#ga26">u_config_free</a>(c);
01022     <span class="keywordflow">return</span> ~0;
01023 }
01024 
01025 
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
