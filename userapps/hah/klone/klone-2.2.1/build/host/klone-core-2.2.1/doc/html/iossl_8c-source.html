<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: iossl.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>iossl.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: iossl.c,v 1.20 2008/04/21 17:04:18 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00013 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00014 <span class="preprocessor">#include &lt;klone/ioprv.h&gt;</span>
00015 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00016 <span class="preprocessor">#include &lt;openssl/ssl.h&gt;</span>
00017 <span class="preprocessor">#include &lt;openssl/err.h&gt;</span>
00018 
00019 <span class="keyword">struct </span>io_ssl_s
00020 {
00021     <span class="keyword">struct </span>io_s io; <span class="comment">/* must be the first item */</span>
00022     SSL *ssl;
00023     <span class="keywordtype">int</span> fd;
00024     <span class="keywordtype">int</span> flags;
00025 };
00026 
00027 <span class="keyword">typedef</span> <span class="keyword">struct </span>io_ssl_s io_ssl_t;
00028 
00029 <span class="keyword">static</span> ssize_t io_ssl_read(io_ssl_t *io, <span class="keywordtype">char</span> *buf, size_t size);
00030 <span class="keyword">static</span> ssize_t io_ssl_write(io_ssl_t *io, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, size_t size);
00031 
00032 <span class="keywordtype">int</span> io_ssl_get_SSL(io_t *io, SSL **pssl)
00033 {
00034     io_ssl_t *io_ssl = (io_ssl_t*)io;
00035 
00036     dbg_err_if(io_ssl == NULL);
00037     dbg_err_if(pssl == NULL);
00038     dbg_err_if(io_ssl-&gt;io.type != IO_TYPE_SSL);
00039 
00040     dbg_err_if(io_ssl-&gt;ssl == NULL);
00041 
00042     *pssl = io_ssl-&gt;ssl;
00043 
00044     <span class="keywordflow">return</span> 0;
00045 err:
00046     <span class="keywordflow">return</span> ~0;
00047 }
00048 
00049 <span class="keyword">static</span> ssize_t io_ssl_read(io_ssl_t *io_ssl, <span class="keywordtype">char</span> *buf, size_t size)
00050 {
00051     ssize_t c;
00052 
00053     dbg_err_if (io_ssl == NULL);
00054     dbg_err_if (buf == NULL);
00055 
00056 again:
00057     c = SSL_read(io_ssl-&gt;ssl, buf, size);
00058     <span class="comment">/* if(c &lt; 0 &amp;&amp; (errno == EINTR || errno == EAGAIN)) */</span>
00059     <span class="keywordflow">if</span>(c &lt; 0 &amp;&amp; errno == EINTR)
00060         <span class="keywordflow">goto</span> again; 
00061 
00062     dbg_err_if(c &lt; 0); 
00063 
00064     <span class="keywordflow">return</span> c;
00065 err:
00066     <span class="keywordflow">return</span> -1;
00067 }
00068 
00069 <span class="keyword">static</span> ssize_t io_ssl_write(io_ssl_t *io_ssl, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, size_t size)
00070 {
00071     ssize_t c;
00072 
00073     dbg_err_if (io_ssl == NULL);
00074     dbg_err_if (buf == NULL);
00075 
00076 again:
00077     c = SSL_write(io_ssl-&gt;ssl, buf, size);
00078     <span class="comment">/* if(c &lt; 0 &amp;&amp; (errno == EINTR || errno == EAGAIN)) */</span>
00079     <span class="keywordflow">if</span>(c &lt; 0 &amp;&amp; errno == EINTR)
00080         <span class="keywordflow">goto</span> again; 
00081 
00082     dbg_err_if(c &lt; 0); 
00083 
00084     <span class="keywordflow">return</span> c;
00085 err:
00086     <span class="keywordflow">return</span> -1;
00087 }
00088 
00089 <span class="comment">/* close the underlaying fd (may be called more then once) */</span>
00090 <span class="keyword">static</span> <span class="keywordtype">int</span> io_ssl_close(io_ssl_t *io_ssl)
00091 {
00092     dbg_err_if(io_ssl == NULL);
00093 
00094     <span class="keywordflow">if</span>(io_ssl-&gt;flags &amp; IO_FD_CLOSE &amp;&amp; io_ssl-&gt;fd != -1)
00095     {
00096         close(io_ssl-&gt;fd);
00097         io_ssl-&gt;fd = -1;
00098     }
00099 
00100     <span class="keywordflow">return</span> 0;
00101 err:
00102     <span class="keywordflow">return</span> ~0;
00103 }
00104 
00105 <span class="comment">/* free data alloc'ed by this io type */</span>
00106 <span class="keyword">static</span> <span class="keywordtype">int</span> io_ssl_free(io_ssl_t *io_ssl)
00107 {
00108     dbg_err_if(io_ssl == NULL);
00109 
00110     dbg_if(io_ssl_close(io_ssl));
00111 
00112     <span class="keywordflow">if</span>(io_ssl-&gt;ssl)
00113     {
00114         SSL_free(io_ssl-&gt;ssl);
00115         io_ssl-&gt;ssl = NULL;
00116     }
00117 
00118     <span class="keywordflow">return</span> 0;
00119 err:
00120     <span class="keywordflow">return</span> -1;
00121 }
00122 
00123 <span class="keyword">static</span> <span class="keywordtype">int</span> io_ssl_connect(io_ssl_t *io_ssl)
00124 {
00125     <span class="keywordtype">int</span> rc;
00126 
00127     <span class="comment">/* accept a SSL connection */</span>
00128     <span class="keywordflow">while</span>((rc = SSL_connect(io_ssl-&gt;ssl)) &lt;= 0)
00129     {
00130         <span class="comment">/* will return 1 if accept has been blocked by a signal or async IO */</span>
00131         <span class="keywordflow">if</span>(BIO_sock_should_retry(rc))
00132             <span class="keywordflow">continue</span>;
00133 
00134         <span class="keywordflow">if</span>(SSL_get_error(io_ssl-&gt;ssl, rc) == SSL_ERROR_WANT_READ)
00135             <span class="keywordflow">break</span>; 
00136 
00137         warn_err(<span class="stringliteral">"SSL accept error: %d"</span>, SSL_get_error(io_ssl-&gt;ssl, rc));
00138     }
00139 
00140     <span class="keywordflow">return</span> 0;
00141 err:
00142     <span class="keywordflow">return</span> ~0;
00143 }
00144 
00145 <span class="keyword">static</span> <span class="keywordtype">int</span> io_ssl_accept(io_ssl_t *io_ssl)
00146 {
00147     <span class="keywordtype">int</span> rc;
00148 
00149     <span class="comment">/* accept a SSL connection */</span>
00150     <span class="keywordflow">while</span>((rc = SSL_accept(io_ssl-&gt;ssl)) &lt;= 0)
00151     {
00152         <span class="comment">/* will return 1 if accept has been blocked by a signal or async IO */</span>
00153         <span class="keywordflow">if</span>(BIO_sock_should_retry(rc))
00154             <span class="keywordflow">continue</span>;
00155 
00156         <span class="keywordflow">if</span>(SSL_get_error(io_ssl-&gt;ssl, rc) == SSL_ERROR_WANT_READ)
00157             <span class="keywordflow">break</span>; 
00158 
00159         warn_err(<span class="stringliteral">"SSL accept error: %d"</span>, SSL_get_error(io_ssl-&gt;ssl, rc));
00160     }
00161 
00162     <span class="keywordflow">return</span> 0;
00163 err:
00164     <span class="keywordflow">return</span> ~0;
00165 }
00166 
00167 <span class="keywordtype">int</span> io_ssl_create(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> flags, <span class="keywordtype">int</span> client_mode, 
00168         SSL_CTX *ssl_ctx, io_t **pio)
00169 {
00170     io_ssl_t *io_ssl = NULL;
00171     <span class="keywordtype">int</span> rc = 0;
00172     <span class="keywordtype">long</span> vfy;
00173 
00174     dbg_return_if (pio == NULL, ~0);
00175     dbg_return_if (ssl_ctx == NULL, ~0);
00176 
00177     dbg_err_if(io_create(io_ssl_t, (io_t**)&amp;io_ssl));
00178 
00179     io_ssl-&gt;io.type = IO_TYPE_SSL;
00180 
00181     io_ssl-&gt;fd = fd;
00182     io_ssl-&gt;flags = flags;
00183 
00184     io_ssl-&gt;ssl = SSL_new(ssl_ctx);
00185     dbg_err_if(io_ssl-&gt;ssl == NULL);
00186 
00187     <span class="comment">/* assign a working descriptor to the SSL stream */</span>
00188     dbg_err_if(SSL_set_fd(io_ssl-&gt;ssl, fd) == 0);
00189 
00190     io_ssl-&gt;io.read = (io_read_op) io_ssl_read;
00191     io_ssl-&gt;io.write = (io_write_op) io_ssl_write;
00192     io_ssl-&gt;io.close = (io_close_op) io_ssl_close; 
00193     io_ssl-&gt;io.free = (io_free_op) io_ssl_free; 
00194     io_ssl-&gt;io.size = 0;
00195 
00196     <span class="comment">/* set the secure flag (encrypted connection) */</span>
00197     io_ssl-&gt;io.is_secure = 1;
00198     
00199     <span class="comment">/* wait for the peer to start the TLS handshake */</span>
00200     <span class="keywordflow">if</span>(client_mode)
00201         dbg_err_if(io_ssl_connect(io_ssl));
00202     <span class="keywordflow">else</span>
00203         dbg_err_if(io_ssl_accept(io_ssl));
00204 
00205     *pio = (io_t*)io_ssl;
00206 
00207     <span class="keywordflow">return</span> 0;
00208 err:
00209     <span class="keywordflow">if</span>(io_ssl &amp;&amp; io_ssl-&gt;ssl)
00210     {
00211         <span class="comment">/* print a warning message for bad client certificates */</span>
00212         <span class="keywordflow">if</span>((vfy = SSL_get_verify_result(io_ssl-&gt;ssl)) != X509_V_OK)
00213             warn(<span class="stringliteral">"SSL client cert verify error: %s"</span>, 
00214                 X509_verify_cert_error_string(vfy));
00215         SSL_set_shutdown(io_ssl-&gt;ssl, SSL_SENT_SHUTDOWN|SSL_RECEIVED_SHUTDOWN);
00216     }
00217     <span class="keywordflow">if</span>(io_ssl)
00218         <a class="code" href="group__basic.html#ga14">io_free</a>((io_t *)io_ssl);
00219     <span class="keywordflow">return</span> ~0;
00220 }
00221 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


