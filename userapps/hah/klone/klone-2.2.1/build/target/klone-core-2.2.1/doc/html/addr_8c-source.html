<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: addr.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>addr.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: addr.c,v 1.19 2008/06/04 17:48:02 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00013 <span class="preprocessor">#ifdef HAVE_STDINT</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdint.h&gt;</span>
00015 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_STDINT */</span>
00016 <span class="preprocessor">#include &lt;klone/addr.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/server.h&gt;</span>
00018 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00019 
00020 <span class="keywordtype">int</span> addr_free(kaddr_t *a)
00021 {
00022     U_FREE(a);
00023     <span class="keywordflow">return</span> 0;
00024 }
00025 
00026 <span class="keyword">static</span> <span class="keywordtype">int</span> addr_ipv4_create(u_config_t *c, kaddr_t *addr)
00027 {
00028     u_config_t *subkey;
00029     <span class="keywordtype">int</span> portn;
00030 
00031     dbg_return_if (c == NULL, ~0);
00032     dbg_return_if (addr == NULL, ~0);
00033     
00034     <span class="comment">/* set default values */</span>
00035     addr-&gt;type = ADDR_IPV4;
00036     addr-&gt;sa.sin.sin_family = AF_INET;
00037 
00038     <span class="comment">/* use user-defined ip or port */</span>
00039     <span class="keywordflow">if</span>(!u_config_get_subkey(c, <span class="stringliteral">"ip"</span>, &amp;subkey))
00040     {
00041 <span class="preprocessor">#ifdef OS_UNIX</span>
00042 <span class="preprocessor"></span>        warn_err_ifm(inet_pton(AF_INET, u_config_get_value(subkey), 
00043             &amp;addr-&gt;sa.sin.sin_addr) &lt;= 0, 
00044                 <span class="stringliteral">"bad '&lt;servname&gt;.addr.ip' value"</span>);
00045 <span class="preprocessor">#else</span>
00046 <span class="preprocessor"></span>        addr-&gt;sa.sin.sin_addr.s_addr = inet_addr(u_config_get_value(subkey));
00047         warn_err_ifm(addr-&gt;sa.sin.sin_addr.s_addr == INADDR_NONE,
00048                 <span class="stringliteral">"bad '&lt;servname&gt;.addr.ip' value"</span>);
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>    }
00051 
00052     <span class="keywordflow">if</span>(!u_config_get_subkey(c, <span class="stringliteral">"port"</span>, &amp;subkey))
00053     {
00054         portn = atoi(u_config_get_value(subkey));
00055         warn_err_ifm(portn &lt; 1 || portn &gt; 65535, <span class="stringliteral">"port out of range"</span>);
00056         addr-&gt;sa.sin.sin_port = htons(portn);
00057     }
00058 
00059     <span class="keywordflow">return</span> 0;
00060 err:
00061     <span class="keywordflow">return</span> ~0;
00062 }
00063 
00064 <span class="keyword">static</span> <span class="keywordtype">int</span> addr_is_ipv4(<span class="keyword">const</span> <span class="keywordtype">char</span> *ip)
00065 {
00066     size_t i, len = strlen(ip);
00067 
00068     dbg_return_if (ip == NULL, 0);
00069 
00070     <span class="comment">/* assume ip it's of type IPv4 if it contains a dot '.' */</span>
00071     <span class="keywordflow">for</span>(i = 0; i &lt; len; ++i)
00072         <span class="keywordflow">if</span>(ip[i] == <span class="charliteral">'.'</span>)
00073             <span class="keywordflow">return</span> 1;
00074     
00075     <span class="keywordflow">return</span> 0;
00076 }
00077 
00078 <span class="keywordtype">int</span> addr_set_ipv4_port(kaddr_t *addr, <span class="keywordtype">int</span> port)
00079 {
00080     dbg_return_if (addr == NULL, ~0);
00081     dbg_return_if (port == 0, ~0);
00082 
00083     addr-&gt;sa.sin.sin_port = htons(port);
00084 
00085     <span class="keywordflow">return</span> 0;
00086 }
00087 
00088 <span class="keywordtype">int</span> addr_set_ipv4_ip(kaddr_t *addr, <span class="keyword">const</span> <span class="keywordtype">char</span> *ip)
00089 {
00090     dbg_return_if (addr == NULL, ~0);
00091     dbg_return_if (ip == NULL, ~0);
00092 
00093     addr-&gt;type = ADDR_IPV4;
00094 
00095     <span class="comment">/* set default values */</span>
00096     memset(&amp;addr-&gt;sa.sin, 0, <span class="keyword">sizeof</span>(addr-&gt;sa.sin));
00097     addr-&gt;sa.sin.sin_family = AF_INET;
00098     addr-&gt;sa.sin.sin_addr.s_addr = inet_addr(ip);
00099 
00100     <span class="keywordflow">return</span> 0;
00101 }
00102 
00103 <span class="keywordtype">int</span> addr_set(kaddr_t *addr, <span class="keyword">const</span> <span class="keywordtype">char</span> *ip, <span class="keywordtype">int</span> port)
00104 {
00105     dbg_return_if (addr == NULL, ~0);
00106     dbg_return_if (ip == NULL, ~0);
00107     dbg_return_if (port == 0, ~0);
00108 
00109     <span class="keywordflow">if</span>(addr_is_ipv4(ip))
00110     {
00111         addr-&gt;type = ADDR_IPV4;
00112 
00113         <span class="comment">/* set default values */</span>
00114         memset(&amp;addr-&gt;sa.sin, 0, <span class="keyword">sizeof</span>(addr-&gt;sa.sin));
00115         addr-&gt;sa.sin.sin_family = AF_INET;
00116         addr-&gt;sa.sin.sin_addr.s_addr = inet_addr(ip);
00117         addr-&gt;sa.sin.sin_port = htons(port);
00118     } <span class="keywordflow">else</span> {
00119         <span class="keywordflow">return</span> ~0; <span class="comment">/* FIXME IPv6 */</span>
00120     }
00121 
00122     <span class="keywordflow">return</span> 0;
00123 }
00124 
00125 <span class="keywordtype">int</span> addr_set_from_sa(kaddr_t *addr, <span class="keyword">struct</span> sockaddr *sa, size_t sz)
00126 {
00127     dbg_return_if (addr == NULL, ~0);
00128     dbg_return_if (sa == NULL, ~0);
00129     
00130     <span class="keywordflow">switch</span>(sz)
00131     {
00132     <span class="keywordflow">case</span> <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr_in):
00133         addr-&gt;type = ADDR_IPV4;
00134         memcpy(&amp;addr-&gt;sa.sin, sa, sz);
00135         break;
00136 #ifndef NO_IPV6
00137     case sizeof(struct sockaddr_in6):
00138         addr-&gt;type = ADDR_IPV6;
00139         memcpy(&amp;addr-&gt;sa.sin6, sa, sz);
00140         break;
00141 #endif
00142 #ifndef NO_UNIXSOCK
00143     case sizeof(struct sockaddr_un):
00144         addr-&gt;type = ADDR_UNIX;
00145         memcpy(&amp;addr-&gt;sa.sun, sa, sz);
00146         break;
00147 #endif  
00148     default:
00149         dbg("bad sockaddr size");
00150         return ~0;
00151     }
00152 
00153     return 0;
00154 }
00155 
00156 int addr_set_from_config(kaddr_t *addr, u_config_t *c)
00157 {
00158     u_config_t *subkey;
00159     <span class="keyword">const</span> <span class="keywordtype">char</span> *type;
00160 
00161     dbg_return_if (addr == NULL, ~0);
00162     dbg_return_if (c == NULL, ~0);
00163     
00164     dbg_err_if(strcasecmp(u_config_get_key(c), <span class="stringliteral">"addr"</span>));
00165 
00166     warn_err_ifm(u_config_get_subkey(c, <span class="stringliteral">"type"</span>, &amp;subkey),
00167         <span class="stringliteral">"missing or bad '&lt;servname&gt;.addr.type' value"</span>);
00168 
00169     type = u_config_get_value(subkey); <span class="comment">/* IPv4, IPv6, unix, etc.  */</span>
00170 
00171     <span class="keywordflow">if</span>(!strcasecmp(type, <span class="stringliteral">"IPv4"</span>))
00172         dbg_err_if(addr_ipv4_create(c, addr));
00173     <span class="keywordflow">else</span> 
00174         warn_err_if(<span class="stringliteral">"bad '&lt;servname&gt;.addr.type', only IPv4 is supported"</span>);
00175 
00176     <span class="keywordflow">return</span> 0;
00177 err:
00178     <span class="keywordflow">return</span> ~0;
00179 }
00180 
00181 <span class="keywordtype">int</span> addr_create(kaddr_t **pa)
00182 {
00183     kaddr_t *addr = NULL;
00184 
00185     dbg_return_if (pa == NULL, ~0);
00186     
00187     addr = u_zalloc(<span class="keyword">sizeof</span>(kaddr_t));
00188     dbg_err_if(addr == NULL);
00189 
00190     <span class="comment">/* set default ipv4 values */</span>
00191     memset(&amp;addr-&gt;sa.sin, 0, <span class="keyword">sizeof</span>(addr-&gt;sa.sin));
00192     addr-&gt;sa.sin.sin_family = AF_INET;
00193     addr-&gt;sa.sin.sin_addr.s_addr = htonl(INADDR_ANY);
00194     addr-&gt;sa.sin.sin_port = htons(0);
00195 
00196     *pa = addr;
00197 
00198     <span class="keywordflow">return</span> 0;
00199 err:
00200     <span class="keywordflow">if</span>(addr)
00201         addr_free(addr);
00202     <span class="keywordflow">return</span> ~0;
00203 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


