<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: var.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>var.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: var.c,v 1.20 2008/05/16 15:04:47 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00014 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00015 <span class="preprocessor">#include &lt;klone/var.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/varprv.h&gt;</span>
00018 
00029 u_string_t *var_get_name_s(var_t *v)
00030 {
00031     dbg_return_if (v == NULL, NULL);
00032 
00033     <span class="keywordflow">return</span> v-&gt;sname; <span class="comment">/* may be NULL */</span>
00034 }
00035 
00046 u_string_t *var_get_value_s(var_t *v)
00047 {
00048     dbg_return_if (v == NULL, NULL);
00049 
00050     <span class="keywordflow">if</span>(v-&gt;svalue == NULL)
00051         dbg_err_if(u_string_create(v-&gt;data, v-&gt;size, &amp;v-&gt;svalue));
00052     
00053     <span class="keywordflow">return</span> v-&gt;svalue;
00054 err:
00055     <span class="keywordflow">return</span> NULL;
00056 }
00057 
00058 <span class="keywordtype">void</span> var_set_opaque(var_t *v, <span class="keywordtype">void</span> *opaque)
00059 {
00060     v-&gt;opaque = opaque;
00061 }
00062 
00063 <span class="keywordtype">void</span>* var_get_opaque(var_t *v)
00064 {
00065     <span class="keywordflow">return</span> v-&gt;opaque;
00066 }
00067 
00068 <span class="keywordtype">int</span> var_bin_create(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, size_t size, var_t **pv)
00069 {
00070     var_t *v = NULL;
00071 
00072     dbg_return_if (name == NULL, ~0);
00073     dbg_return_if (data == NULL, ~0);
00074     dbg_return_if (pv == NULL, ~0);
00075 
00076     v = u_zalloc(<span class="keyword">sizeof</span>(var_t));
00077     dbg_err_if(v == NULL);
00078 
00079     dbg_err_if(u_string_create(name, strlen(name), &amp;v-&gt;sname));
00080 
00081     dbg_err_if(var_set_bin_value(v, data, size));
00082 
00083     *pv = v;
00084 
00085     <span class="keywordflow">return</span> 0;
00086 err:
00087     <span class="keywordflow">if</span>(v)
00088         var_free(v);
00089     <span class="keywordflow">return</span> ~0;
00090 }
00091 
00092 <span class="keywordtype">int</span> var_create(<span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, var_t**pv)
00093 {
00094     dbg_return_if (name == NULL, ~0);
00095     dbg_return_if (value == NULL, ~0);
00096 
00097     <span class="keywordflow">return</span> var_bin_create(name, value, 1 + strlen(value), pv);
00098 }
00099 
00100 <span class="comment">/*</span>
00101 <span class="comment"> * \ingroup vars</span>
00102 <span class="comment"> * \brief   Free a variable</span>
00103 <span class="comment"> *</span>
00104 <span class="comment"> * \return \c 0, always</span>
00105 <span class="comment"> */</span>
00106 <span class="keywordtype">int</span> var_free(var_t *v)
00107 {
00108     <span class="keywordflow">if</span>(v)
00109     {
00110         <span class="keywordflow">if</span>(v-&gt;sname)
00111             u_string_free(v-&gt;sname);
00112 
00113         <span class="keywordflow">if</span>(v-&gt;svalue)
00114             u_string_free(v-&gt;svalue);
00115 
00116         <span class="keywordflow">if</span>(v-&gt;opaque)
00117             U_FREE(v-&gt;opaque);
00118 
00119         U_FREE(v-&gt;data);
00120         U_FREE(v);
00121     }
00122 
00123     <span class="keywordflow">return</span> 0;
00124 }
00125 
00136 <span class="keyword">const</span> <span class="keywordtype">char</span> *var_get_name(var_t *v)
00137 {
00138     dbg_return_if (v == NULL, NULL);
00139 
00140     <span class="keywordflow">return</span> u_string_c(v-&gt;sname);
00141 }
00142 
00153 <span class="keyword">const</span> <span class="keywordtype">char</span> *var_get_value(var_t *v)
00154 {
00155     dbg_return_if (v == NULL, NULL);
00156 
00157     <span class="keywordflow">return</span> v-&gt;data;
00158 }
00159 
00170 size_t var_get_value_size(var_t *v)
00171 {
00172     dbg_return_if (v == NULL, 0);   <span class="comment">/* XXX should be (ssize_t) '-1' */</span>
00173 
00174     <span class="keywordflow">return</span> v-&gt;size;
00175 }
00176 
00189 <span class="keywordtype">int</span> var_set(var_t *var, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
00190 {
00191     dbg_err_if (var == NULL);
00192     dbg_err_if (name == NULL);
00193     dbg_err_if (value == NULL);
00194     
00195     dbg_err_if(var_set_name(var, name));
00196     dbg_err_if(var_set_value(var, value));
00197 
00198     <span class="keywordflow">return</span> 0;
00199 err:
00200     <span class="keywordflow">return</span> ~0;
00201 }
00202 
00214 <span class="keywordtype">int</span> var_set_name(var_t *v, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00215 {
00216     dbg_err_if (v == NULL);
00217     dbg_err_if (name == NULL);
00218 
00219     dbg_err_if(u_string_set(v-&gt;sname, name, strlen(name)));
00220 
00221     <span class="keywordflow">return</span> 0; 
00222 err:
00223     <span class="keywordflow">return</span> ~0;
00224 }
00225 
00237 <span class="keywordtype">int</span> var_set_value(var_t *v, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
00238 {
00239     dbg_return_if (v == NULL, ~0);
00240     dbg_return_if (value == NULL, ~0);
00241 
00242     <span class="comment">/* copy the string and the trailing '\0' */</span>
00243     <span class="keywordflow">return</span> var_set_bin_value(v, value, 1 + strlen(value));
00244 }
00245 
00258 <span class="keywordtype">int</span> var_set_bin_value(var_t *v, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, size_t size)
00259 {
00260     dbg_err_if (v == NULL);
00261     dbg_err_if (data == NULL);
00262     
00263     U_FREE(v-&gt;data);
00264 
00265     <span class="keywordflow">if</span>(data &amp;&amp; size)
00266     {
00267         v-&gt;size = size;
00268         v-&gt;data = u_malloc(size+1);
00269         dbg_err_if(v-&gt;data == NULL);
00270 
00271         memcpy(v-&gt;data, data, size);
00272         v-&gt;data[size] = 0; <span class="comment">/* zero-term v-&gt;data so it can be used as a string */</span>
00273     } <span class="keywordflow">else</span> {
00274         v-&gt;size = 0;
00275         v-&gt;data = NULL;
00276     }
00277 
00278     <span class="keywordflow">if</span>(v-&gt;svalue)
00279         dbg_err_if(u_string_set(v-&gt;svalue, v-&gt;data, v-&gt;size));
00280 
00281     <span class="keywordflow">return</span> 0; 
00282 err:
00283     <span class="keywordflow">return</span> ~0;
00284 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


