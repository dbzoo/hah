<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: dypage.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>dypage.c</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;klone/dypage.h&gt;</span>
00002 <span class="preprocessor">#include &lt;klone/session.h&gt;</span>
00003 <span class="preprocessor">#include &lt;klone/ses_prv.h&gt;</span>
00004 <span class="preprocessor">#include &lt;klone/rsfilter.h&gt;</span>
00005 
00006 <span class="keyword">const</span> <span class="keywordtype">char</span> *dypage_get_param(dypage_args_t *args, <span class="keyword">const</span> <span class="keywordtype">char</span> *key)
00007 {
00008     <span class="keywordtype">int</span> i;
00009 
00010     <span class="keywordflow">for</span>(i = 0; i &lt; args-&gt;nparams; ++i)
00011         <span class="keywordflow">if</span>(strcmp(key, args-&gt;params[i].key) == 0)
00012             <span class="keywordflow">return</span> args-&gt;params[i].val;
00013 
00014     <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00015 }
00016 
00017 <span class="keywordtype">int</span> dypage_serve(dypage_args_t *args)
00018 {
00019     http_t *http = NULL;
00020     codec_t *filter = NULL;
00021     session_opt_t *so;
00022     request_t *rq;
00023     response_t *rs;
00024     session_t *ss;
00025     io_t *oio;
00026 
00027     dbg_return_if(args == NULL, ~0);
00028 
00029     dbg_return_if(args-&gt;rq == NULL, ~0);
00030     dbg_return_if(args-&gt;rs == NULL, ~0);
00031     dbg_return_if(args-&gt;fun == NULL, ~0);
00032 
00033     <span class="comment">/* alias */</span>
00034     rq = args-&gt;rq;
00035     rs = args-&gt;rs;
00036 
00037     <span class="comment">/* output io object */</span>
00038     oio = <a class="code" href="group__response.html#ga16">response_io</a>(rs);
00039 
00040     <span class="comment">/* get session options */</span>
00041     dbg_err_if((http = <a class="code" href="group__request.html#ga8">request_get_http</a>(rq)) == NULL);
00042     dbg_err_if((so = http_get_session_opt(http)) == NULL);
00043 
00044     <span class="comment">/* parse URL encoded or POSTed data (POST must be read before) */</span>
00045     dbg_err_if(request_parse_data(rq));
00046 
00047     <span class="comment">/* create/get the session */</span>
00048     dbg_err_if(session_create(so, rq, rs, &amp;args-&gt;ss));
00049 
00050     <span class="comment">/* alias */</span>
00051     ss = args-&gt;ss;
00052 
00053     <span class="comment">/* set some default values */</span>
00054     dbg_err_if(<a class="code" href="group__response.html#ga21">response_set_content_type</a>(rs, <span class="stringliteral">"text/html"</span>));
00055 
00056     <span class="comment">/* by default disable caching */</span>
00057     <a class="code" href="group__response.html#ga11">response_disable_caching</a>(rs);
00058 
00059     <span class="comment">/* create a response filter (used to automatically print all header fields </span>
00060 <span class="comment">     * when the header buffer fills up) and attach it to the response io */</span>
00061     dbg_err_if(response_filter_create(rq, rs, ss, &amp;filter));
00062     <a class="code" href="group__basic.html#ga32">io_codec_add_tail</a>(oio, filter);
00063 
00064     <span class="comment">/* run the page code */</span>
00065     args-&gt;fun(args);
00066 
00067     <span class="comment">/* flush the output buffer */</span>
00068     <a class="code" href="group__basic.html#ga20">io_flush</a>(oio);
00069 
00070     <span class="comment">/* if nothing has been printed by the script then write a dummy byte so </span>
00071 <span class="comment">     * the io_t calls the filter function that, in turn, will print out the </span>
00072 <span class="comment">     * HTTP header (rsfilter will handle it) */</span>
00073     <span class="keywordflow">if</span>(!response_filter_feeded(filter))
00074         <a class="code" href="group__basic.html#ga19">io_write</a>(oio, <span class="stringliteral">"\n"</span>, 1);
00075 
00076     <span class="comment">/* save and destroy the session */</span>
00077     session_free(ss); args-&gt;ss = ss = NULL;
00078 
00079     <span class="keywordflow">return</span> 0;
00080 err:
00081     <span class="keywordflow">if</span>(args-&gt;rs)
00082         <a class="code" href="group__basic.html#ga20">io_flush</a>(<a class="code" href="group__response.html#ga16">response_io</a>(args-&gt;rs));
00083     <span class="keywordflow">if</span>(args-&gt;ss)
00084     {
00085         session_free(args-&gt;ss);
00086         args-&gt;ss = NULL;
00087     }
00088     <span class="keywordflow">return</span> ~0;
00089 }
00090 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


