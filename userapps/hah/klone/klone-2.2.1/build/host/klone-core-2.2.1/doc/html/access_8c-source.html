<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: access.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>access.c</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;time.h&gt;</span>
00002 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00003 <span class="preprocessor">#include &lt;klone/klone.h&gt;</span>
00004 <span class="preprocessor">#include &lt;klone/context.h&gt;</span>
00005 <span class="preprocessor">#include &lt;klone/klog.h&gt;</span>
00006 <span class="preprocessor">#include &lt;klone/access.h&gt;</span>
00007 <span class="preprocessor">#include &lt;klone/server_ppc_cmd.h&gt;</span>
00008 
00009 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *value_or_dash(<span class="keyword">const</span> <span class="keywordtype">char</span> *v)
00010 {
00011     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> dash[] = <span class="stringliteral">"-"</span>;
00012 
00013     <span class="keywordflow">return</span> (v ? v : dash);
00014 }
00015 
00016 <span class="keyword">static</span> <span class="keywordtype">long</span> get_timezone(<span class="keyword">struct</span> tm *tm)
00017 {
00018 <span class="preprocessor">#ifdef HAVE_STRUCT_TM_TM_GMTOFF</span>
00019 <span class="preprocessor"></span>    <span class="keywordtype">long</span> <span class="keywordtype">int</span> h, m, sign;
00020 
00021     sign = (tm-&gt;tm_gmtoff &gt; 0 ? 1 : -1);
00022     h = abs(tm-&gt;tm_gmtoff) / 3600;
00023     m = (h % 3600) / 60;
00024 
00025     <span class="keywordflow">return</span> sign * (h * 100 + m);
00026 <span class="preprocessor">#else</span>
00027 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>}
00030 
00031 <span class="keywordtype">int</span> access_log(http_t *h, u_config_t *config, request_t *rq, response_t *rs)
00032 {
00033     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *months[] = {
00034         <span class="stringliteral">"Jan"</span>, <span class="stringliteral">"Feb"</span>, <span class="stringliteral">"Mar"</span>, <span class="stringliteral">"Apr"</span>, <span class="stringliteral">"May"</span>, <span class="stringliteral">"Jun"</span>,
00035         <span class="stringliteral">"Jul"</span>, <span class="stringliteral">"Aug"</span>, <span class="stringliteral">"Sep"</span>, <span class="stringliteral">"Oct"</span>, <span class="stringliteral">"Nov"</span>, <span class="stringliteral">"Dec"</span>
00036     };
00037     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> default_prefix[] = <span class="stringliteral">"[access]"</span>;
00038     <span class="keyword">const</span> <span class="keywordtype">char</span> *ip,  *fn, *value, *prefix;
00039     <span class="keywordtype">char</span> buf[U_MAX_LOG_LENGTH];
00040     u_config_t *sub;
00041     vhost_t *vhost;
00042     kaddr_t *addr;
00043     <span class="keyword">struct </span>timeval tv;
00044     <span class="keyword">struct </span>tm tm;
00045     time_t now;
00046     <span class="keywordtype">int</span> logrq, n;
00047 
00048     dbg_err_if(h == NULL);
00049     dbg_err_if(config == NULL);
00050     dbg_err_if(rq == NULL);
00051     dbg_err_if(rs == NULL);
00052 
00053     dbg_err_if((vhost = http_get_vhost(h, rq)) == NULL);
00054 
00055     <span class="comment">/* exit if access logging is not configured */</span>
00056     dbg_err_if(vhost-&gt;klog == NULL);
00057 
00058     fn = <a class="code" href="group__request.html#ga17">request_get_filename</a>(rq);
00059     dbg_err_if(fn == NULL);
00060 
00061     logrq = 0;
00062 
00063     <span class="comment">/* if the user specifies what to log */</span>
00064     <span class="keywordflow">if</span>(u_config_get_child_n(config, <span class="stringliteral">"log"</span>, 0))
00065     {
00066         <span class="keywordflow">for</span>(n = 0; (sub = u_config_get_child_n(config, <span class="stringliteral">"log"</span>, n)) != NULL; ++n)
00067         {
00068             <span class="keywordflow">if</span>((value = u_config_get_value(sub)) == NULL)
00069                 <span class="keywordflow">continue</span>;
00070             <span class="keywordflow">if</span>(!fnmatch(value, fn, 0))
00071             {
00072                 logrq++;
00073                 <span class="keywordflow">break</span>; <span class="comment">/* log it */</span>
00074             }
00075         }
00076     } <span class="keywordflow">else</span> {
00077         <span class="comment">/* no "log" key found, match all filenames */</span>
00078         logrq++;
00079     }
00080     
00081     <span class="keywordflow">if</span>(!logrq)
00082         <span class="keywordflow">return</span> 0; <span class="comment">/* don't log this request */</span>
00083 
00084     <span class="comment">/* the user specified what is NOT to be logged */</span>
00085     <span class="keywordflow">for</span>(n = 0; (sub = u_config_get_child_n(config, <span class="stringliteral">"dontlog"</span>, n)) != NULL; ++n)
00086     {
00087         <span class="keywordflow">if</span>((value = u_config_get_value(sub)) == NULL)
00088             <span class="keywordflow">continue</span>;
00089         <span class="keywordflow">if</span>(fnmatch(value, fn, 0) == FNM_NOMATCH)
00090             <span class="keywordflow">continue</span>;
00091         <span class="keywordflow">else</span> 
00092             <span class="keywordflow">return</span> 0; <span class="comment">/* a "dontlog" item matches the filename, don't log */</span>
00093     }
00094 
00095     gettimeofday(&amp;tv, NULL);
00096 
00097     addr = <a class="code" href="group__request.html#ga10">request_get_peer_addr</a>(rq);
00098     ip = inet_ntoa(addr-&gt;sa.sin.sin_addr);
00099 
00100     now = tv.tv_sec;
00101 <span class="preprocessor">#ifdef HAVE_LOCALTIME_R</span>
00102 <span class="preprocessor"></span>    localtime_r(&amp;now, &amp;tm);
00103 <span class="preprocessor">#else</span>
00104 <span class="preprocessor"></span>    tm = *localtime(&amp;now);
00105 <span class="preprocessor">#endif</span>
00106 <span class="preprocessor"></span>    tm.tm_year += 1900;
00107 
00108     <span class="keywordflow">if</span>((sub = u_config_get_child(config, <span class="stringliteral">"prefix"</span>)) == NULL || 
00109             (prefix = u_config_get_value(sub)) == NULL)
00110     {
00111         prefix = default_prefix;
00112     }
00113 
00114     <span class="comment">/* build the log message */</span>
00115     dbg_err_if(u_snprintf(buf, <span class="keyword">sizeof</span>(buf),
00116             <span class="stringliteral">"%s %s - - [%02d/%s/%4d:%02d:%02d:%02d %ld]"</span>
00117             <span class="stringliteral">" \"%s\" %d %s \"%s\" \"%s\" \"-\""</span>, 
00118             prefix,
00119             value_or_dash(ip),
00120             <span class="comment">/* date */</span> 
00121             tm.tm_mday, months[tm.tm_mon], tm.tm_year,
00122             <span class="comment">/* time */</span> 
00123             tm.tm_hour, tm.tm_min, tm.tm_sec, get_timezone(&amp;tm),
00124             <span class="comment">/* uri */</span>
00125             value_or_dash(<a class="code" href="group__request.html#ga14">request_get_client_request</a>(rq)),
00126             <span class="comment">/* status */</span>
00127             <a class="code" href="group__response.html#ga7">response_get_status</a>(rs),
00128             <span class="comment">/* bytes returned */</span>
00129             value_or_dash(response_get_field_value(rs, <span class="stringliteral">"Content-Length"</span>)),
00130             <span class="comment">/* referer and user-agent */</span>
00131             value_or_dash(<a class="code" href="group__request.html#ga13">request_get_field_value</a>(rq, <span class="stringliteral">"Referer"</span>)),
00132             value_or_dash(<a class="code" href="group__request.html#ga13">request_get_field_value</a>(rq, <span class="stringliteral">"User-Agent"</span>))
00133             ));
00134 
00135     <span class="comment">/* syslog klog doesn't go through ppc */</span>
00136     <span class="keywordflow">if</span>(vhost-&gt;klog-&gt;type == KLOG_TYPE_SYSLOG || ctx-&gt;pipc == 0)
00137     {   <span class="comment">/* syslog klog or parent context */</span>
00138         <span class="keywordflow">if</span>(vhost-&gt;klog)
00139             dbg_err_if(klog(vhost-&gt;klog, KLOG_INFO, <span class="stringliteral">"%s"</span>, buf));
00140     } <span class="keywordflow">else</span> {
00141         <span class="comment">/* children context */</span>
00142         dbg_err_if(ctx-&gt;server == NULL);
00143         dbg_err_if(ctx-&gt;backend == NULL);
00144         dbg_err_if(server_ppc_cmd_access_log(ctx-&gt;server, ctx-&gt;backend-&gt;id, 
00145                     vhost-&gt;id, buf));
00146     }
00147 
00148     <span class="keywordflow">return</span> 0;
00149 err:
00150     <span class="keywordflow">return</span> ~0;
00151 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


