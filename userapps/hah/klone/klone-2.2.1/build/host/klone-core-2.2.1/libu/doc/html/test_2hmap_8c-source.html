<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: hmap.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>hmap.c</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 
00004 
00005 <span class="keyword">static</span> <span class="keywordtype">int</span> example_static()
00006 {
00007     u_hmap_t *hmap = NULL;
00008     u_hmap_o_t *obj = NULL;
00009     <span class="keywordtype">int</span> fibonacci[] = { 0, 1, 1, 2, 3, 5, 8, 13, 21 };
00010 
00011     dbg(<span class="stringliteral">"example_static()"</span>);
00012 
00013     <span class="comment">/* initialise hmap with no options - user owns data by default */</span>
00014     dbg_err_if (<a class="code" href="group__hmap.html#ga20">u_hmap_new</a>(NULL, &amp;hmap));
00015 
00016     <span class="comment">/* insert some sample elements */</span>
00017     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>(<span class="stringliteral">"first"</span>, &amp;fibonacci[0]), NULL));
00018     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>(<span class="stringliteral">"fifth"</span>, &amp;fibonacci[4]), NULL)); 
00019     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>(<span class="stringliteral">"last"</span>, 
00020                 &amp;fibonacci[(<span class="keyword">sizeof</span>(fibonacci)/<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))-1]), NULL));
00021 
00022     <span class="comment">/* retrieve and print values to dbgsole */</span>
00023     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"last"</span>, &amp;obj)); 
00024     dbg(<span class="stringliteral">"hmap['%s'] = %d"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, *((<span class="keywordtype">int</span> *) obj-&gt;val));
00025     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"fifth"</span>, &amp;obj)); 
00026     dbg(<span class="stringliteral">"hmap['%s'] = %d"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, *((<span class="keywordtype">int</span> *) obj-&gt;val)); 
00027     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"first"</span>, &amp;obj)); 
00028     dbg(<span class="stringliteral">"hmap['%s'] = %d"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, *((<span class="keywordtype">int</span> *) obj-&gt;val));
00029 
00030     <span class="comment">/* remove an element and replace it */</span>
00031     dbg_err_if (u_hmap_del(hmap, <span class="stringliteral">"fifth"</span>, &amp;obj)); 
00032     <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj);
00033     
00034     <span class="comment">/* check that it has been deleted */</span>
00035     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"fifth"</span>, &amp;obj) == 0); 
00036 
00037     <span class="comment">/* delete the other two elements */</span>
00038     dbg_err_if (u_hmap_del(hmap, <span class="stringliteral">"last"</span>, &amp;obj)); 
00039     <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj);
00040     dbg_err_if (u_hmap_del(hmap, <span class="stringliteral">"first"</span>, &amp;obj)); 
00041     <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj);
00042 
00043     <span class="comment">/* free hmap and options */</span>
00044     <a class="code" href="group__hmap.html#ga29">u_hmap_free</a>(hmap);
00045     
00046     <span class="keywordflow">return</span> 0;
00047 err:
00048     U_FREEF(hmap, u_hmap_free);
00049 
00050     <span class="keywordflow">return</span> ~0;
00051 }
00052 
00053 <span class="keyword">static</span> <span class="keywordtype">int</span> example_dynamic_own_hmap()
00054 {
00055     <a class="code" href="structu__hmap__opts__s.html">u_hmap_opts_t</a> *opts = NULL;
00056     u_hmap_t *hmap = NULL;
00057     u_hmap_o_t *obj = NULL;
00058 
00059     dbg(<span class="stringliteral">"example_dynamic_own_hmap()"</span>);
00060 
00061     <span class="comment">/* initialise options and hmap */</span>
00062     dbg_err_if (<a class="code" href="group__hmap.html#ga30">u_hmap_opts_new</a>(&amp;opts));
00063     <span class="comment">/* hmap owns both keys and data */</span>
00064     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o4">options</a> |= U_HMAP_OPTS_OWNSDATA;
00065     dbg_err_if (<a class="code" href="group__hmap.html#ga20">u_hmap_new</a>(opts, &amp;hmap));
00066 
00067     <span class="comment">/* insert some sample elements */</span>
00068     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"english"</span>), 
00069                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Hello world!"</span>)), NULL));
00070     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"italian"</span>), 
00071                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Ciao mondo!"</span>)), NULL));
00072     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"german"</span>), 
00073                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Hallo Welt!"</span>)), NULL));
00074 
00075     <span class="comment">/* retrieve and print values to console */</span>
00076     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"italian"</span>, &amp;obj)); 
00077     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00078     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"german"</span>, &amp;obj)); 
00079     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00080     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"english"</span>, &amp;obj)); 
00081     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00082 
00083     <span class="comment">/* remove an element and replace it */</span>
00084     dbg_err_if (u_hmap_del(hmap, <span class="stringliteral">"german"</span>, NULL)); 
00085 
00086     <span class="comment">/* check that it has been deleted */</span>
00087     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"german"</span>, &amp;obj) == 0); 
00088 
00089     <span class="comment">/* replace with a new element and print it */</span>
00090     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"german"</span>), 
00091                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Auf Wiedersehen!"</span>)), NULL));
00092     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"german"</span>, &amp;obj)); 
00093     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00094 
00095     <span class="comment">/* free hmap (options and elements are freed automatically) */</span>
00096     <a class="code" href="group__hmap.html#ga22">u_hmap_dbg</a>(hmap);
00097     <a class="code" href="group__hmap.html#ga33">u_hmap_opts_free</a>(opts);
00098     <a class="code" href="group__hmap.html#ga29">u_hmap_free</a>(hmap);
00099 
00100     <span class="keywordflow">return</span> 0;
00101 
00102 err:
00103     U_FREEF(opts, u_hmap_opts_free);
00104     U_FREEF(hmap, u_hmap_free);
00105 
00106     <span class="keywordflow">return</span> ~0;
00107 }
00108 
00109 <span class="keyword">static</span> <span class="keywordtype">int</span> example_dynamic_own_user()
00110 {
00111     u_hmap_t *hmap = NULL;
00112     u_hmap_o_t *obj = NULL;
00113 
00114 <span class="preprocessor">#define OBJ_FREE(obj) \</span>
00115 <span class="preprocessor">    if (obj) { \</span>
00116 <span class="preprocessor">        u_free(obj-&gt;key); \</span>
00117 <span class="preprocessor">        u_free(obj-&gt;val); \</span>
00118 <span class="preprocessor">        u_hmap_o_free(obj); \</span>
00119 <span class="preprocessor">        obj = NULL; \</span>
00120 <span class="preprocessor">    }</span>
00121 <span class="preprocessor"></span>    
00122     dbg(<span class="stringliteral">"example_dynamic_own_user()"</span>);
00123 
00124     <span class="comment">/* hmap owns both keys and data */</span>
00125     dbg_err_if (<a class="code" href="group__hmap.html#ga20">u_hmap_new</a>(NULL, &amp;hmap));
00126 
00127     <span class="comment">/* insert some sample elements */</span>
00128     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"english"</span>), 
00129                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Hello world!"</span>)), &amp;obj));
00130     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"italian"</span>), 
00131                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Ciao mondo!"</span>)), &amp;obj));
00132     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"german"</span>), 
00133                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Hallo Welt!"</span>)), &amp;obj));
00134 
00135     <span class="comment">/* retrieve and print values to console */</span>
00136     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"italian"</span>, &amp;obj)); 
00137     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00138     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"german"</span>, &amp;obj)); 
00139     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00140     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"english"</span>, &amp;obj)); 
00141     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00142 
00143     <span class="comment">/* remove an element and replace it */</span>
00144     dbg_err_if (u_hmap_del(hmap, <span class="stringliteral">"german"</span>, &amp;obj)); 
00145     OBJ_FREE(obj);
00146 
00147     <span class="comment">/* check that it has been deleted */</span>
00148     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"german"</span>, &amp;obj) == 0); 
00149 
00150     <span class="comment">/* replace with a new element and print it */</span>
00151     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"german"</span>), 
00152                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Auf Wiedersehen!"</span>)), NULL));
00153     dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>((<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"german"</span>), 
00154                     (<span class="keywordtype">void</span> *) <a class="code" href="group__misc.html#ga5">u_strdup</a>(<span class="stringliteral">"Auf Wiedersehen2!"</span>)), &amp;obj));
00155     OBJ_FREE(obj);
00156     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"german"</span>, &amp;obj)); 
00157     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00158 
00159     u_hmap_del(hmap, <span class="stringliteral">"italian"</span>, &amp;obj);
00160     OBJ_FREE(obj);
00161     u_hmap_del(hmap, <span class="stringliteral">"german"</span>, &amp;obj);
00162     OBJ_FREE(obj);
00163     u_hmap_del(hmap, <span class="stringliteral">"english"</span>, &amp;obj);
00164     OBJ_FREE(obj);
00165 
00166     <span class="comment">/* free hmap (options and elements are freed automatically) */</span>
00167     <a class="code" href="group__hmap.html#ga29">u_hmap_free</a>(hmap);
00168 
00169     <span class="keywordflow">return</span> 0;
00170 
00171 err:
00172     U_FREEF(hmap, u_hmap_free);
00173 
00174     <span class="keywordflow">return</span> ~0;
00175 }
00176 
00177 <span class="keyword">static</span> <span class="keywordtype">int</span> example_no_overwrite()
00178 {
00179 <span class="preprocessor">#define MAP_INSERT(hmap, key, val, obj) \</span>
00180 <span class="preprocessor">    switch (u_hmap_put(hmap, u_hmap_o_new(key, val), &amp;obj)) { \</span>
00181 <span class="preprocessor">        case U_HMAP_ERR_NONE: \</span>
00182 <span class="preprocessor">            break; \</span>
00183 <span class="preprocessor">        case U_HMAP_ERR_EXISTS: \</span>
00184 <span class="preprocessor">            u_hmap_o_free(obj); \</span>
00185 <span class="preprocessor">            break; \</span>
00186 <span class="preprocessor">        case U_HMAP_ERR_FAIL: \</span>
00187 <span class="preprocessor">            goto err; \</span>
00188 <span class="preprocessor">    }</span>
00189 <span class="preprocessor"></span>
00190     <a class="code" href="structu__hmap__opts__s.html">u_hmap_opts_t</a> *opts = NULL;
00191     u_hmap_t *hmap = NULL;
00192     u_hmap_o_t *obj = NULL;
00193 
00194     dbg(<span class="stringliteral">"example_no_overwrite()"</span>);
00195 
00196     <span class="comment">/* initialise options and hmap */</span>
00197     dbg_err_if (<a class="code" href="group__hmap.html#ga30">u_hmap_opts_new</a>(&amp;opts));
00198     <span class="comment">/* hmap owns both keys and data */</span>
00199     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o4">options</a> |= U_HMAP_OPTS_NO_OVERWRITE;
00200     dbg_err_if (<a class="code" href="group__hmap.html#ga20">u_hmap_new</a>(opts, &amp;hmap));
00201 
00202     <span class="comment">/* insert some sample elements with the same key */</span>
00203     MAP_INSERT(hmap, <span class="stringliteral">"A"</span>, <span class="stringliteral">"A1"</span>, obj);
00204     MAP_INSERT(hmap, <span class="stringliteral">"A"</span>, <span class="stringliteral">"A2"</span>, obj);
00205     MAP_INSERT(hmap, <span class="stringliteral">"A"</span>, <span class="stringliteral">"A3"</span>, obj);
00206 
00207     <span class="comment">/* retrieve and print values to console */</span>
00208     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, <span class="stringliteral">"A"</span>, &amp;obj)); 
00209     dbg(<span class="stringliteral">"hmap['%s'] = %s"</span>, (<span class="keywordtype">char</span> *) obj-&gt;key, (<span class="keywordtype">char</span> *) obj-&gt;val);
00210     dbg_err_if (u_hmap_del(hmap, <span class="stringliteral">"A"</span>, &amp;obj)); 
00211     <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj); 
00212 
00213     <span class="comment">/* free hmap and opts */</span>
00214     <a class="code" href="group__hmap.html#ga33">u_hmap_opts_free</a>(opts);
00215     <a class="code" href="group__hmap.html#ga29">u_hmap_free</a>(hmap);
00216 
00217     <span class="keywordflow">return</span> 0;
00218 
00219 err:
00220     U_FREEF(opts, u_hmap_opts_free);
00221     U_FREEF(hmap, u_hmap_free);
00222 
00223     <span class="keywordflow">return</span> ~0;
00224 <span class="preprocessor">#undef MAP_INSERT</span>
00225 <span class="preprocessor"></span>}
00226 
00227 size_t _sample_hash(<span class="keywordtype">void</span> *key, size_t size)
00228 {
00229     <span class="keywordflow">return</span> (*((<span class="keywordtype">int</span> *) key) % size);
00230 }
00231 
00232 <span class="keywordtype">int</span> _sample_comp(<span class="keywordtype">void</span> *key1, <span class="keywordtype">void</span> *key2)
00233 {
00234     <span class="keywordtype">int</span> k1 = *((<span class="keywordtype">int</span> *) key1),
00235         k2 = *((<span class="keywordtype">int</span> *) key2);
00236     
00237     <span class="keywordflow">return</span> k1 &lt; k2 ? -1 : ((k1 &gt; k2)? 1 : 0);
00238 }
00239 
00240 u_string_t *_sample_str(u_hmap_o_t *obj)
00241 {
00242     <span class="keyword">enum</span> { MAX_OBJ_STR = 256 };
00243     <span class="keywordtype">char</span> buf[MAX_OBJ_STR];
00244     u_string_t *s = NULL;
00245 
00246     <span class="keywordtype">int</span> key = *((<span class="keywordtype">int</span> *) obj-&gt;key);
00247     <span class="keywordtype">char</span> *val = (<span class="keywordtype">char</span> *) obj-&gt;val;
00248 
00249     dbg_err_if (<a class="code" href="group__misc.html#ga12">u_snprintf</a>(buf, MAX_OBJ_STR, <span class="stringliteral">"[%d:%s]"</span>, key, val));
00250     dbg_err_if (<a class="code" href="group__string.html#ga9">u_string_create</a>(buf, strlen(buf)+1, &amp;s));
00251 
00252     <span class="keywordflow">return</span> s;
00253 
00254 err:
00255     <span class="keywordflow">return</span> NULL;
00256 }
00257 
00258 <span class="comment">/* Allocate (key, value) pair dynamically */</span>
00259 u_hmap_o_t *_sample_obj(<span class="keywordtype">int</span> key, <span class="keyword">const</span> <span class="keywordtype">char</span> *val)
00260 {
00261     u_hmap_o_t *<span class="keyword">new</span> = NULL;
00262 
00263     <span class="keywordtype">int</span> *k = NULL;
00264     <span class="keywordtype">char</span> *v = NULL;
00265     
00266     k = (<span class="keywordtype">int</span> *) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00267     dbg_err_if (k == NULL);
00268     *k = key;
00269 
00270     v = <a class="code" href="group__misc.html#ga5">u_strdup</a>(val);
00271     dbg_err_if (v == NULL);
00272     
00273     <span class="keyword">new</span> = <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>(k, v);
00274     dbg_err_if (<span class="keyword">new</span> == NULL);
00275     
00276     <span class="keywordflow">return</span> <span class="keyword">new</span>;
00277 
00278 err:
00279     <a class="code" href="group__alloc.html#ga8">u_free</a>(k);
00280     <a class="code" href="group__alloc.html#ga8">u_free</a>(v);
00281     
00282     <span class="keywordflow">return</span> NULL;
00283 }
00284 
00285 <span class="keyword">static</span> <span class="keywordtype">int</span> example_types_custom()
00286 {
00287 <span class="preprocessor">#define MAP_INSERT(hmap, k, v) \</span>
00288 <span class="preprocessor">    dbg_err_if ((obj = _sample_obj(k, v)) == NULL); \</span>
00289 <span class="preprocessor">    dbg_err_if (u_hmap_put(hmap, obj, NULL));</span>
00290 <span class="preprocessor"></span>
00291     <a class="code" href="structu__hmap__opts__s.html">u_hmap_opts_t</a> *opts = NULL;
00292     u_hmap_t *hmap = NULL;
00293     u_hmap_o_t *obj = NULL; 
00294     
00295     dbg(<span class="stringliteral">"example_types_custom()"</span>); 
00296 
00297     dbg_err_if (<a class="code" href="group__hmap.html#ga30">u_hmap_opts_new</a>(&amp;opts));
00298     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o4">options</a> |= U_HMAP_OPTS_OWNSDATA | U_HMAP_OPTS_HASH_STRONG;
00299     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o0">size</a> = 3;
00300     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o5">f_hash</a> = &amp;_sample_hash;
00301     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o6">f_comp</a> = &amp;_sample_comp;
00302     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o8">f_str</a> = &amp;_sample_str;
00303 
00304     dbg_err_if (<a class="code" href="group__hmap.html#ga20">u_hmap_new</a>(opts, &amp;hmap));
00305 
00306     MAP_INSERT(hmap, 2, <span class="stringliteral">"two"</span>);
00307     MAP_INSERT(hmap, 1, <span class="stringliteral">"one"</span>);
00308     MAP_INSERT(hmap, 4, <span class="stringliteral">"four"</span>);
00309     MAP_INSERT(hmap, 7, <span class="stringliteral">"seven"</span>);
00310     MAP_INSERT(hmap, 4, <span class="stringliteral">"four2"</span>);
00311     MAP_INSERT(hmap, 3, <span class="stringliteral">"three"</span>);
00312     MAP_INSERT(hmap, 6, <span class="stringliteral">"six"</span>);
00313     MAP_INSERT(hmap, 1, <span class="stringliteral">"one2"</span>);
00314     MAP_INSERT(hmap, 5, <span class="stringliteral">"five"</span>);
00315 
00316     <span class="keywordtype">int</span> x = 1;
00317     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, &amp;x, &amp;obj)); 
00318     dbg(<span class="stringliteral">"hmap['%d'] = %s"</span>, *((<span class="keywordtype">int</span> *) obj-&gt;key), (<span class="keywordtype">char</span> *) obj-&gt;val);
00319     x++;
00320     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, &amp;x, &amp;obj)); 
00321     dbg(<span class="stringliteral">"hmap['%d'] = %s"</span>, *((<span class="keywordtype">int</span> *) obj-&gt;key), (<span class="keywordtype">char</span> *) obj-&gt;val);
00322     x++;
00323     dbg_err_if (<a class="code" href="group__hmap.html#ga26">u_hmap_get</a>(hmap, &amp;x, &amp;obj)); 
00324     dbg(<span class="stringliteral">"hmap['%d'] = %s"</span>, *((<span class="keywordtype">int</span> *) obj-&gt;key), (<span class="keywordtype">char</span> *) obj-&gt;val);
00325     
00326     <a class="code" href="group__hmap.html#ga22">u_hmap_dbg</a>(hmap);
00327     <a class="code" href="group__hmap.html#ga33">u_hmap_opts_free</a>(opts);
00328     <a class="code" href="group__hmap.html#ga29">u_hmap_free</a>(hmap);
00329 
00330     <span class="keywordflow">return</span> 0;
00331 err:
00332     U_FREEF(opts, u_hmap_opts_free);
00333     U_FREEF(hmap, u_hmap_free);
00334 
00335     <span class="keywordflow">return</span> ~0;
00336 <span class="preprocessor">#undef MAP_INSERT</span>
00337 <span class="preprocessor"></span>}
00338 
00339 <span class="keyword">static</span> <span class="keywordtype">int</span> test_resize()
00340 {
00341     <span class="keyword">enum</span> { NUM_ELEMS = 100000, MAX_STR = 256 };
00342     <a class="code" href="structu__hmap__opts__s.html">u_hmap_opts_t</a> *opts = NULL;
00343     u_hmap_t *hmap = NULL;
00344     u_hmap_o_t *obj = NULL;
00345     <span class="keywordtype">int</span> i = 0;
00346     <span class="keywordtype">char</span> key[MAX_STR], 
00347          val[MAX_STR];
00348 
00349     dbg(<span class="stringliteral">"test_resize()"</span>);
00350 
00351     <span class="comment">/* initialise hmap with no options - user owns data by default */</span>
00352     dbg_err_if (<a class="code" href="group__hmap.html#ga30">u_hmap_opts_new</a>(&amp;opts));
00353     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o0">size</a> = 3;
00354     dbg_err_if (<a class="code" href="group__hmap.html#ga20">u_hmap_new</a>(opts, &amp;hmap));
00355 
00356     <span class="comment">/* insert some sample elements */</span>
00357     <span class="keywordflow">for</span> (i = 0; i &lt; NUM_ELEMS; ++i) {
00358         <a class="code" href="group__misc.html#ga12">u_snprintf</a>(key, MAX_STR, <span class="stringliteral">"key%d"</span>, i);
00359         <a class="code" href="group__misc.html#ga12">u_snprintf</a>(val, MAX_STR, <span class="stringliteral">"val%d"</span>, i);
00360         dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>(<a class="code" href="group__misc.html#ga5">u_strdup</a>(key), 
00361                         <a class="code" href="group__misc.html#ga5">u_strdup</a>(val)), NULL));
00362     }
00363 
00364     <span class="keywordflow">for</span> (i = 0; i &lt; NUM_ELEMS; ++i) {
00365         <a class="code" href="group__misc.html#ga12">u_snprintf</a>(key, MAX_STR, <span class="stringliteral">"key%d"</span>, i);
00366         dbg_err_if (u_hmap_del(hmap, key, &amp;obj)); 
00367         <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj-&gt;key);
00368         <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj-&gt;val);
00369         <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj);
00370     }
00371 
00372     <span class="comment">/* free hmap and options */</span>
00373     <a class="code" href="group__hmap.html#ga33">u_hmap_opts_free</a>(opts);
00374     <a class="code" href="group__hmap.html#ga29">u_hmap_free</a>(hmap);
00375     
00376     <span class="keywordflow">return</span> 0;
00377 
00378 err:
00379     U_FREEF(opts, u_hmap_opts_free);
00380     U_FREEF(hmap, u_hmap_free);
00381 
00382     <span class="keywordflow">return</span> ~0;
00383 }
00384 
00385 <span class="keyword">static</span> <span class="keywordtype">int</span> test_linear()
00386 {
00387     <span class="keyword">enum</span> { NUM_ELEMS = 100000, MAX_STR = 256 };
00388     <a class="code" href="structu__hmap__opts__s.html">u_hmap_opts_t</a> *opts = NULL;
00389     u_hmap_t *hmap = NULL;
00390     u_hmap_o_t *obj = NULL;
00391     <span class="keywordtype">int</span> i = 0;
00392     <span class="keywordtype">char</span> key[MAX_STR], 
00393          val[MAX_STR];
00394 
00395     dbg(<span class="stringliteral">"test_linear()"</span>);
00396 
00397     <span class="comment">/* initialise hmap with no options - user owns data by default */</span>
00398     dbg_err_if (<a class="code" href="group__hmap.html#ga30">u_hmap_opts_new</a>(&amp;opts));
00399     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o0">size</a> = 1000;
00400     opts-&gt;<a class="code" href="structu__hmap__opts__s.html#o2">type</a> = U_HMAP_TYPE_LINEAR;
00401     dbg_err_if (<a class="code" href="group__hmap.html#ga20">u_hmap_new</a>(opts, &amp;hmap));
00402 
00403     <span class="comment">/* insert some sample elements */</span>
00404     <span class="keywordflow">for</span> (i = 0; i &lt; NUM_ELEMS; ++i) {
00405         <a class="code" href="group__misc.html#ga12">u_snprintf</a>(key, MAX_STR, <span class="stringliteral">"key%d"</span>, i);
00406         <a class="code" href="group__misc.html#ga12">u_snprintf</a>(val, MAX_STR, <span class="stringliteral">"val%d"</span>, i);
00407         dbg_err_if (<a class="code" href="group__hmap.html#ga25">u_hmap_put</a>(hmap, <a class="code" href="group__hmap.html#ga35">u_hmap_o_new</a>(<a class="code" href="group__misc.html#ga5">u_strdup</a>(key), 
00408                         <a class="code" href="group__misc.html#ga5">u_strdup</a>(val)), NULL));
00409     }
00410 
00411     <span class="keywordflow">for</span> (i = 0; i &lt; NUM_ELEMS; ++i) {
00412         <a class="code" href="group__misc.html#ga12">u_snprintf</a>(key, MAX_STR, <span class="stringliteral">"key%d"</span>, i);
00413         dbg_err_if (u_hmap_del(hmap, key, &amp;obj)); 
00414         <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj-&gt;key);
00415         <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj-&gt;val);
00416         <a class="code" href="group__hmap.html#ga36">u_hmap_o_free</a>(obj);
00417     }
00418 
00419     <span class="comment">/* free hmap and options */</span>
00420     <a class="code" href="group__hmap.html#ga33">u_hmap_opts_free</a>(opts);
00421     <a class="code" href="group__hmap.html#ga29">u_hmap_free</a>(hmap);
00422     
00423     <span class="keywordflow">return</span> 0;
00424 
00425 err:
00426     U_FREEF(opts, u_hmap_opts_free);
00427     U_FREEF(hmap, u_hmap_free);
00428 
00429     <span class="keywordflow">return</span> ~0;
00430 }
00431 
00432 <a class="code" href="group__test.html#ga10">U_TEST_MODULE</a>(hmap)
00433 {
00434     <span class="comment">/* examples */</span>
00435     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( example_static );
00436     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( example_dynamic_own_hmap );
00437     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( example_dynamic_own_user );
00438     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( example_no_overwrite );
00439     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( example_types_custom );
00440 
00441     <span class="comment">/* tests */</span>
00442     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( test_resize );
00443     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( test_linear );
00444 
00445     <span class="keywordflow">return</span> 0;
00446 }
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
