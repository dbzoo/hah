<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: klog.h Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>klog.h</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: klog.h,v 1.19 2006/01/09 12:38:37 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#ifndef _KLONE_LOG_H_</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define _KLONE_LOG_H_</span>
00013 <span class="preprocessor"></span>
00014 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00015 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00016 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00017 
00018 <span class="preprocessor">#ifdef __cplusplus</span>
00019 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00020 <span class="preprocessor">#endif </span>
00021 <span class="preprocessor"></span>
00022 <span class="comment">/* log levels, from low to high */</span>
00023 <span class="keyword">enum</span> {
00024     KLOG_DEBUG,
00025     KLOG_INFO,
00026     KLOG_NOTICE,
00027     KLOG_WARNING,
00028     KLOG_ERR,
00029     KLOG_CRIT,
00030     KLOG_ALERT,
00031     KLOG_EMERG,
00032     KLOG_LEVEL_UNKNOWN    <span class="comment">/* stopper */</span>
00033 };
00034 
00035 <span class="comment">/* internal representation of a 'log' config section */</span>
00036 <span class="keyword">struct </span>klog_args_s
00037 {
00038     <span class="keywordtype">int</span> type;           <span class="comment">/* one of KLOG_TYPEs */</span>
00039     <span class="keywordtype">char</span> *ident;        <span class="comment">/* string prepended to each log msg */</span>
00040     <span class="keywordtype">int</span> threshold;      <span class="comment">/* filter log msgs lower than this level */</span>
00041     size_t mlimit;      <span class="comment">/* max number of log messages (memory) */</span>
00042     <span class="keywordtype">char</span> *fbasename;    <span class="comment">/* basename of log files (postfix varies) */</span>
00043     size_t fsplits;     <span class="comment">/* number of split files (file) */</span>
00044     size_t flimit;      <span class="comment">/* number of log msgs per file (file) */</span>
00045     <span class="keywordtype">int</span> soptions;       <span class="comment">/* log options (syslog) */</span>
00046     <span class="keywordtype">int</span> sfacility;      <span class="comment">/* default facility (syslog's LOG_LOCAL[0-7]) */</span>
00047 <span class="preprocessor">#define KLOG_FACILITY_UNKNOWN   -1</span>
00048 <span class="preprocessor"></span>};  
00049     
00050 <span class="keyword">typedef</span> <span class="keyword">struct </span>klog_args_s klog_args_t;
00051 
00052 <span class="preprocessor">#define KLOG_LN_SZ          512 </span><span class="comment">/* maximum log line size */</span>
00053 <span class="preprocessor">#define KLOG_ID_SZ          8   </span><span class="comment">/* maximum log id size */</span>
00054 <span class="preprocessor">#define KLOG_MLIMIT_DFL     250 </span><span class="comment">/* default number of log lines (mem) */</span>
00055 <span class="preprocessor">#define KLOG_FLIMIT_DFL     250 </span><span class="comment">/* default number of log lines (file) */</span>
00056 <span class="preprocessor">#define KLOG_FSPLITS_DFL    4   </span><span class="comment">/* default number of log files (file) */</span>
00057 
00058 <span class="comment">/* a log line is at most KLOG_LN_SZ + 1 bytes long (including encoded</span>
00059 <span class="comment"> * timestamp and severity) */</span>
00060 <span class="keyword">struct </span>klog_mem_msg_s
00061 {
00062     <span class="keywordtype">int</span> level;          <span class="comment">/* log severity */</span>
00063     time_t timestamp;   <span class="comment">/* message timestamp */</span>
00064     <span class="keywordtype">char</span> *line;         <span class="comment">/* log line */</span>
00065     TAILQ_ENTRY(klog_mem_msg_s) next;
00066 };
00067 
00068 <span class="keyword">typedef</span> <span class="keyword">struct </span>klog_mem_msg_s klog_mem_msg_t;
00069 
00070 <span class="comment">/* klog_mem_msg_s' organised in a fixed size buffer with FIFO discard policy */</span>
00071 <span class="keyword">struct </span>klog_mem_s
00072 {
00073     size_t bound;                           <span class="comment">/* FIFO buffer max size */</span>
00074     size_t nmsgs;                           <span class="comment">/* # of msgs in buffer */</span>
00075 <span class="preprocessor">#define KLOG_MEM_FULL(klm)  ((klm)-&gt;nmsgs &gt;= (klm)-&gt;bound)</span>
00076 <span class="preprocessor"></span>    TAILQ_HEAD(mh, klog_mem_msg_s) msgs;    <span class="comment">/* the list of msgs */</span>
00077 };
00078 
00079 <span class="keyword">typedef</span> <span class="keyword">struct </span>klog_mem_s klog_mem_t;
00080 
00081 <span class="keyword">struct </span>klog_file_s
00082 {
00083     size_t npages;  <span class="comment">/* number of available log pages */</span>
00084     size_t nlines;  <span class="comment">/* number of available log lines per page */</span>
00085     size_t wpageid; <span class="comment">/* working page id */</span>
00086     size_t offset;  <span class="comment">/* write offset in working page */</span>
00087     <span class="keywordtype">char</span> basename[U_FILENAME_MAX];
00088 <span class="preprocessor">#define KLOG_PAGE_FULL(klf)  ((klf)-&gt;offset &gt;= (klf)-&gt;nlines)</span>
00089 <span class="preprocessor"></span>    FILE *wfp;      <span class="comment">/* working page file pointer */</span>
00090 };
00091 
00092 <span class="keyword">typedef</span> <span class="keyword">struct </span>klog_file_s klog_file_t;
00093 
00094 <span class="comment">/* a syslog(3) wrapper  */</span>
00095 <span class="keyword">struct </span>klog_syslog_s
00096 {
00097     <span class="keywordtype">int</span> facility;   <span class="comment">/* default syslog(3) facility */</span>
00098     <span class="keywordtype">int</span> logopt;     <span class="comment">/* log options bit field */</span>
00099 };
00100 
00101 <span class="keyword">typedef</span> <span class="keyword">struct </span>klog_syslog_s klog_syslog_t;
00102 
00103 <span class="keyword">struct </span>klog_s
00104 {
00105     <span class="keyword">enum</span> { 
00106         KLOG_TYPE_UNKNOWN, 
00107         KLOG_TYPE_MEM, 
00108         KLOG_TYPE_FILE, 
00109         KLOG_TYPE_SYSLOG 
00110     } type;
00111 
00112 <span class="preprocessor">#define IS_KLOG_TYPE(t) (t &gt;= KLOG_TYPE_MEM &amp;&amp; t &lt;= KLOG_TYPE_SYSLOG)</span>
00113 <span class="preprocessor"></span>
00114     <span class="keywordtype">int</span> threshold;                  <span class="comment">/* min unfiltered level */</span>
00115     <span class="keywordtype">char</span> ident[KLOG_ID_SZ + 1];     <span class="comment">/* id string prepended to each log msg */</span>
00116 
00117     <span class="comment">/* data private to each log type */</span>
00118     <span class="keyword">union</span>
00119 <span class="keyword">    </span>{
00120         klog_mem_t *m;
00121         klog_syslog_t *s;
00122         klog_file_t *f; 
00123     } u;
00124 
00125     <span class="comment">/* availability of the following depends on klog_s type */</span>
00126     int (*cb_log) (<span class="keyword">struct </span>klog_s *, <span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *, va_list);
00127     void (*cb_close) (<span class="keyword">struct </span>klog_s *);
00128     int (*cb_getln) (<span class="keyword">struct </span>klog_s *, size_t, <span class="keywordtype">char</span>[]);
00129     ssize_t (*cb_countln) (<span class="keyword">struct </span>klog_s *);
00130     int (*cb_clear) (<span class="keyword">struct </span>klog_s *);
00131     int (*cb_flush) (<span class="keyword">struct </span>klog_s *);
00132 };
00133 
00134 <span class="keyword">typedef</span> <span class="keyword">struct </span>klog_s klog_t;
00135 
00136 <span class="keywordtype">int</span> klog_open (klog_args_t *ka, klog_t **pkl);
00137 <span class="keywordtype">int</span> klog (klog_t *kl, <span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg, ...);
00138 <span class="keywordtype">void</span> klog_close (klog_t *kl);
00139 
00140 <span class="comment">/* file device specific */</span>
00141 <span class="keywordtype">int</span> klog_flush (klog_t *kl);
00142 
00143 <span class="comment">/* mem device specific */</span>
00144 <span class="keywordtype">int</span> klog_getln (klog_t *kl, size_t nth, <span class="keywordtype">char</span> ln[]);
00145 ssize_t klog_countln (klog_t *kl);
00146 <span class="keywordtype">int</span> klog_clear (klog_t *kl);
00147 
00148 <span class="keywordtype">int</span> klog_args (u_config_t *logsect, klog_args_t **pka);
00149 <span class="keywordtype">void</span> klog_args_free (klog_args_t *ka);
00150 <span class="keywordtype">int</span> klog_open_from_config (u_config_t *ls, klog_t **pkl);
00151 
00152 <span class="preprocessor">#ifdef __cplusplus</span>
00153 <span class="preprocessor"></span>}
00154 <span class="preprocessor">#endif </span>
00155 <span class="preprocessor"></span>
00156 <span class="preprocessor">#endif  </span><span class="comment">/* _KLONE_LOG_H_ */</span>
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


