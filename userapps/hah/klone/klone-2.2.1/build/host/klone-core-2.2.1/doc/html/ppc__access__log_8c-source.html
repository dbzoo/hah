<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: ppc_access_log.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>ppc_access_log.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: ppc_access_log.c,v 1.1 2007/11/09 22:06:26 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
00013 <span class="preprocessor">#include &lt;klone/klog.h&gt;</span>
00014 <span class="preprocessor">#include &lt;klone/context.h&gt;</span>
00015 <span class="preprocessor">#include &lt;klone/server.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/ppc.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/ppc_cmd.h&gt;</span>
00018 <span class="preprocessor">#include &lt;klone/vhost.h&gt;</span>
00019 <span class="preprocessor">#include &lt;klone/server_ppc_cmd.h&gt;</span>
00020 <span class="preprocessor">#include "server_s.h"</span>
00021 
00022 <span class="comment">/* struct used for ppc command PPC_CMD_LOG_ADD */</span>
00023 <span class="keyword">struct </span>ppc_access_log_s
00024 {
00025     <span class="keywordtype">int</span> bid;                        <span class="comment">/* calling backend ID       */</span>
00026     <span class="keywordtype">int</span> vhostid;                    <span class="comment">/* vhost ID                 */</span>
00027     <span class="keywordtype">char</span> log[U_MAX_LOG_LENGTH];     <span class="comment">/* log line                 */</span>
00028 };
00029 
00030 <span class="keyword">typedef</span> <span class="keyword">struct </span>ppc_access_log_s ppc_access_log_t;
00031 
00032 <span class="comment">/* client function */</span>
00033 <span class="keywordtype">int</span> server_ppc_cmd_access_log(server_t *s, <span class="keywordtype">int</span> bid, <span class="keywordtype">int</span> vhostid,
00034         <span class="keyword">const</span> <span class="keywordtype">char</span> *str)
00035 {
00036     ppc_access_log_t la;
00037 
00038     nop_err_if (s == NULL);
00039     nop_err_if (s-&gt;ppc == NULL);
00040     nop_err_if (str == NULL);
00041 
00042     memset(&amp;la, 0, <span class="keyword">sizeof</span>(ppc_access_log_t));
00043 
00044     la.bid = ctx-&gt;backend-&gt;id;
00045     la.vhostid = vhostid;
00046     strncpy(la.log, str, U_MAX_LOG_LENGTH);
00047     la.log[U_MAX_LOG_LENGTH -1] = 0;
00048 
00049     <span class="comment">/* send the command request */</span>
00050     nop_err_if(ppc_write(s-&gt;ppc, ctx-&gt;pipc, PPC_CMD_ACCESS_LOG, (<span class="keywordtype">char</span>*)&amp;la, 
00051         <span class="keyword">sizeof</span>(la)) &lt; 0);
00052 
00053     <span class="keywordflow">return</span> 0;
00054 err:
00055     <span class="keywordflow">return</span> ~0;
00056 }
00057 
00058 <span class="comment">/* [parent] log a new message */</span>
00059 <span class="keywordtype">int</span> server_ppc_cb_access_log(ppc_t *ppc, <span class="keywordtype">int</span> fd, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmd, <span class="keywordtype">char</span> *data, 
00060     size_t size, <span class="keywordtype">void</span> *vso)
00061 {
00062     server_t *s;
00063     ppc_access_log_t *pla;
00064     backend_t *be;
00065     vhost_t *vhost;
00066     vhost_list_t *vhost_list;
00067     http_t *http;
00068 
00069     u_unused_args(ppc, fd, cmd, size);
00070 
00071     nop_err_if (vso == NULL);
00072     nop_err_if (data == NULL);
00073 
00074     pla = (ppc_access_log_t*) data;
00075     s = (server_t *) vso;
00076 
00077     <span class="comment">/* get the http object */</span>
00078     <span class="keywordflow">if</span>(!server_get_backend_by_id(s, pla-&gt;bid, &amp;be) &amp;&amp; be-&gt;arg)
00079         http = (http_t*)be-&gt;arg;
00080 
00081     dbg_err_if((vhost_list = http_get_vhost_list(http)) == NULL);
00082 
00083     dbg_err_if((vhost = vhost_list_get_n(vhost_list, pla-&gt;vhostid)) == NULL);
00084 
00085     <span class="comment">/* log the line */</span>
00086     <span class="keywordflow">if</span>(vhost-&gt;klog)
00087         nop_err_if(klog(vhost-&gt;klog, KLOG_INFO, <span class="stringliteral">"%s"</span>, pla-&gt;log));
00088 
00089     <span class="keywordflow">return</span> 0;
00090 err:
00091     <span class="keywordflow">return</span> ~0;
00092 }
00093 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


