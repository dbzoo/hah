<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: main.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>main.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: main.c,v 1.44 2008/10/18 17:23:32 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00013 <span class="preprocessor">#ifdef HAVE_SYS_DIR</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/dir.h&gt;</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00017 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00018 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00019 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00020 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00021 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00022 <span class="preprocessor">#ifdef HAVE_UNISTD</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_GETOPT</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#include &lt;getopt.h&gt;</span>
00027 <span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00029 <span class="preprocessor">#include &lt;klone/os.h&gt;</span>
00030 <span class="preprocessor">#include &lt;klone/request.h&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="response_8h.html">klone/response.h</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;klone/translat.h&gt;</span>
00033 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00034 <span class="preprocessor">#include &lt;klone/run.h&gt;</span>
00035 <span class="preprocessor">#include &lt;klone/mime_map.h&gt;</span>
00036 <span class="preprocessor">#include &lt;klone/version.h&gt;</span>
00037 <span class="preprocessor">#include "pm.h"</span>
00038 
00039 <span class="keywordtype">int</span> facility = LOG_LOCAL0;
00040 
00041 <span class="comment">/* command list enums */</span>
00042 <span class="keyword">enum</span> command_e { CMD_UNKNOWN, CMD_TRANS, CMD_IMPORT };
00043 
00044 <span class="comment">/* runtime flags */</span>
00045 <span class="keyword">enum</span> flags_e { FLAG_NONE, FLAG_VERBOSE };
00046 
00047 <span class="keyword">typedef</span> <span class="keyword">struct </span>
00048 <span class="keyword"></span>{
00049     <span class="keywordtype">char</span> *file_in, *file_out;   <span class="comment">/* [trans] input, output file       */</span>
00050     <span class="keywordtype">char</span> *depend_out;           <span class="comment">/* [trans] depend output file       */</span>
00051     <span class="keywordtype">char</span> *uri;                  <span class="comment">/* [trans] translated file uri      */</span>
00052     <span class="keywordtype">int</span> verbose;                <span class="comment">/* &gt;0 when verbose mode is on       */</span>
00053     <span class="keywordtype">char</span> **arg;                 <span class="comment">/* argv                             */</span>
00054     size_t narg;                <span class="comment">/* argc                             */</span>
00055     <span class="keywordtype">int</span> cmd;                    <span class="comment">/* command to run                   */</span>
00056     <span class="keywordtype">char</span> *base_uri;             <span class="comment">/* site base uri                    */</span>
00057     <span class="keywordtype">int</span> encrypt;                <span class="comment">/* &gt;0 when encryption is enabled    */</span>
00058     <span class="keywordtype">int</span> compress;               <span class="comment">/* &gt;0 when compress is enabled      */</span>
00059     pm_t *comp_patt;            <span class="comment">/* compress file pattern            */</span>
00060     pm_t *enc_patt;             <span class="comment">/* encrypt file pattern             */</span>
00061     pm_t *excl_patt;            <span class="comment">/* exclude file pattern             */</span>
00062     <span class="keywordtype">char</span> *key_file;             <span class="comment">/* encryption key file name         */</span>
00063     io_t *iom, *iod, *ior;      <span class="comment">/* io makefile, io deps             */</span>
00064     size_t ndir, nfile;         <span class="comment">/* dir and file count               */</span>
00065     size_t nexcl;               <span class="comment">/* # of excluded files (-x)         */</span>
00066 } context_t;
00067 
00068 context_t *ctx;
00069 
00070 <span class="preprocessor">#define KL1_FILE_FMT "pg_%s.%s"</span>
00071 <span class="preprocessor"></span>
00072 <span class="preprocessor">#define usage_if(expr)  if(expr) usage(); </span>
00073 <span class="preprocessor"></span>
00074 <span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>)
00075 {
00076     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * us = 
00077 <span class="stringliteral">"Usage: klone [-hvV] -c COMMAND OPTIONS ARGUMENTS\n"</span>
00078 <span class="stringliteral">"Version: %s - Copyright (c) 2005-2008 KoanLogic s.r.l.\n"</span>
00079 <span class="stringliteral">"All rights reserved.\n"</span>
00080 <span class="stringliteral">"\n"</span>
00081 <span class="stringliteral">"       -h            display this help\n"</span>
00082 <span class="stringliteral">"       -v            verbose mode\n"</span>
00083 <span class="stringliteral">"       -V            print KLone version and exit\n"</span>
00084 <span class="stringliteral">"       -c command    command to execute (see COMMAND LIST)\n"</span>
00085 <span class="stringliteral">"\n"</span>
00086 <span class="stringliteral">"\n"</span>
00087 <span class="stringliteral">"    COMMAND LIST:\n"</span>
00088 <span class="stringliteral">"       import        import a directory tree in the embedded filesystem\n"</span>
00089 <span class="stringliteral">"       translate     convert a file or a dynamic web page to a C file\n"</span>
00090 <span class="stringliteral">"\n"</span>
00091 <span class="stringliteral">"\n"</span>
00092 <span class="stringliteral">"    COMMANDS SYNTAX:\n"</span>
00093 <span class="stringliteral">"\n"</span>
00094 <span class="stringliteral">"       import OPTIONS dir\n"</span>
00095 <span class="stringliteral">"         -b URI      base URI\n"</span>
00096 <span class="stringliteral">"         -x pattern  exclude all files whose URI match the given pattern (*)\n"</span>
00097 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00098 <span class="preprocessor"></span><span class="stringliteral">"         -e pattern  encrypt all files whose URI match the given pattern (*)\n"</span>
00099 <span class="stringliteral">"         -k key_file encryption key filename\n"</span>
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_LIBZ</span>
00102 <span class="preprocessor"></span><span class="stringliteral">"         -z          compress all compressable content (based on MIME types)\n"</span>
00103 <span class="stringliteral">"         -Z pattern  compress all files whose URI match the given pattern (*)\n"</span>
00104 <span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span><span class="stringliteral">"         dir         directory tree path\n"</span>
00106 <span class="stringliteral">"\n"</span>
00107 <span class="stringliteral">"         (*) may be used more then once\n"</span>
00108 <span class="stringliteral">"\n"</span>
00109 <span class="stringliteral">"       translate OPTIONS\n"</span>
00110 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00111 <span class="preprocessor"></span><span class="stringliteral">"         -E          encrypt file content\n"</span>
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span><span class="stringliteral">"         -i file     input file\n"</span>
00114 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00115 <span class="preprocessor"></span><span class="stringliteral">"         -k key_file encryption key filename\n"</span>
00116 <span class="preprocessor">#endif</span>
00117 <span class="preprocessor"></span><span class="stringliteral">"         -o file     output file\n"</span>
00118 <span class="stringliteral">"         -u URI      URI of translated page\n"</span>
00119 <span class="stringliteral">"                     (KLONE_CIPHER_KEY environ var is used if not provided)\n"</span>
00120 <span class="preprocessor">#ifdef HAVE_LIBZ</span>
00121 <span class="preprocessor"></span><span class="stringliteral">"         -z          compress file content\n"</span>
00122 <span class="preprocessor">#endif</span>
00123 <span class="preprocessor"></span><span class="stringliteral">"\n"</span>;
00124 
00125     fprintf(stderr, us, <a class="code" href="group__ut.html#ga27">klone_version</a>());
00126 
00127     exit(EXIT_FAILURE);
00128 }
00129 
00130 <span class="keyword">static</span> <span class="keywordtype">void</span> remove_trailing_slash(<span class="keywordtype">char</span> *s)
00131 {
00132     size_t len;
00133     
00134     dbg_ifb (s == NULL) <span class="keywordflow">return</span>;
00135     
00136     len = strlen(s);
00137     <span class="keywordflow">if</span>(len &amp;&amp; s[len - 1] == <span class="charliteral">'/'</span>)
00138         s[len - 1] = 0;
00139 }
00140 
00141 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_opt(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00142 {
00143     <span class="keywordtype">int</span> ret;
00144     <span class="keywordtype">char</span> opts[512];
00145 
00146     <span class="keywordflow">if</span>(argc == 1)
00147         usage();
00148 
00149     <span class="comment">/* common switches */</span>
00150     strcpy(opts, <span class="stringliteral">"hvVx:b:i:o:u:c:d:"</span>);
00151 
00152     <span class="comment">/* encryption switches */</span>
00153 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00154 <span class="preprocessor"></span>    strcat(opts, <span class="stringliteral">"k:e:E"</span>);
00155 <span class="preprocessor">#endif</span>
00156 <span class="preprocessor"></span>
00157     <span class="comment">/* compression switches */</span>
00158 <span class="preprocessor">#ifdef HAVE_LIBZ</span>
00159 <span class="preprocessor"></span>    strcat(opts, <span class="stringliteral">"zZ:"</span>);
00160 <span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162     <span class="keywordflow">while</span>((ret = getopt(argc, argv, opts)) != -1)
00163     {
00164         <span class="keywordflow">switch</span>(ret)
00165         {
00166         <span class="keywordflow">case</span> <span class="charliteral">'v'</span>: <span class="comment">/* verbose on */</span>
00167             ctx-&gt;verbose++;
00168             <span class="keywordflow">break</span>;
00169         <span class="keywordflow">case</span> <span class="charliteral">'V'</span>: <span class="comment">/* print name/version info and exit */</span>
00170             u_print_version_and_exit();
00171             <span class="keywordflow">break</span>;
00172 
00173 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00174 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <span class="charliteral">'E'</span>: <span class="comment">/* encryption on */</span>
00175             ctx-&gt;encrypt = 1;
00176             <span class="keywordflow">break</span>;
00177         <span class="keywordflow">case</span> <span class="charliteral">'e'</span>: <span class="comment">/* encrypt file pattern */</span>
00178             dbg_err_if(pm_add(ctx-&gt;enc_patt, u_strdup(optarg)));
00179             <span class="keywordflow">break</span>;
00180         <span class="keywordflow">case</span> <span class="charliteral">'k'</span>: <span class="comment">/* encryption key filename */</span>
00181             ctx-&gt;key_file = u_strdup(optarg);
00182             warn_err_if(ctx-&gt;key_file == NULL);
00183             <span class="keywordflow">break</span>;
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>
00186 <span class="preprocessor">#ifdef HAVE_LIBZ</span>
00187 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <span class="charliteral">'Z'</span>: <span class="comment">/* compress file pattern */</span>
00188             ctx-&gt;compress = 1;
00189             dbg_err_if(pm_add(ctx-&gt;comp_patt, u_strdup(optarg)));
00190             <span class="keywordflow">break</span>;
00191         <span class="keywordflow">case</span> <span class="charliteral">'z'</span>: <span class="comment">/* compress */</span>
00192             ctx-&gt;compress = 1;
00193             <span class="keywordflow">break</span>;
00194 <span class="preprocessor">#endif</span>
00195 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <span class="charliteral">'c'</span>: <span class="comment">/* command */</span>
00196             <span class="keywordflow">if</span>(!strcasecmp(optarg, <span class="stringliteral">"import"</span>))
00197                 ctx-&gt;cmd = CMD_IMPORT;
00198             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(optarg, <span class="stringliteral">"translate"</span>))
00199                 ctx-&gt;cmd = CMD_TRANS;
00200             <span class="keywordflow">else</span>
00201                 con_err(<span class="stringliteral">"unknown command: %s"</span>, optarg);
00202             <span class="keywordflow">break</span>;
00203         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>: <span class="comment">/* input file */</span>
00204             ctx-&gt;file_in = u_strdup(optarg);
00205             warn_err_if(ctx-&gt;file_in == NULL);
00206             <span class="keywordflow">break</span>;
00207         <span class="keywordflow">case</span> <span class="charliteral">'x'</span>: <span class="comment">/* exclude pattern */</span>
00208             dbg_err_if(pm_add(ctx-&gt;excl_patt, u_strdup(optarg)));
00209             <span class="keywordflow">break</span>;
00210         <span class="keywordflow">case</span> <span class="charliteral">'b'</span>: <span class="comment">/* base_uri */</span>
00211             ctx-&gt;base_uri = u_strdup(optarg);
00212             warn_err_if(ctx-&gt;base_uri == NULL);
00213 
00214             <span class="keywordflow">if</span>(ctx-&gt;base_uri[0] != <span class="charliteral">'/'</span>)
00215                 klone_die(<span class="stringliteral">"base URI must be absolute "</span>
00216                           <span class="stringliteral">"(i.e. must start with a '/')"</span>);
00217 
00218             remove_trailing_slash(ctx-&gt;base_uri);
00219 
00220             <span class="keywordflow">break</span>;
00221         <span class="keywordflow">case</span> <span class="charliteral">'o'</span>: <span class="comment">/* output file */</span>
00222             ctx-&gt;file_out = u_strdup(optarg);
00223             warn_err_if(ctx-&gt;file_out == NULL);
00224             <span class="keywordflow">break</span>;
00225         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>: <span class="comment">/* kld depend output file */</span>
00226             ctx-&gt;depend_out = u_strdup(optarg);
00227             warn_err_if(ctx-&gt;depend_out == NULL);
00228             <span class="keywordflow">break</span>;
00229         <span class="keywordflow">case</span> <span class="charliteral">'u'</span>: <span class="comment">/* translated page uri */</span>
00230             <span class="comment">/* skip the first char to avoid MSYS path translation bug</span>
00231 <span class="comment">             * (see klone-site.c) */</span>
00232             ctx-&gt;uri = u_strdup(1+optarg);
00233             warn_err_if(ctx-&gt;uri == NULL);
00234 
00235             <span class="keywordflow">if</span>(ctx-&gt;uri[0] != <span class="charliteral">'/'</span>)
00236                 klone_die(<span class="stringliteral">"URI must be absolute (i.e. must start with a '/')"</span>);
00237 
00238             remove_trailing_slash(ctx-&gt;uri);
00239 
00240             <span class="keywordflow">break</span>;
00241         <span class="keywordflow">default</span>:
00242         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>: 
00243             usage();
00244         }
00245     }
00246 
00247     klone_die_if(ctx-&gt;cmd == 0, <span class="stringliteral">"missing command argument (-c)"</span>);
00248     ctx-&gt;narg = argc - optind;  <span class="comment">/* # of args left */</span>
00249     ctx-&gt;arg = argv + optind;   
00250 
00251     <span class="keywordflow">return</span> 0;
00252 err:
00253     <span class="keywordflow">return</span> ~0;
00254 }
00255 
00256 <span class="keyword">static</span> <span class="keywordtype">int</span> set_key_from_file(trans_info_t *pti, <span class="keyword">const</span> <span class="keywordtype">char</span> *key_file)
00257 {
00258     io_t *io = NULL;
00259 
00260     dbg_err_if (pti == NULL);
00261     dbg_err_if (key_file == NULL);
00262     
00263     dbg_err_if(<a class="code" href="group__ut.html#ga35">u_file_open</a>(key_file, O_RDONLY, &amp;io));
00264 
00265     dbg_err_if(<a class="code" href="group__basic.html#ga18">io_read</a>(io, pti-&gt;key, CODEC_CIPHER_KEY_SIZE) &lt;= 0);
00266     
00267     <a class="code" href="group__basic.html#ga14">io_free</a>(io);
00268 
00269     <span class="keywordflow">return</span> 0;
00270 err:
00271     <span class="keywordflow">return</span> ~0;
00272 }
00273 
00274 <span class="keyword">static</span> <span class="keywordtype">int</span> command_trans(<span class="keywordtype">void</span>)
00275 {
00276     trans_info_t ti;
00277     <span class="keyword">const</span> mime_map_t *mm;
00278     <span class="keyword">struct </span>stat st;
00279     <span class="keywordtype">char</span> *key_env;
00280     <span class="keywordtype">int</span> key_found = 0;
00281 
00282     <span class="keywordflow">if</span>(ctx-&gt;narg != 0)
00283         usage();    <span class="comment">/* no argument allowed */</span>
00284 
00285     memset(&amp;ti, 0, <span class="keyword">sizeof</span>(trans_info_t));
00286 
00287     klone_die_if(!ctx-&gt;file_in, <span class="stringliteral">"input file name required (-i file)"</span>);
00288     klone_die_if(!ctx-&gt;file_out, <span class="stringliteral">"output file name required (-o file)"</span>);
00289     klone_die_if(!ctx-&gt;uri, <span class="stringliteral">"translated page URI required (-u uri)"</span>);
00290 
00291     <span class="keywordflow">if</span>(ctx-&gt;verbose)
00292         con(<span class="stringliteral">"translating %s to %s (uri: %s)"</span>, ctx-&gt;file_in, ctx-&gt;file_out, 
00293             ctx-&gt;uri);
00294 
00295     <span class="comment">/* input file */</span>
00296     strncpy(ti.file_in, ctx-&gt;file_in, U_FILENAME_MAX);
00297 
00298     <span class="comment">/* output file */</span>
00299     strncpy(ti.file_out, ctx-&gt;file_out, U_FILENAME_MAX);
00300 
00301     <span class="comment">/* kld depend file */</span>
00302     <span class="keywordflow">if</span>(ctx-&gt;depend_out)
00303         strncpy(ti.depend_out, ctx-&gt;depend_out, U_FILENAME_MAX);
00304 
00305     <span class="comment">/* uri */</span>
00306     strncpy(ti.uri, ctx-&gt;uri, URI_BUFSZ);
00307 
00308     <span class="comment">/* zero out the key (some byte could not be overwritten with small keys) */</span>
00309     memset(ti.key, 0, CODEC_CIPHER_KEY_SIZE);
00310 
00311     <span class="comment">/* sanity checks */</span>
00312     con_err_ifm(ctx-&gt;key_file &amp;&amp; !ctx-&gt;encrypt, <span class="stringliteral">"-k used but -E is missing"</span>);
00313 
00314     <span class="comment">/* encryption key */</span>
00315     key_env = getenv(<span class="stringliteral">"KLONE_CIPHER_KEY"</span>);
00316     <span class="keywordflow">if</span>(key_env &amp;&amp; strlen(key_env))
00317     {
00318         key_found = 1;
00319         strncpy(ti.key, key_env, CODEC_CIPHER_KEY_SIZE);
00320     }
00321 
00322     <span class="comment">/* if -k has been used the overwrite KLONE_CIPHER_KEY env var (if present)*/</span>
00323     <span class="keywordflow">if</span>(ctx-&gt;key_file)
00324     {
00325         key_found = 1;
00326         con_err_ifm(set_key_from_file(&amp;ti, ctx-&gt;key_file), 
00327             <span class="stringliteral">"error reading key file [%s]"</span>, ctx-&gt;key_file);
00328     }
00329 
00330     <span class="keywordflow">if</span>(ctx-&gt;encrypt)
00331     {
00332         <span class="keywordflow">if</span>(!key_found)
00333             con_err(<span class="stringliteral">"encryption key required (use -k or KLONE_CIPHER_KEY "</span>
00334                     <span class="stringliteral">"environ variable)"</span>);
00335         ti.encrypt = 1;
00336     }
00337 
00338     <span class="comment">/* set MIME type */</span>
00339     <span class="keywordflow">if</span>((mm = <a class="code" href="group__ut.html#ga48">u_get_mime_map</a>(ctx-&gt;file_in)) != NULL)
00340         strncpy(ti.mime_type, mm-&gt;mime_type, MIME_BUFSZ);
00341     <span class="keywordflow">else</span>
00342         strncpy(ti.mime_type, <span class="stringliteral">"application/octet-stream"</span>, MIME_BUFSZ);
00343 
00344     <span class="comment">/* compress if requested and the file is compressable (by MIME type) */</span>
00345     <span class="keywordflow">if</span>(ctx-&gt;compress)
00346         ti.comp = 1;
00347 
00348     <span class="comment">/* be sure that the input file exists */</span>
00349     klone_die_if(stat(ctx-&gt;file_in, &amp;st), <span class="stringliteral">"input file not found"</span>);
00350 
00351     ti.file_size = st.st_size;
00352     ti.mtime = st.st_mtime; 
00353 
00354     <span class="comment">/* translate it */</span>
00355     dbg_err_if(translate(&amp;ti));
00356 
00357     <span class="keywordflow">return</span> 0;
00358 err:
00359     <span class="comment">/* delete output file on error */</span>
00360     u_remove(ti.file_out);
00361     con(<span class="stringliteral">" "</span>);
00362     <span class="keywordflow">return</span> ~0;
00363 }
00364 
00365 <span class="keyword">static</span> <span class="keywordtype">int</span> is_cpp(<span class="keyword">const</span> <span class="keywordtype">char</span> *file_in)
00366 {
00367     size_t l;
00368 
00369     dbg_err_if (file_in == NULL);
00370 
00371     l = strlen(file_in);
00372     <span class="keywordflow">if</span>(l &lt; 4)
00373         <span class="keywordflow">return</span> 0;
00374 
00375     <span class="comment">/* if the file name ends with "[Cc][Cc]" consider it a c++ file */</span>
00376     <span class="keywordflow">if</span>(tolower(file_in[--l]) == <span class="charliteral">'c'</span> &amp;&amp; tolower(file_in[--l]) == <span class="charliteral">'c'</span>)
00377         <span class="keywordflow">return</span> 1; <span class="comment">/* c++ */</span>
00378 
00379 err:
00380     <span class="keywordflow">return</span> 0;
00381 }
00382 
00383 
00384 <span class="keyword">static</span> <span class="keywordtype">int</span> cb_file(<span class="keyword">struct</span> dirent *de, <span class="keyword">const</span> <span class="keywordtype">char</span> *path , <span class="keywordtype">void</span> *arg)
00385 {
00386     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *prefix = <span class="stringliteral">"$(srcdir)"</span>;
00387     <span class="keyword">const</span> mime_map_t *mm;
00388     <span class="keywordtype">char</span> uri_md5[MD5_DIGEST_BUFSZ];
00389     <span class="keywordtype">char</span> file_in[U_FILENAME_MAX], uri[URI_BUFSZ], *base_uri = (<span class="keywordtype">char</span>*)arg;
00390     <span class="keywordtype">char</span> fullpath[U_FILENAME_MAX];
00391     <span class="keyword">const</span> <span class="keywordtype">char</span> *ext;
00392     <span class="keywordtype">int</span> is_a_script, enc = 0, zip = 0;
00393 
00394     dbg_err_if (de == NULL);
00395     dbg_err_if (path == NULL);
00396     dbg_err_if (arg == NULL);
00397 
00398     dbg_err_if(u_snprintf(fullpath, U_FILENAME_MAX, <span class="stringliteral">"%s/%s"</span>, path, de-&gt;d_name));
00399 
00400     <span class="comment">/* input filename (makefile-style) */</span>
00401     dbg_err_if(translate_makefile_filepath(fullpath, prefix, file_in, 
00402         <span class="keyword">sizeof</span>(file_in)));
00403 
00404     <span class="comment">/* base uri */</span>
00405     dbg_err_if(u_snprintf(uri, URI_BUFSZ, <span class="stringliteral">"%s/%s"</span>, base_uri, de-&gt;d_name));
00406     dbg_err_if(<a class="code" href="group__ut.html#ga42">u_md5</a>(uri, strlen(uri), uri_md5));
00407 
00408     <span class="comment">/* if the URI match the given exclude pattern then skip it */</span>
00409     <span class="keywordflow">if</span>(!pm_is_empty(ctx-&gt;excl_patt) &amp;&amp; pm_match(ctx-&gt;excl_patt, uri))
00410     {
00411         <span class="keywordflow">if</span>(ctx-&gt;verbose)
00412             con(<span class="stringliteral">"%s skipped"</span>, uri);
00413 
00414         ctx-&gt;nexcl++;
00415 
00416         <span class="keywordflow">return</span> 0; <span class="comment">/* skip it */</span>
00417     } 
00418 
00419     is_a_script = translate_is_a_script(de-&gt;d_name);
00420 
00421     ctx-&gt;nfile++;
00422 
00423     <span class="comment">/* if the URI match the given encrypt pattern then encrypt it */</span>
00424     <span class="keywordflow">if</span>(!pm_is_empty(ctx-&gt;enc_patt) &amp;&amp; pm_match(ctx-&gt;enc_patt, uri))
00425         enc = 1;
00426 
00427     <span class="keywordflow">if</span>(ctx-&gt;compress) <span class="comment">/* -z or -Z have been used */</span>
00428     {
00429         <span class="comment">/* if the URI match the given compress pattern then compress it */</span>
00430         <span class="keywordflow">if</span>(!pm_is_empty(ctx-&gt;comp_patt))
00431         {   <span class="comment">/* compression enabled basing on file URI pattern */</span>
00432             <span class="keywordflow">if</span>(pm_match(ctx-&gt;comp_patt, uri))
00433                 zip = 1;
00434         } <span class="keywordflow">else</span> {
00435             <span class="comment">/* compression enabled basing on URI MIME types */</span>
00436             <span class="keywordflow">if</span>((mm = <a class="code" href="group__ut.html#ga48">u_get_mime_map</a>(uri)) != NULL)
00437                 zip = mm-&gt;comp;
00438         }
00439     }
00440 
00441     <span class="comment">/* print out some info */</span>
00442     <span class="keywordflow">if</span>(ctx-&gt;verbose == 1)
00443         con(<span class="stringliteral">"%s (encrypted: %s, compressed: %s)"</span>, 
00444             uri, enc ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>, zip ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>);
00445     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ctx-&gt;verbose &gt; 1)
00446         con(<span class="stringliteral">"%s -&gt; %s (encrypted: %s, compressed: %s)"</span>, 
00447             file_in + strlen(prefix), uri, 
00448             enc ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>, zip ? <span class="stringliteral">"yes"</span> : <span class="stringliteral">"no"</span>);
00449 
00450     ext = <a class="code" href="group__ut.html#ga49">u_match_ext</a>(file_in, <span class="stringliteral">"klx"</span>) ? <span class="stringliteral">"cc"</span> : <span class="stringliteral">"c"</span>;
00451 
00452     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(ctx-&gt;iom, <span class="stringliteral">" \\\n"</span> KL1_FILE_FMT, uri_md5, ext) &lt; 0);
00453 
00454     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(ctx-&gt;ior, <span class="stringliteral">"KLONE_REGISTER(action,%s);\n"</span>, uri_md5) &lt;0);
00455 
00456     <span class="comment">/* we're adding a '/' before the uri (that will be removed by klone.exe) </span>
00457 <span class="comment">     * to avoid MSYS (win32) automatic path translation oddity */</span>
00458     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(ctx-&gt;iod, 
00459             <span class="stringliteral">"\n"</span> KL1_FILE_FMT 
00460             <span class="stringliteral">": %s\n\t$(KLONE) -c translate -i $&lt; -o $@ %s -u /%s %s %s %s %s\n"</span>
00461             <span class="stringliteral">"%s"</span>, <span class="comment">/* compiler depend-file generation command */</span>
00462             uri_md5, ext, file_in, 
00463             is_a_script ? <span class="stringliteral">"-d $@.kld"</span> : <span class="stringliteral">""</span>,
00464             uri, 
00465             zip ? <span class="stringliteral">"-z"</span> : <span class="stringliteral">""</span>,
00466             enc ? <span class="stringliteral">"-E"</span> : <span class="stringliteral">""</span>, 
00467             enc &amp;&amp; ctx-&gt;key_file ? <span class="stringliteral">"-k"</span> : <span class="stringliteral">""</span>, 
00468             enc &amp;&amp; ctx-&gt;key_file ? ctx-&gt;key_file  : <span class="stringliteral">""</span>,
00469             is_a_script ? <span class="stringliteral">"\t$(MKDEP) -f $@.d $(CFLAGS) -a $@\n"</span> : <span class="stringliteral">""</span>
00470             ) &lt; 0);
00471 
00472     <span class="comment">/* include depend files */</span>
00473     <span class="keywordflow">if</span>(is_a_script)
00474     {
00475         dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(ctx-&gt;iod, <span class="stringliteral">"\n-include "</span> KL1_FILE_FMT <span class="stringliteral">".kld\n"</span>, 
00476             uri_md5, ext) &lt; 0);
00477         dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(ctx-&gt;iod, <span class="stringliteral">"\n-include "</span> KL1_FILE_FMT <span class="stringliteral">".d\n"</span>, 
00478             uri_md5, ext) &lt; 0);
00479     }
00480 
00481     <span class="keywordflow">return</span> 0;
00482 err:
00483     <span class="keywordflow">return</span> ~0;
00484 }
00485 
00486 <span class="keyword">static</span> <span class="keywordtype">int</span> cb_dir(<span class="keyword">struct</span> dirent *de, <span class="keyword">const</span> <span class="keywordtype">char</span> *path , <span class="keywordtype">void</span> *arg)
00487 {
00488     <span class="keywordtype">char</span> dir[U_FILENAME_MAX], base_uri[URI_BUFSZ], *cur_uri = (<span class="keywordtype">char</span>*)arg;
00489 
00490     dbg_err_if (de == NULL);
00491     dbg_err_if (path == NULL);
00492     dbg_err_if (arg == NULL);
00493     
00494     ctx-&gt;ndir++;
00495 
00496     dbg_err_if(u_snprintf(dir, U_FILENAME_MAX, <span class="stringliteral">"%s/%s"</span>, path, de-&gt;d_name));
00497 
00498     dbg_err_if(u_snprintf(base_uri, URI_BUFSZ, <span class="stringliteral">"%s/%s"</span>, cur_uri, de-&gt;d_name));
00499 
00500     <a class="code" href="group__ut.html#ga26">u_foreach_dir_item</a>(dir, S_IFREG, cb_file, (<span class="keywordtype">void</span>*)base_uri);
00501 
00502     <a class="code" href="group__ut.html#ga26">u_foreach_dir_item</a>(dir, S_IFDIR, cb_dir, (<span class="keywordtype">void</span>*)base_uri);
00503 
00504     <span class="keywordflow">return</span> 0;
00505 err:
00506     <span class="keywordflow">return</span> ~0;
00507 }
00508 
00509 <span class="keyword">static</span> <span class="keywordtype">int</span> print_register_header(io_t *out)
00510 {
00511     dbg_err_if (out == NULL);
00512  
00513     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"#include &lt;klone_conf.h&gt;\n"</span>) &lt; 0);
00514     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"#include &lt;klone/hook.h&gt;\n"</span>) &lt; 0);
00515     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"static void do_register(int);\n"</span>) &lt; 0);
00516     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"void unregister_pages(void);\n"</span>) &lt; 0);
00517     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"void register_pages(void);\n"</span>) &lt; 0);
00518 
00519     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, 
00520         <span class="stringliteral">"void unregister_pages(void) { \n"</span>
00521         <span class="stringliteral">"do_register(0); }\n"</span>
00522         ) &lt; 0);
00523     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, 
00524         <span class="stringliteral">"void register_pages(void) { \n"</span>
00525         <span class="stringliteral">"do_register(1);\n"</span>
00526         <span class="stringliteral">"#ifdef ENABLE_HOOKS\n"</span>
00527         <span class="stringliteral">"    hooks_setup(); \n"</span>
00528         <span class="stringliteral">"#endif \n"</span>
00529         <span class="stringliteral">"}\n"</span>) &lt; 0);
00530     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, 
00531         <span class="stringliteral">"static void do_register(int action) {\n"</span>) &lt; 0);
00532     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out,
00533         <span class="stringliteral">"#define KLONE_REGISTER(a, md5)     \\\n"</span>
00534         <span class="stringliteral">"    do {                           \\\n"</span>
00535         <span class="stringliteral">"    void module_init_##md5(void);  \\\n"</span>
00536         <span class="stringliteral">"    void module_term_##md5(void);  \\\n"</span>
00537         <span class="stringliteral">"    if(a) module_init_##md5();     \\\n"</span>
00538         <span class="stringliteral">"    else module_term_##md5();      \\\n"</span>
00539         <span class="stringliteral">"    } while(0)                     \n"</span>) &lt; 0);
00540 
00541     <span class="keywordflow">return</span> 0;
00542 err:
00543     <span class="keywordflow">return</span> ~0;
00544 }
00545 
00546 <span class="keyword">static</span> <span class="keywordtype">int</span> print_register_footer(io_t *out)
00547 {
00548     dbg_err_if (out == NULL);
00549 
00550     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"#undef KLONE_REGISTER\n"</span>) &lt; 0);
00551     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(out, <span class="stringliteral">"}\n"</span>) &lt; 0);
00552 
00553     <span class="keywordflow">return</span> 0;
00554 err:
00555     <span class="keywordflow">return</span> ~0;
00556 }
00557 
00558 <span class="keyword">static</span> <span class="keywordtype">int</span> trans_site(<span class="keywordtype">char</span> *root_dir, <span class="keywordtype">char</span> *base_uri)
00559 {
00560     dbg_err_if (root_dir == NULL);
00561     dbg_err_if (base_uri == NULL);
00562     
00563     <span class="comment">/* makefile */</span>
00564     dbg_err_if(<a class="code" href="group__ut.html#ga35">u_file_open</a>(<span class="stringliteral">"autogen.mk"</span>, O_CREAT | O_TRUNC | O_WRONLY, 
00565                 &amp;ctx-&gt;iom));
00566     dbg_err_if(<a class="code" href="group__ut.html#ga35">u_file_open</a>(<span class="stringliteral">"autogen.dps"</span>, O_CREAT | O_TRUNC | O_WRONLY, 
00567                 &amp;ctx-&gt;iod));
00568 
00569     dbg_err_if(<a class="code" href="group__ut.html#ga35">u_file_open</a>(<span class="stringliteral">"register.c"</span>, O_CREAT | O_TRUNC | O_WRONLY, 
00570                 &amp;ctx-&gt;ior));
00571 
00572     dbg_err_if(print_register_header(ctx-&gt;ior));
00573 
00574     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(ctx-&gt;iom, <span class="stringliteral">"embfs_rootdir=%s\n"</span>, root_dir) &lt; 0);
00575     dbg_err_if(<a class="code" href="group__basic.html#ga28">io_printf</a>(ctx-&gt;iom, <span class="stringliteral">"autogen_src= "</span>) &lt; 0);
00576 
00577     <span class="comment">/* for each file call cb_file */</span>
00578     <a class="code" href="group__ut.html#ga26">u_foreach_dir_item</a>(root_dir, S_IFREG, cb_file, base_uri);
00579     <span class="comment">/* for each directory call cb_dir */</span>
00580     <a class="code" href="group__ut.html#ga26">u_foreach_dir_item</a>(root_dir, S_IFDIR, cb_dir, base_uri);
00581 
00582     dbg_err_if(print_register_footer(ctx-&gt;ior));
00583 
00584     <a class="code" href="group__basic.html#ga14">io_free</a>(ctx-&gt;ior);
00585     <a class="code" href="group__basic.html#ga14">io_free</a>(ctx-&gt;iod);
00586     <a class="code" href="group__basic.html#ga14">io_free</a>(ctx-&gt;iom);
00587 
00588     <span class="keywordflow">return</span> 0;
00589 err:
00590     <span class="keywordflow">if</span>(ctx-&gt;ior)
00591         <a class="code" href="group__basic.html#ga14">io_free</a>(ctx-&gt;ior);
00592     <span class="keywordflow">if</span>(ctx-&gt;iod)
00593         <a class="code" href="group__basic.html#ga14">io_free</a>(ctx-&gt;iod);
00594     <span class="keywordflow">if</span>(ctx-&gt;iom)
00595         <a class="code" href="group__basic.html#ga14">io_free</a>(ctx-&gt;iom);
00596     <span class="keywordflow">return</span> ~0;
00597 }
00598 
00599 <span class="keyword">static</span> <span class="keywordtype">int</span> command_import(<span class="keywordtype">void</span>)
00600 {
00601     <span class="keywordtype">char</span> *root_dir, *base_uri;
00602 
00603     <span class="keywordflow">if</span>(ctx-&gt;narg != 1)
00604         usage();    <span class="comment">/* just on directory expected */</span>
00605 
00606     root_dir = ctx-&gt;arg[0];
00607     dbg_err_if(root_dir == NULL);
00608 
00609     <span class="keywordflow">if</span>((base_uri = ctx-&gt;base_uri) == NULL)
00610     {
00611         base_uri = u_strdup(<span class="stringliteral">""</span>);
00612         dbg_err_if (base_uri == NULL);
00613     }
00614 
00615     dbg_err_if(trans_site(root_dir, base_uri));
00616 
00617     con(<span class="stringliteral">"%lu dirs and %lu files imported, %lu files skipped"</span>, 
00618             ctx-&gt;ndir, ctx-&gt;nfile, ctx-&gt;nexcl);
00619 
00620     <span class="keywordflow">return</span> 0;
00621 err:
00622     con(<span class="stringliteral">"import error"</span>);
00623     <span class="keywordflow">return</span> ~0;
00624 }
00625 
00626 <span class="keyword">static</span> <span class="keywordtype">int</span> dispatch_command(<span class="keywordtype">void</span>)
00627 {
00628     <span class="keywordflow">switch</span>(ctx-&gt;cmd)
00629     {
00630     <span class="keywordflow">case</span> CMD_TRANS:
00631         dbg_err_if(command_trans());
00632         <span class="keywordflow">break</span>;
00633     <span class="keywordflow">case</span> CMD_IMPORT:
00634         dbg_err_if(command_import());
00635         <span class="keywordflow">break</span>;
00636     <span class="keywordflow">default</span>:
00637         con_err(<span class="stringliteral">"unknown command"</span>);
00638     }
00639 
00640     <span class="keywordflow">return</span> 0;
00641 err:
00642     <span class="keywordflow">return</span> ~0;
00643 }
00644 
00645 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00646 {
00647     context_t context;
00648 
00649     ctx = &amp;context;
00650 
00651     <span class="comment">/* zero-out the context */</span>
00652     memset(ctx, 0, <span class="keyword">sizeof</span>(context_t));
00653 
00654     <span class="comment">/* init pattern matching objects */</span>
00655     dbg_err_if(pm_create(&amp;ctx-&gt;comp_patt));
00656     dbg_err_if(pm_create(&amp;ctx-&gt;enc_patt));
00657     dbg_err_if(pm_create(&amp;ctx-&gt;excl_patt));
00658 
00659     <span class="comment">/* parse command line switches and set ctx-&gt;cmd and params */</span>
00660     dbg_err_if(parse_opt(argc, argv));
00661 
00662     <span class="comment">/* run the command */</span>
00663     dbg_err_if(dispatch_command());
00664 
00665     <span class="keywordflow">return</span> EXIT_SUCCESS;
00666 err:
00667     <span class="keywordflow">return</span> EXIT_FAILURE;
00668 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


