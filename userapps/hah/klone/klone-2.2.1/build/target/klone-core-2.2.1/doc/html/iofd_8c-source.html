<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: iofd.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>iofd.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: iofd.c,v 1.14 2007/07/20 14:12:30 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00013 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00014 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00015 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/ioprv.h&gt;</span>
00018 
00019 <span class="keyword">struct </span>io_fd_s
00020 {
00021     <span class="keyword">struct </span>io_s io; <span class="comment">/* must be the first item */</span>
00022     <span class="keywordtype">int</span> fd;
00023     <span class="keywordtype">int</span> flags;
00024     <span class="keywordtype">int</span> issock;     <span class="comment">/* &gt;0 if fd is a SOCKET (win32 only) */</span>
00025 };
00026 
00027 <span class="keyword">typedef</span> <span class="keyword">struct </span>io_fd_s io_fd_t;
00028 
00029 <span class="keyword">static</span> ssize_t io_fd_read(io_fd_t *io, <span class="keywordtype">char</span> *buf, size_t size);
00030 <span class="keyword">static</span> ssize_t io_fd_write(io_fd_t *io, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, size_t size);
00031 <span class="keyword">static</span> ssize_t io_fd_seek(io_fd_t *io, size_t off);
00032 <span class="keyword">static</span> ssize_t io_fd_tell(io_fd_t *io);
00033 <span class="keyword">static</span> <span class="keywordtype">int</span> io_fd_close(io_fd_t *io);
00034 <span class="keyword">static</span> <span class="keywordtype">int</span> io_fd_free(io_fd_t *io);
00035 
00036 <span class="keyword">static</span> ssize_t io_fd_read(io_fd_t *ifd, <span class="keywordtype">char</span> *buf, size_t size)
00037 {
00038     ssize_t c;
00039 
00040     dbg_return_if (ifd == NULL, ~0);
00041     dbg_return_if (buf == NULL, ~0);
00042     
00043 again:
00044     <span class="keywordflow">if</span>(!ifd-&gt;issock)
00045         c = read(ifd-&gt;fd, buf, size);
00046     <span class="keywordflow">else</span>
00047         c = recv(ifd-&gt;fd, buf, size, 0);
00048     <span class="comment">/* if(c &lt; 0 &amp;&amp; (errno == EINTR || errno == EAGAIN)) */</span>
00049     <span class="keywordflow">if</span>(c &lt; 0 &amp;&amp; errno == EINTR)
00050         <span class="keywordflow">goto</span> again; 
00051 
00052     dbg_err_sif(c == -1); 
00053 
00054     <span class="keywordflow">return</span> c;
00055 err:
00056     <span class="keywordflow">return</span> -1;
00057 }
00058 
00059 <span class="keyword">static</span> ssize_t io_fd_write(io_fd_t *ifd, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, size_t size)
00060 {
00061     ssize_t c;
00062 
00063     dbg_return_if (ifd == NULL, ~0);
00064     dbg_return_if (buf == NULL, ~0);
00065  
00066 again:
00067     <span class="keywordflow">if</span>(!ifd-&gt;issock)
00068         c = write(ifd-&gt;fd, buf, size);
00069     <span class="keywordflow">else</span>
00070         c = send(ifd-&gt;fd, buf, size, 0);
00071     <span class="comment">/* if(c &lt; 0 &amp;&amp; (errno == EINTR || errno == EAGAIN)) */</span>
00072     <span class="keywordflow">if</span>(c &lt; 0 &amp;&amp; errno == EINTR)
00073         <span class="keywordflow">goto</span> again; 
00074 
00075     dbg_err_sif(c == -1); 
00076 
00077     <span class="keywordflow">return</span> c;
00078 err:
00079     <span class="keywordflow">return</span> -1;
00080 }
00081 
00082 <span class="keyword">static</span> ssize_t io_fd_seek(io_fd_t *ifd, size_t off)
00083 {
00084     dbg_return_if (ifd == NULL, -1);
00085 
00086     <span class="keywordflow">return</span> lseek(ifd-&gt;fd, off, SEEK_SET);
00087 }
00088 
00089 <span class="keyword">static</span> ssize_t io_fd_tell(io_fd_t *ifd)
00090 {
00091     dbg_return_if (ifd == NULL, -1);
00092 
00093     <span class="keywordflow">return</span> lseek(ifd-&gt;fd, 0, SEEK_CUR);
00094 }
00095 
00096 <span class="comment">/* close the underlaying fd (may be called more then once) */</span>
00097 <span class="keyword">static</span> <span class="keywordtype">int</span> io_fd_close(io_fd_t *ifd)
00098 {
00099     dbg_return_if (ifd == NULL, ~0);
00100     
00101     <span class="keywordflow">if</span>(ifd-&gt;flags &amp; IO_FD_CLOSE &amp;&amp; ifd-&gt;fd != -1)
00102     {
00103 <span class="preprocessor">#ifdef OS_WIN</span>
00104 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(ifd-&gt;issock)
00105         {
00106             closesocket(ifd-&gt;fd);
00107         } <span class="keywordflow">else</span>
00108             close(ifd-&gt;fd);
00109 <span class="preprocessor">#else</span>
00110 <span class="preprocessor"></span>            close(ifd-&gt;fd);
00111 <span class="preprocessor">#endif</span>
00112 <span class="preprocessor"></span>        ifd-&gt;fd = -1;
00113     }
00114 
00115     <span class="keywordflow">return</span> 0;
00116 }
00117 
00118 <span class="keyword">static</span> <span class="keywordtype">int</span> io_fd_free(io_fd_t *ifd)
00119 {
00120     dbg_if(io_fd_close(ifd));
00121 
00122     <span class="keywordflow">return</span> 0;
00123 }
00124 
00125 <span class="keywordtype">int</span> io_fd_get_d(io_t *io)
00126 {
00127     io_fd_t *ifd = (io_fd_t*)io;
00128     dbg_err_if(io == NULL);
00129     dbg_err_if(ifd-&gt;io.type != IO_TYPE_FD);
00130 
00131     <span class="keywordflow">return</span> ifd-&gt;fd;
00132 err:
00133     <span class="keywordflow">return</span> -1;
00134 }
00135 
00136 <span class="keywordtype">int</span> io_fd_create(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> flags, io_t **pio)
00137 {
00138     io_fd_t *ifd = NULL;
00139 
00140     dbg_err_if (pio == NULL);
00141 
00142     dbg_err_if(io_create(io_fd_t, (io_t**)&amp;ifd));
00143 
00144     ifd-&gt;io.type = IO_TYPE_FD;
00145 
00146     ifd-&gt;fd = fd;
00147     ifd-&gt;flags = flags;
00148     ifd-&gt;io.read = (io_read_op) io_fd_read;
00149     ifd-&gt;io.write = (io_write_op) io_fd_write;
00150     ifd-&gt;io.seek = (io_seek_op) io_fd_seek;
00151     ifd-&gt;io.tell = (io_tell_op) io_fd_tell;
00152     ifd-&gt;io.close = (io_close_op) io_fd_close; 
00153     ifd-&gt;io.free = (io_free_op) io_fd_free; 
00154     
00155 <span class="preprocessor">#ifdef OS_WIN</span>
00156 <span class="preprocessor"></span>    u_long ret;
00157     <span class="keywordflow">if</span>(ioctlsocket(fd, FIONREAD, &amp;ret) == 0)
00158         ifd-&gt;issock++; <span class="comment">/* is a socket, use recv/send instead of read/write  */</span>
00159     _setmode(fd, _O_BINARY); <span class="comment">/* we never want Windows CR/LF translation */</span>
00160 <span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162     *pio = (io_t*)ifd;
00163 
00164     <span class="keywordflow">return</span> 0;
00165 err:
00166     <span class="keywordflow">if</span>(ifd)
00167         <a class="code" href="group__basic.html#ga14">io_free</a>((io_t*)ifd);
00168     <span class="keywordflow">return</span> ~0;
00169 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


