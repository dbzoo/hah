<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: misc.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>misc.c</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;string.h&gt;</span>
00002 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
00003 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00004 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00005 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00006 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00007 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00008 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00009 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00010 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00011 
00012 <span class="keyword">struct </span>itimerval itv;
00013 size_t file_size, buf_size;
00014 
00015 <a class="code" href="group__test.html#ga10">U_TEST_MODULE</a>(misc);
00016 
00017 <span class="keyword">static</span> <span class="keywordtype">void</span> setitv(<span class="keyword">struct</span> itimerval *pitv)
00018 {
00019     memset(pitv, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> itimerval));
00020 
00021     pitv-&gt;it_value.tv_sec = 0;
00022     pitv-&gt;it_value.tv_usec = 1; <span class="comment">/* use maximum granularity */</span>
00023 }
00024 
00025 <span class="keyword">static</span> <span class="keywordtype">void</span> onsigalrm(<span class="keywordtype">int</span> s)
00026 {
00027     u_unused_args(s);
00028     setitv(&amp;itv);
00029     con_if(setitimer(ITIMER_REAL, &amp;itv, NULL) &lt; 0);
00030 }
00031 
00032 <span class="keyword">static</span> <span class="keywordtype">int</span> cat_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *fn, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *phash)
00033 {
00034     ssize_t tot = 0, c = 0;
00035     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash = 0;
00036     <span class="keywordtype">int</span> fd, i;
00037     <span class="keyword">struct </span>stat st;
00038     <span class="keywordtype">char</span> *buf = NULL;
00039 
00040     con_err_sif(stat(fn, &amp;st) &lt; 0);
00041 
00042     buf = <a class="code" href="group__alloc.html#ga4">u_malloc</a>(buf_size);
00043     con_err_if(buf == NULL);
00044 
00045     memset(buf, 0, buf_size);
00046 
00047     fd = open(fn, O_NONBLOCK | O_RDONLY);
00048     con_err_if(fd &lt; 0);
00049 
00050     <span class="keywordflow">for</span>(tot = 0; ; tot += c)
00051     {
00052         c = <a class="code" href="group__misc.html#ga20">u_read</a>(fd, buf, buf_size);
00053 
00054         con_err_sif(c &lt; 0);
00055 
00056         <span class="keywordflow">for</span>(i = 0; i &lt; c; ++i)
00057             hash += buf[i]; <span class="comment">/* idiot hash */</span>
00058 
00059         dbg_ifb(c == 0)
00060             <span class="keywordflow">break</span>; <span class="comment">/* eof */</span>
00061     }
00062 
00063     close(fd);
00064 
00065     *phash = hash;
00066 
00067     con_err_ifm(st.st_size != tot, <span class="stringliteral">"file size differs (%d != %d)"</span>, 
00068             st.st_size, tot);
00069 
00070     <a class="code" href="group__alloc.html#ga8">u_free</a>(buf);
00071 
00072     <span class="keywordflow">return</span> 0;
00073 err:
00074     <span class="keywordflow">if</span>(buf)
00075         <a class="code" href="group__alloc.html#ga8">u_free</a>(buf);
00076     <span class="keywordflow">return</span> 1;
00077 }
00078 
00079 <span class="keyword">static</span> <span class="keywordtype">int</span> gen_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *fn, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *phash)
00080 {
00081     <span class="keywordtype">int</span> fd = -1;
00082     <span class="keywordtype">char</span> *buf = NULL;
00083     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash = 0;
00084     size_t i, c, size = file_size;
00085 
00086     buf = <a class="code" href="group__alloc.html#ga4">u_malloc</a>(buf_size);
00087     con_err_if(buf == NULL);
00088 
00089     memset(buf, 0, buf_size);
00090 
00091     fd = open(fn, O_CREAT | O_WRONLY | O_NONBLOCK, 0600);
00092     con_err_sif(fd &lt; 0);
00093 
00094     <span class="keywordflow">while</span>(size)
00095     {
00096         c = (size &lt; buf_size ? size : buf_size);
00097 
00098         <span class="keywordflow">for</span>(i = 0; i &lt; c; ++i)
00099             buf[i] = i; <span class="comment">/* just fill buf somehow */</span>
00100 
00101         con_err_if(<a class="code" href="group__misc.html#ga21">u_write</a>(fd, buf, c) &lt; 0);
00102 
00103         <span class="keywordflow">for</span>(i = 0; i &lt; c; ++i)
00104             hash += buf[i]; <span class="comment">/* idiot hash */</span>
00105 
00106         size -= c;
00107     }
00108 
00109     close(fd);
00110     <a class="code" href="group__alloc.html#ga8">u_free</a>(buf);
00111 
00112     *phash = hash;
00113 
00114     <span class="keywordflow">return</span> 0;
00115 err:
00116     <span class="keywordflow">if</span>(fd &gt;= 0)
00117         close(fd);
00118     <span class="keywordflow">if</span>(buf)
00119         <a class="code" href="group__alloc.html#ga8">u_free</a>(buf);
00120     <span class="keywordflow">return</span> ~0;
00121 }
00122 
00123 <span class="keyword">static</span> <span class="keywordtype">int</span> tmp_u_rdwr(<span class="keywordtype">int</span> rd, <span class="keyword">const</span> <span class="keywordtype">char</span> *fn, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *phash)
00124 {
00125     <span class="keywordtype">int</span> read_rc, write_rc;
00126 
00127     <span class="comment">/* set a fast timer to generate EINTRs */</span>
00128     signal(SIGALRM, onsigalrm);
00129     setitv(&amp;itv);
00130     con_err_if(setitimer(ITIMER_REAL, &amp;itv, NULL) &lt; 0);
00131 
00132     <span class="keywordflow">if</span>(rd)
00133         read_rc = cat_file(fn, phash);
00134     <span class="keywordflow">else</span>
00135         write_rc = gen_file(fn, phash);
00136 
00137     <span class="comment">/* disable timers */</span>
00138     signal(SIGALRM, SIG_IGN);
00139     memset(&amp;itv, 0, <span class="keyword">sizeof</span>(itv));
00140     setitimer(ITIMER_REAL, &amp;itv, &amp;itv);
00141     signal(SIGALRM, SIG_DFL);
00142 
00143     <span class="keywordflow">if</span>(rd)
00144         con_err_if(read_rc);
00145     <span class="keywordflow">else</span>
00146         con_err_if(write_rc);
00147  
00148     <span class="keywordflow">return</span> 0;
00149 err:
00150     <span class="keywordflow">return</span> ~0;
00151 }
00152 
00153 <span class="keyword">static</span> <span class="keywordtype">int</span> test_u_rdwr(<span class="keywordtype">void</span>)
00154 {
00155     <span class="keywordtype">char</span> fn[U_FILENAME_MAX + 1] = { 0 };
00156     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash_read, hash_write;
00157     <span class="keywordtype">int</span> i;
00158 
00159     buf_size = 1;
00160     file_size = 1013;
00161 
00162     <span class="comment">/* try with diferent buffer size and file size */</span>
00163     <span class="keywordflow">for</span>(i = 0; i &lt; 10; ++i)
00164     {
00165         <span class="comment">/* add 1 to avoid multiples of 2 */</span>
00166         buf_size = (buf_size &lt;&lt; 1) + 1;
00167         file_size = (file_size &lt;&lt; 1) + 1;
00168 
00169         con_err_if(tmpnam(fn) == NULL);
00170 
00171         con_err_if(tmp_u_rdwr(0 <span class="comment">/* write */</span>, fn, &amp;hash_write));
00172 
00173         con_err_if(tmp_u_rdwr(1 <span class="comment">/* read */</span>, fn, &amp;hash_read));
00174 
00175         con_err_if(hash_read != hash_write);
00176 
00177         unlink(fn);
00178     }
00179 
00180     <span class="keywordflow">return</span> 0;
00181 err:
00182     con(<span class="stringliteral">"failed. file: %s file_size: %d, buf_size: %d"</span>, fn, 
00183             file_size, buf_size);
00184     <span class="keywordflow">return</span> 1;
00185 }
00186 
00187 <span class="keyword">static</span> <span class="keywordtype">int</span> test_u_strtok (<span class="keywordtype">void</span>)
00188 {
00189     <span class="keywordtype">char</span> **tv = NULL;
00190     size_t nelems, i, j;
00191     <span class="keyword">enum</span> { MAX_TOKENS = 100 };
00192 
00193     <span class="keyword">struct </span>vt_s
00194     {
00195         <span class="keyword">const</span> <span class="keywordtype">char</span> *in; 
00196         <span class="keyword">const</span> <span class="keywordtype">char</span> *delim; 
00197         <span class="keyword">const</span> <span class="keywordtype">char</span> *exp[MAX_TOKENS];
00198     } vt[] = {
00199         { 
00200             <span class="comment">/* tv idx 0 */</span>
00201             <span class="stringliteral">"this . is , a : test ; string |"</span>, 
00202             <span class="stringliteral">" \t"</span>, 
00203             { 
00204                 <span class="stringliteral">"this"</span>, 
00205                 <span class="stringliteral">"."</span>, 
00206                 <span class="stringliteral">"is"</span>, 
00207                 <span class="stringliteral">","</span>, 
00208                 <span class="stringliteral">"a"</span>, 
00209                 <span class="stringliteral">":"</span>, 
00210                 <span class="stringliteral">"test"</span>, 
00211                 <span class="stringliteral">";"</span>, 
00212                 <span class="stringliteral">"string"</span>, 
00213                 <span class="stringliteral">"|"</span>, 
00214                 NULL 
00215             }
00216         },
00217         {
00218             <span class="comment">/* tv idx 1 */</span>
00219             <span class="stringliteral">"this . is , a : test ; string |"</span>, 
00220             <span class="stringliteral">"."</span>,
00221             {
00222                 <span class="stringliteral">"this "</span>,
00223                 <span class="stringliteral">" is , a : test ; string |"</span>,
00224                 NULL 
00225             }
00226         },
00227         {
00228             <span class="comment">/* tv idx 2 */</span>
00229             <span class="stringliteral">"this . is , a : test ; string |"</span>, 
00230             <span class="stringliteral">","</span>,
00231             {
00232                 <span class="stringliteral">"this . is "</span>,
00233                 <span class="stringliteral">" a : test ; string |"</span>,
00234                 NULL 
00235             }
00236         },
00237         {
00238             <span class="comment">/* tv idx 3 */</span>
00239             <span class="stringliteral">"this .. is ,, a : test ; string |"</span>, 
00240             <span class="stringliteral">",.:"</span>,
00241             {
00242                 <span class="stringliteral">"this "</span>,
00243                 <span class="stringliteral">" is "</span>,
00244                 <span class="stringliteral">" a "</span>,
00245                 <span class="stringliteral">" test ; string |"</span>,
00246                 NULL 
00247             }
00248         },
00249         {
00250             <span class="comment">/* tv idx 4 */</span>
00251             <span class="stringliteral">"is .. this ,, a : test ; string ||? |"</span>, 
00252             <span class="stringliteral">",.:;|"</span>,
00253             {
00254                 <span class="stringliteral">"is "</span>,
00255                 <span class="stringliteral">" this "</span>,
00256                 <span class="stringliteral">" a "</span>,
00257                 <span class="stringliteral">" test "</span>,
00258                 <span class="stringliteral">" string "</span>,
00259                 <span class="stringliteral">"? "</span>,
00260                 NULL 
00261             }
00262         },
00263         {
00264             <span class="comment">/* tv idx 5 */</span>
00265             <span class="stringliteral">"       is .. this ,, a : test ; string ||? |"</span>, 
00266             <span class="stringliteral">" ,.:;|"</span>,
00267             {
00268                 <span class="stringliteral">"is"</span>,
00269                 <span class="stringliteral">"this"</span>,
00270                 <span class="stringliteral">"a"</span>,
00271                 <span class="stringliteral">"test"</span>,
00272                 <span class="stringliteral">"string"</span>,
00273                 <span class="stringliteral">"?"</span>,
00274                 NULL 
00275             }
00276         },
00277         {
00278             <span class="comment">/* tv idx 6 */</span>
00279             <span class="stringliteral">"       is .. this ,, a : test ; string ||? |"</span>, 
00280             <span class="stringliteral">"-"</span>,
00281             {
00282                 <span class="stringliteral">"       is .. this ,, a : test ; string ||? |"</span>,
00283                 NULL 
00284             }
00285         },
00286         {
00287             <span class="comment">/* tv idx 7 (string containing separator chars only) */</span>
00288             <span class="stringliteral">"|,,,  | ,"</span>,
00289             <span class="stringliteral">"|, "</span>,
00290             { NULL }
00291         },
00292         {
00293             <span class="comment">/* tv idx 8 (empty string) */</span>
00294             <span class="stringliteral">""</span>,
00295             <span class="stringliteral">"|, "</span>,
00296             { NULL }
00297         },
00298         { 
00299              NULL, 
00300              NULL, 
00301              { NULL }
00302         }
00303     };
00304 
00305     <span class="keywordflow">for</span> (i = 0; vt[i].in; i++)
00306     {
00307         dbg_err_if (<a class="code" href="group__misc.html#ga9">u_strtok</a>(vt[i].in, vt[i].delim, &amp;tv, &amp;nelems));
00308 
00309         <span class="keywordflow">for</span> (j = 0; j &lt; nelems; j++)
00310         {
00311             con_err_ifm (strcmp(tv[j], vt[i].exp[j]), 
00312                     <span class="stringliteral">"%s != %s (tv idx=%zu)"</span>, tv[j], vt[i].exp[j], i);
00313         }
00314 
00315         con_err_ifm (vt[i].exp[j] != NULL, 
00316                 <span class="stringliteral">"got %zu tokens from u_strtok, need some more (tv idx=%zu)"</span>, 
00317                 nelems, i);
00318 
00319         <a class="code" href="group__misc.html#ga10">u_strtok_cleanup</a>(tv, nelems);
00320         tv = NULL;
00321     }
00322 
00323     <span class="keywordflow">return</span> 0;
00324 err:
00325     <a class="code" href="group__misc.html#ga10">u_strtok_cleanup</a>(tv, nelems);
00326     <span class="keywordflow">return</span> ~0;
00327 }
00328 
00329 <span class="keyword">static</span> <span class="keywordtype">int</span> test_u_path_snprintf(<span class="keywordtype">void</span>)
00330 {
00331     <span class="keyword">struct </span>vt_s
00332     {
00333         <span class="keyword">const</span> <span class="keywordtype">char</span> *src, *exp;
00334     } vt[] = {
00335         { <span class="stringliteral">""</span>,           <span class="stringliteral">""</span> },
00336         { <span class="stringliteral">"/"</span>,          <span class="stringliteral">"/"</span> },
00337         { <span class="stringliteral">"//"</span>,         <span class="stringliteral">"/"</span> },
00338         { <span class="stringliteral">"</span>
00339 <span class="stringliteral">        { "</span>a<span class="stringliteral">",          "</span>a<span class="stringliteral">" },</span>
00340 <span class="stringliteral">        { "</span>ab<span class="stringliteral">",         "</span>ab<span class="stringliteral">" },</span>
00341 <span class="stringliteral">        { "</span>abc<span class="stringliteral">",        "</span>abc<span class="stringliteral">" },</span>
00342 <span class="stringliteral">        { "</span>a/b<span class="stringliteral">",        "</span>a/b<span class="stringliteral">" },</span>
00343 <span class="stringliteral">        { "</span>/a<span class="stringliteral">",         "</span>/a<span class="stringliteral">" },</span>
00344 <span class="stringliteral">        { "</span><span class="comment">//a",        "/a" },</span>
00345         { <span class="stringliteral">"</span>
00346 <span class="stringliteral">        { "</span>
00347         { <span class="stringliteral">"/a//"</span>,       <span class="stringliteral">"/a/"</span> },
00348         { <span class="stringliteral">"/a///"</span>,      <span class="stringliteral">"/a/"</span> },
00349         { <span class="stringliteral">"/a////"</span>,     <span class="stringliteral">"/a/"</span> },
00350         { <span class="stringliteral">"a//b"</span>,       <span class="stringliteral">"a/b"</span> },
00351         { <span class="stringliteral">"a///b"</span>,      <span class="stringliteral">"a/b"</span> },
00352         { <span class="stringliteral">"a////b"</span>,     <span class="stringliteral">"a/b"</span> },
00353         { <span class="stringliteral">"a/b//c"</span>,     <span class="stringliteral">"a/b/c"</span> },
00354         { <span class="stringliteral">"a/b//c/"</span>,    <span class="stringliteral">"a/b/c/"</span> },
00355         { <span class="stringliteral">"a//b//c//"</span>,  <span class="stringliteral">"a/b/c/"</span> },
00356         { NULL,         NULL }
00357     };
00358     <span class="keywordtype">int</span> i;
00359     <span class="keywordtype">char</span> buf[4096];
00360 
00361     <span class="keywordflow">for</span>(i = 0; vt[i].src; ++i)
00362     {
00363         <a class="code" href="group__misc.html#ga13">u_path_snprintf</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="charliteral">'/'</span>, <span class="stringliteral">"%s"</span>, vt[i].src);
00364         con_err_ifm(strcmp(buf, vt[i].exp), <span class="stringliteral">"src: %s  exp: %s  got: %s"</span>,
00365                 vt[i].src, vt[i].exp, buf);
00366     }
00367 
00368     <span class="keywordflow">return</span> 0;
00369 err:
00370     <span class="keywordflow">return</span> ~0;
00371 }
00372 
00373 <a class="code" href="group__test.html#ga10">U_TEST_MODULE</a>(misc)
00374 {
00375     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( test_u_rdwr );
00376     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( test_u_path_snprintf );
00377     <a class="code" href="group__test.html#ga11">U_TEST_RUN</a>( test_u_strtok );
00378 
00379     <span class="keywordflow">return</span> 0;                                                
00380 }
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
