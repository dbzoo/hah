<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: sup_emb.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>sup_emb.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: sup_emb.c,v 1.35 2008/10/27 21:28:04 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00013 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/supplier.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00018 <span class="preprocessor">#include &lt;klone/ioprv.h&gt;</span>
00019 <span class="preprocessor">#include &lt;klone/page.h&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="http_8h.html">klone/http.h</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;klone/emb.h&gt;</span>
00022 <span class="preprocessor">#include &lt;klone/codecs.h&gt;</span>
00023 <span class="preprocessor">#include &lt;klone/ses_prv.h&gt;</span>
00024 <span class="preprocessor">#include &lt;klone/rsfilter.h&gt;</span>
00025 <span class="preprocessor">#include &lt;klone/dypage.h&gt;</span>
00026 <span class="preprocessor">#include "http_s.h"</span>
00027 
00028 <span class="keyword">static</span> <span class="keywordtype">int</span> supemb_is_valid_uri(http_t *h, request_t *rq, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri, 
00029         size_t len, <span class="keywordtype">void</span> **handle, time_t *mtime)
00030 {
00031     embres_t *e;
00032     <span class="keywordtype">char</span> filename[U_FILENAME_MAX] = { 0 };
00033 
00034     dbg_err_if (uri == NULL);
00035     dbg_err_if (mtime == NULL);
00036     dbg_err_if (len &gt;= U_FILENAME_MAX);
00037 
00038     u_unused_args(h, rq);
00039 
00040     strncpy(filename, uri, len);
00041     filename[len] = 0;
00042 
00043     <span class="keywordflow">if</span>(emb_lookup(filename, &amp;e) == 0)
00044     {   <span class="comment">/* resource found */</span>
00045 
00046         <span class="keywordflow">if</span>(e-&gt;type == ET_FILE)
00047             *mtime = ((embfile_t*)e)-&gt;mtime;
00048         <span class="keywordflow">else</span>
00049             *mtime = 0; <span class="comment">/* dynamic pages cannot be cached */</span>
00050 
00051         *handle = NULL;
00052 
00053         <span class="keywordflow">return</span> 1;
00054     }
00055 
00056 err:
00057     <span class="keywordflow">return</span> 0; <span class="comment">/* not found */</span>
00058 }
00059 
00060 <span class="keyword">static</span> <span class="keywordtype">int</span> supemb_get_cipher_key(request_t *rq, response_t *rs, <span class="keywordtype">char</span> *key, 
00061     size_t keysz)
00062 {
00063     session_t *ss = NULL;
00064     http_t *http = NULL;
00065     session_opt_t *so;
00066     vars_t *vars;
00067     var_t *v;
00068 
00069     dbg_err_if (rq == NULL);
00070     dbg_err_if (rs == NULL);
00071     dbg_err_if (key == NULL);
00072 
00073     <span class="comment">/* get session options */</span>
00074     dbg_err_if((http = <a class="code" href="group__request.html#ga8">request_get_http</a>(rq)) == NULL);
00075     dbg_err_if((so = http_get_session_opt(http)) == NULL);
00076 
00077     <span class="comment">/* create/get the session */</span>
00078     dbg_err_if(session_create(so, rq, rs, &amp;ss));
00079 
00080     <span class="comment">/* get variables list */</span>
00081     vars = <a class="code" href="group__session.html#ga5">session_get_vars</a>(ss);
00082     dbg_err_if(vars == NULL);
00083 
00084     v = vars_geti(vars,<span class="stringliteral">"KLONE_CIPHER_KEY"</span>, 0); 
00085     dbg_err_if(v == NULL); <span class="comment">/* no such variable */</span>
00086 
00087     dbg_err_if(var_get_value_size(v) &gt; keysz);
00088 
00089     <span class="comment">/* zero-out key array */</span>
00090     memset(key, 0, keysz);
00091 
00092     <span class="comment">/* set the key */</span>
00093     memcpy(key, var_get_value(v), var_get_value_size(v));
00094 
00095     session_free(ss);
00096 
00097     <span class="keywordflow">return</span> 0;
00098 err:
00099     <span class="keywordflow">if</span>(ss)
00100         session_free(ss);
00101     <span class="keywordflow">return</span> ~0;
00102 }
00103 
00104 <span class="keyword">static</span> <span class="keywordtype">int</span> supemb_static_set_header_fields(request_t *rq, response_t *rs, 
00105     embfile_t *e, <span class="keywordtype">int</span> *sai)
00106 {
00107     vhost_t *vhost;
00108 
00109     dbg_err_if (rq == NULL);
00110     dbg_err_if (rs == NULL);
00111     dbg_err_if (e == NULL);
00112     dbg_err_if (sai == NULL);
00113 
00114     dbg_err_if((vhost = request_get_vhost(rq)) == NULL);
00115 
00116     <span class="comment">/* set header fields based on embfile_t struct */</span>
00117 
00118     <span class="comment">/* set content-type, last-modified and content-length*/</span>
00119     dbg_err_if(<a class="code" href="group__response.html#ga21">response_set_content_type</a>(rs, e-&gt;mime_type));
00120     dbg_err_if(<a class="code" href="group__response.html#ga24">response_set_last_modified</a>(rs, e-&gt;mtime));
00121     dbg_err_if(<a class="code" href="group__response.html#ga22">response_set_content_length</a>(rs, e-&gt;file_size));
00122 
00123     <span class="comment">/* if the client can accept deflated content don't uncompress the </span>
00124 <span class="comment">       resource but send as it is (if enabled by config) */</span>
00125     <span class="keywordflow">if</span>(vhost-&gt;send_enc_deflate)
00126     {
00127         <span class="keywordflow">if</span>(e-&gt;comp &amp;&amp; (*sai = request_is_encoding_accepted(rq, <span class="stringliteral">"deflate"</span>)) != 0)
00128         {   <span class="comment">/* we can send compressed responses */</span>
00129             dbg_err_if(<a class="code" href="group__response.html#ga23">response_set_content_encoding</a>(rs, <span class="stringliteral">"deflate"</span>));
00130             dbg_err_if(<a class="code" href="group__response.html#ga22">response_set_content_length</a>(rs, e-&gt;size));
00131             <span class="comment">/*  dbg("sending deflated content"); */</span>
00132         } 
00133     }
00134 
00135     <span class="keywordflow">return</span> 0;
00136 err:
00137     <span class="keywordflow">return</span> ~0;
00138 }
00139 
00140 <span class="keyword">static</span> <span class="keywordtype">int</span> supemb_serve_static(request_t *rq, response_t *rs, embfile_t *e)
00141 {
00142     codec_t *gzip = NULL, *decrypt = NULL;
00143     <span class="keywordtype">int</span> sai = 0; <span class="comment">/* send as is */</span>
00144     <span class="keywordtype">int</span> decrypting = 0;
00145     <span class="keywordtype">char</span> key[CODEC_CIPHER_KEY_SIZE];
00146     codec_t *rsf = NULL;
00147 
00148     dbg_return_if (rq == NULL, ~0);
00149     dbg_return_if (rs == NULL, ~0);
00150     dbg_return_if (e == NULL, 0);
00151     
00152     <span class="comment">/* create a response filter and attach it to the response io */</span>
00153     dbg_err_if(response_filter_create(rq, rs, NULL, &amp;rsf));
00154     dbg_err_if(<a class="code" href="group__basic.html#ga32">io_codec_add_tail</a>(<a class="code" href="group__response.html#ga16">response_io</a>(rs), rsf));
00155     rsf = NULL;
00156 
00157     <span class="comment">/* set HTTP header based on 'e' (we have the cipher key here) */</span>
00158     dbg_err_if(supemb_static_set_header_fields(rq, rs, e, &amp;sai));
00159 
00160     <span class="comment">/* if this is a HEAD request print the header and exit */</span>
00161     <span class="keywordflow">if</span>(<a class="code" href="group__request.html#ga22">request_get_method</a>(rq) == <a class="code" href="http_8h.html#a33a22">HM_HEAD</a>)
00162         <span class="keywordflow">return</span> 0; <span class="comment">/* just the header is requested */</span>
00163 
00164 <span class="preprocessor">#ifdef HAVE_LIBZ</span>
00165 <span class="preprocessor"></span>    <span class="comment">/* if needed apply a gzip codec to uncompress content data */</span>
00166     <span class="keywordflow">if</span>(e-&gt;comp &amp;&amp; !sai)
00167         dbg_err_if(<a class="code" href="group__filters.html#ga2">codec_gzip_create</a>(GZIP_UNCOMPRESS, &amp;gzip));
00168 <span class="preprocessor">#endif</span>
00169 <span class="preprocessor"></span>
00170 <span class="preprocessor">#ifdef HAVE_LIBOPENSSL</span>
00171 <span class="preprocessor"></span>    <span class="comment">/* if the resource is encrypted unencrypt using the key stored in </span>
00172 <span class="comment">       KLONE_CIPHER_KEY session variable */</span>
00173     <span class="keywordflow">if</span>(e-&gt;encrypted)
00174     {
00175         <span class="keywordflow">if</span>(supemb_get_cipher_key(rq, rs, key, CODEC_CIPHER_KEY_SIZE))
00176         {   <span class="comment">/* if the content is encrypted and there's no key then exit */</span>
00177             dbg_err_if(<a class="code" href="group__response.html#ga6">response_set_status</a>(rs, 401));
00178             dbg_err(<span class="stringliteral">"cipher key not found, aborting"</span>);
00179         }
00180         dbg_err_if(<a class="code" href="group__filters.html#ga0">codec_cipher_create</a>(CIPHER_DECRYPT, EVP_aes_256_cbc(),
00181                     key, NULL, &amp;decrypt));
00182         <span class="comment">/* delete the key from the stack */</span>
00183         memset(key, 0, CODEC_CIPHER_KEY_SIZE);
00184     } 
00185 <span class="preprocessor">#endif</span>
00186 <span class="preprocessor"></span>
00187     <span class="keywordflow">if</span>(gzip)
00188     {   <span class="comment">/* set gzip filter */</span>
00189         dbg_err_if(<a class="code" href="group__basic.html#ga31">io_codec_add_head</a>(<a class="code" href="group__response.html#ga16">response_io</a>(rs), gzip));
00190         gzip = NULL; <span class="comment">/* io_t owns it after io_codec_add_tail */</span>
00191     }
00192 
00193     <span class="keywordflow">if</span>(decrypt)
00194     {   <span class="comment">/* set decrypt filter */</span>
00195         dbg_err_if(<a class="code" href="group__basic.html#ga31">io_codec_add_head</a>(<a class="code" href="group__response.html#ga16">response_io</a>(rs), decrypt));
00196         decrypt = NULL; <span class="comment">/* io_t owns it after io_codec_add_tail */</span>
00197         decrypting = 1;
00198     }
00199 
00200     <span class="comment">/* print out page content (the header will be autoprinted by the </span>
00201 <span class="comment">       response io filter) */</span>
00202     dbg_err_if(<a class="code" href="group__basic.html#ga19">io_write</a>(<a class="code" href="group__response.html#ga16">response_io</a>(rs), (<span class="keyword">const</span> <span class="keywordtype">char</span>*)e-&gt;data, e-&gt;size) 
00203         &lt; e-&gt;size);
00204 
00205     <span class="comment">/* remove and free the gzip codec (if it has been set) */</span>
00206     dbg_err_if(<a class="code" href="group__basic.html#ga33">io_codecs_remove</a>(<a class="code" href="group__response.html#ga16">response_io</a>(rs))); 
00207 
00208     <span class="keywordflow">return</span> 0;
00209 err:
00210     <span class="keywordflow">if</span>(decrypting)
00211         dbg_if(<a class="code" href="group__response.html#ga6">response_set_status</a>(rs, 401)); <span class="comment">/* usually wrong key given */</span>
00212     <span class="comment">/* remove codecs and rs filter */</span>
00213     dbg_if(<a class="code" href="group__basic.html#ga33">io_codecs_remove</a>(<a class="code" href="group__response.html#ga16">response_io</a>(rs))); 
00214     <span class="keywordflow">if</span>(decrypt)
00215         <a class="code" href="group__filters.html#ga9">codec_free</a>(decrypt);
00216     <span class="keywordflow">if</span>(gzip)
00217         <a class="code" href="group__filters.html#ga9">codec_free</a>(gzip);
00218     <span class="keywordflow">return</span> ~0;
00219 }
00220 
00221 <span class="keyword">static</span> <span class="keywordtype">int</span> supemb_serve_dynamic(request_t *rq, response_t *rs, embpage_t *e)
00222 {
00223     dypage_args_t args;
00224 
00225     args.rq = rq;
00226     args.rs = rs;
00227     args.ss = NULL; <span class="comment">/* dypage_serve will set it before calling args.fun() */</span>
00228     args.fun = e-&gt;fun;
00229     args.opaque = NULL;
00230 
00231     dbg_err_if(dypage_serve(&amp;args));
00232 
00233     <span class="keywordflow">return</span> 0;
00234 err:
00235     <span class="keywordflow">return</span> ~0;
00236 }
00237 
00238 <span class="keyword">static</span> <span class="keywordtype">int</span> supemb_serve(request_t *rq, response_t *rs)
00239 {
00240     <span class="keyword">const</span> <span class="keywordtype">char</span> *file_name;
00241     embres_t *e;
00242 
00243     dbg_err_if (rq == NULL);
00244     dbg_err_if (rs == NULL);
00245     
00246     file_name = <a class="code" href="group__request.html#ga18">request_get_resolved_filename</a>(rq);
00247     dbg_ifb(file_name == NULL || emb_lookup(file_name, &amp;e))
00248     {
00249         <a class="code" href="group__response.html#ga6">response_set_status</a>(rs, HTTP_STATUS_NOT_FOUND); 
00250         <span class="keywordflow">return</span> 0;
00251     }
00252 
00253     <span class="comment">/* dbg("serving %s", e-&gt;filename); */</span>
00254 
00255     <span class="keywordflow">switch</span>(e-&gt;type)
00256     {
00257     <span class="keywordflow">case</span> ET_FILE:
00258         dbg_err_if(supemb_serve_static(rq, rs, (embfile_t*)e));
00259         <span class="keywordflow">break</span>;
00260     <span class="keywordflow">case</span> ET_PAGE:
00261         dbg_err_if(supemb_serve_dynamic(rq, rs, (embpage_t*)e));
00262         <span class="keywordflow">break</span>;
00263     <span class="keywordflow">default</span>:
00264         dbg_err_if(<span class="stringliteral">"unknown res type"</span>);
00265     }
00266 
00267     <span class="keywordflow">return</span> 0;
00268 err:
00269     <span class="keywordflow">return</span> ~0;
00270 }
00271 
00272 <span class="keyword">static</span> <span class="keywordtype">int</span> supemb_init(<span class="keywordtype">void</span>)
00273 {
00274     <span class="keywordflow">return</span> 0;
00275 }
00276 
00277 <span class="keyword">static</span> <span class="keywordtype">void</span> supemb_term(<span class="keywordtype">void</span>)
00278 {
00279     <span class="keywordflow">return</span>;
00280 }
00281 
00282 supplier_t sup_emb = {
00283     <span class="stringliteral">"embedded content supplier"</span>,
00284     supemb_init,
00285     supemb_term,
00286     supemb_is_valid_uri,
00287     supemb_serve
00288 };
00289 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


