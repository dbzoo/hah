<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LibU: uri.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>uri.c</h1><div class="fragment"><pre>00001 <span class="comment">/* </span>
00002 <span class="comment"> * Copyright (c) 2005-2008 by KoanLogic s.r.l. - All rights reserved.  </span>
00003 <span class="comment"> */</span>
00004 
00005 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00006 <span class="preprocessor">#include &lt;string.h&gt;</span>
00007 
00008 <span class="preprocessor">#include &lt;toolbox/uri.h&gt;</span>
00009 <span class="preprocessor">#include &lt;toolbox/carpal.h&gt;</span>
00010 <span class="preprocessor">#include &lt;toolbox/misc.h&gt;</span>
00011 <span class="preprocessor">#include &lt;toolbox/memory.h&gt;</span>
00012 
00018 <span class="comment">/* split a string separated by 'c' in two substrings */</span>
00019 <span class="keyword">static</span> <span class="keywordtype">int</span> split(<span class="keyword">const</span> <span class="keywordtype">char</span> *s, size_t len, <span class="keywordtype">char</span> c, <span class="keywordtype">char</span> **left, <span class="keywordtype">char</span> **right)
00020 {
00021     <span class="keywordtype">char</span> *buf = 0;
00022     <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
00023     <span class="keywordtype">char</span> *l = 0, *r = 0;
00024     
00025     buf = <a class="code" href="group__misc.html#ga4">u_strndup</a>(s, len);
00026     nop_err_if(!buf);
00027 
00028     <span class="keywordflow">if</span>((p = strchr(buf, c)) != NULL)
00029     {
00030         l = <a class="code" href="group__misc.html#ga4">u_strndup</a>(s, p - buf);
00031         r = <a class="code" href="group__misc.html#ga4">u_strndup</a>(1 + p, len - (p - buf) - 1);
00032         nop_err_if(!l || !r);
00033     } <span class="keywordflow">else</span> {
00034         r = NULL;
00035         nop_err_if((l = <a class="code" href="group__misc.html#ga4">u_strndup</a>(buf, len)) == NULL);
00036     }
00037 
00038     <span class="comment">/* return result strings */</span>
00039     *left = l;
00040     *right = r;
00041 
00042     U_FREE(buf);
00043 
00044     <span class="keywordflow">return</span> 0;
00045 err:
00046     U_FREE(buf);
00047     U_FREE(l);
00048     U_FREE(r);
00049     <span class="keywordflow">return</span> ~0;
00050 }
00051 
00052 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_userinfo(<span class="keyword">const</span> <span class="keywordtype">char</span> *s, size_t len, u_uri_t *uri)
00053 {
00054     <span class="keywordflow">return</span> split(s, len, <span class="charliteral">':'</span>, &amp;uri-&gt;user, &amp;uri-&gt;pwd);
00055 }
00056 
00057 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_hostinfo(<span class="keyword">const</span> <span class="keywordtype">char</span> *s, size_t len, u_uri_t *uri)
00058 {
00059     <span class="keywordtype">char</span> *port = 0;
00060 
00061     <span class="keywordflow">if</span>(split(s, len, <span class="charliteral">':'</span>, &amp;uri-&gt;host, &amp;port))
00062         <span class="keywordflow">return</span> ~0;
00063 
00064     <span class="keywordflow">if</span>(port)
00065     {
00066         uri-&gt;port = atoi(port);
00067         U_FREE(port);
00068     }
00069     <span class="keywordflow">return</span> 0;
00070 }
00071 
00072 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_middle(<span class="keyword">const</span> <span class="keywordtype">char</span> *s, size_t len, u_uri_t *uri)
00073 {
00074     <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
00075 
00076     <span class="keywordflow">if</span>( (p = strchr(s, <span class="charliteral">'@'</span>)) == NULL)
00077         <span class="keywordflow">return</span> parse_hostinfo(s, len, uri);
00078     <span class="keywordflow">else</span>
00079         <span class="keywordflow">return</span> parse_userinfo(s, p-s,uri) + parse_hostinfo(1+p, s+len-p-1, uri);
00080 }
00081 
<a name="l00083"></a><a class="code" href="group__uri.html#ga4">00083</a> <span class="keywordtype">void</span> <a class="code" href="group__uri.html#ga4">u_uri_free</a> (u_uri_t *uri)
00084 {
00085     <span class="keywordflow">if</span> (uri == NULL)
00086         <span class="keywordflow">return</span>;
00087 
00088     U_FREE(uri-&gt;scheme);
00089     U_FREE(uri-&gt;user);
00090     U_FREE(uri-&gt;pwd);
00091     U_FREE(uri-&gt;host);
00092     U_FREE(uri-&gt;path);
00093     U_FREE(uri);
00094 }
00095 
<a name="l00097"></a><a class="code" href="group__uri.html#ga5">00097</a> <span class="keywordtype">int</span> <a class="code" href="group__uri.html#ga5">u_uri_parse</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *s, u_uri_t **pu)
00098 {
00099     <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *p0;
00100     <span class="keywordtype">int</span> i;
00101     u_uri_t *uri;
00102 
00103     dbg_return_if ((uri = (u_uri_t*) <a class="code" href="group__alloc.html#ga6">u_zalloc</a>(<span class="keyword">sizeof</span>(u_uri_t))) == NULL, ~0);
00104 
00105     dbg_err_if ((p = strchr(s, <span class="charliteral">':'</span>)) == NULL); <span class="comment">/* err if malformed */</span>
00106 
00107     <span class="comment">/* save schema string */</span>
00108     dbg_err_if ((uri-&gt;scheme = <a class="code" href="group__misc.html#ga19">u_strndup</a>(s, p - s)) == NULL);
00109 
00110     p++; <span class="comment">/* skip ':' */</span>
00111 
00112     <span class="comment">/* skip "//" */</span>
00113     <span class="keywordflow">for</span> (i = 0; i &lt; 2; ++i, ++p)
00114         dbg_err_if (!p || *p == 0 || *p != <span class="charliteral">'/'</span>); <span class="comment">/* err if malformed */</span>
00115 
00116     <span class="comment">/* save p */</span>
00117     p0 = p; 
00118 
00119     <span class="comment">/* find the first path char ('/') or the end of the string */</span>
00120     <span class="keywordflow">while</span> (*p &amp;&amp; *p != <span class="charliteral">'/'</span>)
00121         ++p;
00122 
00123     <span class="comment">/* parse userinfo and hostinfo */</span>
00124     dbg_err_if (p - p0 &amp;&amp; parse_middle(p0, p - p0, uri));
00125 
00126     <span class="comment">/* save path */</span>
00127     dbg_err_if (*p &amp;&amp; (uri-&gt;path = <a class="code" href="group__misc.html#ga20">u_strdup</a>(p)) == NULL);
00128 
00129     *pu = uri;
00130 
00131     <span class="keywordflow">return</span> 0;
00132 err:
00133     <a class="code" href="group__uri.html#ga4">u_uri_free</a>(uri);
00134     <span class="keywordflow">return</span> ~0;
00135 }
00136 
</pre></div><hr>
<div>
  <div style="text-align:left">
    <a href="http://www.koanlogic.com/kl/cont/gb/html/products.html">&larr;Products</a>
  </div>
  <div style="text-align:center;">
    &copy; 2005-2008 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
  </div>
</div>

</body>
</html>
