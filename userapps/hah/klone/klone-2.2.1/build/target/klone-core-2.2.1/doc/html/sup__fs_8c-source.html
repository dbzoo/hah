<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: sup_fs.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>sup_fs.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: sup_fs.c,v 1.14 2008/10/27 21:28:04 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00013 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/supplier.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/io.h&gt;</span>
00018 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00019 
00020 <span class="keyword">static</span> <span class="keywordtype">int</span> fs_is_valid_uri(http_t *h, request_t *rq, <span class="keyword">const</span> <span class="keywordtype">char</span> *uri, 
00021         size_t len, <span class="keywordtype">void</span> **handle, time_t *mtime)
00022 {
00023     <span class="keyword">struct </span>stat st; 
00024     <span class="keywordtype">char</span> fqn[U_FILENAME_MAX];
00025 
00026     dbg_return_if (uri == NULL, 0);
00027     dbg_return_if (mtime == NULL, 0);
00028     dbg_return_if (len &gt;= U_FILENAME_MAX, 0);
00029 
00030     u_unused_args(h);
00031 
00032     memcpy(fqn, uri, len);
00033     fqn[len] = 0;
00034 
00035     <span class="comment">/* fqn must be already normalized */</span>
00036     <span class="keywordflow">if</span>(strstr(fqn, <span class="stringliteral">".."</span>))
00037         <span class="keywordflow">return</span> 0; 
00038 
00039     <span class="keywordflow">if</span>(stat(fqn, &amp;st) == 0 &amp;&amp; S_ISREG(st.st_mode))
00040     {
00041         *mtime = st.st_mtime;
00042         *handle = NULL;
00043 
00044         <span class="keywordflow">return</span> 1;
00045     } <span class="keywordflow">else</span>
00046         <span class="keywordflow">return</span> 0;
00047 }
00048 
00049 <span class="keyword">static</span> <span class="keywordtype">int</span> fs_serve(request_t *rq, response_t *rs)
00050 {
00051     <span class="keyword">enum</span> { BUFSZ = 4096 };
00052     io_t *io = NULL, *out = NULL;
00053     <span class="keyword">const</span> <span class="keywordtype">char</span> *mime_type, *fqn;
00054     size_t c;
00055     <span class="keywordtype">char</span> buf[BUFSZ];
00056     <span class="keyword">struct </span>stat st;
00057 
00058     dbg_err_if (rq == NULL);
00059     dbg_err_if (rs == NULL);
00060     
00061     <span class="comment">/* output stream */</span>
00062     out = <a class="code" href="group__response.html#ga16">response_io</a>(rs);
00063     dbg_err_if(out == NULL);
00064 
00065     fqn = <a class="code" href="group__request.html#ga18">request_get_resolved_filename</a>(rq);
00066 
00067     <span class="comment">/* we need file size */</span>
00068     dbg_err_if(stat(fqn, &amp;st));
00069     dbg_err_if(<a class="code" href="group__response.html#ga22">response_set_content_length</a>(rs, st.st_size));
00070 
00071     <span class="comment">/* guess the mime type append a Content-Type field to the response*/</span>
00072     mime_type = <a class="code" href="group__ut.html#ga47">u_guess_mime_type</a>(fqn);
00073     dbg_err_if(<a class="code" href="group__response.html#ga21">response_set_content_type</a>(rs, mime_type));
00074 
00075     <span class="comment">/* add a Last-Modified field */</span>
00076     dbg_err_if(<a class="code" href="group__response.html#ga24">response_set_last_modified</a>(rs, st.st_mtime));
00077 
00078     <span class="comment">/* print the reponse header */</span>
00079     dbg_err_if(response_print_header_to_io(rs, out));
00080 
00081     <span class="comment">/* if this's a HEAD request don't print the file content */</span>
00082     <span class="keywordflow">if</span>(<a class="code" href="group__response.html#ga9">response_get_method</a>(rs) == <a class="code" href="http_8h.html#a33a22">HM_HEAD</a>)
00083         <span class="keywordflow">return</span> 0;
00084 
00085     <span class="comment">/* open and write out the whole file */</span>
00086     dbg_err_if(<a class="code" href="group__ut.html#ga35">u_file_open</a>(<a class="code" href="group__request.html#ga18">request_get_resolved_filename</a>(rq), O_RDONLY, &amp;io));
00087 
00088     <span class="keywordflow">while</span>((c = <a class="code" href="group__basic.html#ga18">io_read</a>(io, buf, BUFSZ)) &gt; 0)
00089         dbg_err_if(<a class="code" href="group__basic.html#ga19">io_write</a>(out, buf, c) &lt; 0);
00090 
00091     <a class="code" href="group__basic.html#ga14">io_free</a>(io);
00092 
00093     <span class="keywordflow">return</span> 0;
00094 err:
00095     <span class="keywordflow">if</span>(io)
00096         <a class="code" href="group__basic.html#ga14">io_free</a>(io);
00097     <span class="keywordflow">return</span> ~0;
00098 }
00099 
00100 <span class="keyword">static</span> <span class="keywordtype">int</span> fs_init(<span class="keywordtype">void</span>)
00101 {
00102     <span class="keywordflow">return</span> 0;
00103 }
00104 
00105 <span class="keyword">static</span> <span class="keywordtype">void</span> fs_term(<span class="keywordtype">void</span>)
00106 {
00107     <span class="keywordflow">return</span>;
00108 }
00109 
00110 supplier_t sup_fs = {
00111     <span class="stringliteral">"fs supplier"</span>,
00112     fs_init,
00113     fs_term,
00114     fs_is_valid_uri,
00115     fs_serve
00116 };
00117 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


