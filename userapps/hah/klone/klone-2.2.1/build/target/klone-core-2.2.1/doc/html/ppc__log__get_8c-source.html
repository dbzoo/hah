<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: ppc_log_get.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>ppc_log_get.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: ppc_log_get.c,v 1.4 2007/11/09 22:06:26 tat Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
00013 <span class="preprocessor">#include &lt;klone/klog.h&gt;</span>
00014 <span class="preprocessor">#include &lt;klone/context.h&gt;</span>
00015 <span class="preprocessor">#include &lt;klone/server.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/ppc.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/ppc_cmd.h&gt;</span>
00018 <span class="preprocessor">#include &lt;klone/server_ppc_cmd.h&gt;</span>
00019 <span class="preprocessor">#include "server_s.h"</span>
00020 
00021 <span class="comment">/* struct used for ppc command PPC_CMD_LOG_GET */</span>
00022 <span class="keyword">struct </span>ppc_log_get_s
00023 {
00024     <span class="keywordtype">int</span> bid;                        <span class="comment">/* calling backend ID       */</span>
00025     ssize_t i;                      <span class="comment">/* i-th line                */</span>
00026     <span class="keywordtype">char</span> line[KLOG_LN_SZ];          <span class="comment">/* log line                 */</span>
00027 };
00028 
00029 <span class="keyword">typedef</span> <span class="keyword">struct </span>ppc_log_get_s ppc_log_get_t;
00030 
00031 <span class="comment">/* client function */</span>
00032 <span class="keywordtype">int</span> server_ppc_cmd_log_get(server_t *s, size_t i, <span class="keywordtype">char</span> *line)
00033 {
00034     ppc_log_get_t plg;
00035     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmd;
00036 
00037     nop_err_if (s == NULL);
00038     nop_err_if (s-&gt;ppc == NULL);
00039     nop_err_if (ctx-&gt;backend == NULL);
00040     nop_err_if (line == NULL);
00041 
00042     memset(&amp;plg, 0, <span class="keyword">sizeof</span>(ppc_log_get_t));
00043 
00044     plg.bid = ctx-&gt;backend-&gt;id;
00045     plg.i = i;
00046     plg.line[0] = 0;
00047 
00048     <span class="comment">/* send the command request */</span>
00049     dbg_err_if(ppc_write(s-&gt;ppc, ctx-&gt;pipc, PPC_CMD_LOG_GET, (<span class="keywordtype">char</span>*)&amp;plg, 
00050         <span class="keyword">sizeof</span>(plg)) &lt; 0);
00051 
00052     <span class="comment">/* get the response */</span>
00053     dbg_err_if(ppc_read(s-&gt;ppc, ctx-&gt;pipc, &amp;cmd, (<span class="keywordtype">char</span>*)&amp;plg, <span class="keyword">sizeof</span>(plg)) &lt; 0);
00054 
00055     dbg_err_if(cmd != PPC_CMD_LOG_GET);
00056 
00057     nop_err_if(plg.i &lt; 0); <span class="comment">/* error or eof */</span>
00058 
00059     <span class="comment">/* copy-out the line */</span>
00060     strncpy(line, plg.line, KLOG_LN_SZ);
00061     line[KLOG_LN_SZ - 1] = 0;
00062 
00063     <span class="keywordflow">return</span> 0;
00064 err:
00065     <span class="keywordflow">return</span> ~0;
00066 }
00067 
00068 <span class="comment">/* [parent] get a log line */</span>
00069 <span class="keywordtype">int</span> server_ppc_cb_log_get(ppc_t *ppc, <span class="keywordtype">int</span> fd, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmd, <span class="keywordtype">char</span> *data, 
00070     size_t size, <span class="keywordtype">void</span> *vso)
00071 {
00072     server_t *s;
00073     ppc_log_get_t *plg;
00074     backend_t *be;
00075     klog_t *kl;
00076 
00077     u_unused_args(ppc, fd, cmd, size);
00078 
00079     dbg_err_if (vso == NULL);
00080     dbg_err_if (data == NULL);
00081 
00082     plg = (ppc_log_get_t *) data;
00083     s = (server_t *) vso;
00084 
00085     <span class="comment">/* by default use server logger */</span>
00086     kl = s-&gt;klog;
00087 
00088     <span class="comment">/* get the logger obj of the calling backend (if any) */</span>
00089     <span class="keywordflow">if</span>(!server_get_backend_by_id(s, plg-&gt;bid, &amp;be) &amp;&amp; be-&gt;klog)
00090         kl = be-&gt;klog;
00091 
00092     <span class="comment">/* get the log line */</span>
00093     <span class="keywordflow">if</span>(kl == NULL || klog_getln(kl, plg-&gt;i, plg-&gt;line))
00094         plg-&gt;i = -1; <span class="comment">/* eof or error */</span>
00095 
00096     <span class="comment">/* send back the response */</span>
00097     nop_err_if(ppc_write(s-&gt;ppc, fd, PPC_CMD_LOG_GET, (<span class="keywordtype">char</span>*)plg, 
00098         <span class="keyword">sizeof</span>(ppc_log_get_t)) &lt; 0);
00099 
00100     <span class="keywordflow">return</span> 0;
00101 err:
00102     <span class="keywordflow">return</span> ~0;
00103 }
00104 
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


