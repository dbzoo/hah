<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: entry.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>entry.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: entry.c,v 1.27 2009/10/23 14:08:28 tho Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00013 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00015 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/server.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/os.h&gt;</span>
00018 <span class="preprocessor">#include &lt;klone/context.h&gt;</span>
00019 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00020 <span class="preprocessor">#include &lt;klone/version.h&gt;</span>
00021 <span class="preprocessor">#include "main.h"</span>
00022 
00023 <span class="keywordtype">int</span> facility = LOG_LOCAL0;
00024 
00025 <span class="keyword">static</span> context_t c;
00026 context_t  *ctx = &amp;c; <span class="comment">/* exported */</span>
00027 
00028 <span class="preprocessor">#ifdef OS_WIN</span>
00029 <span class="preprocessor"></span>    <span class="comment">/* Win32 service name and description */</span>
00030     <span class="keyword">enum</span> { SS_NAME_BUFSZ = 64, SS_DESC_BUFSZ = 256 };
00031     <span class="keyword">static</span> <span class="keywordtype">char</span> ss_name[SS_NAME_BUFSZ] = <span class="stringliteral">"kloned"</span>;
00032     <span class="keyword">static</span> <span class="keywordtype">char</span> ss_desc[SS_DESC_BUFSZ] = <span class="stringliteral">"kloned daemon"</span>;
00033 
00034     <span class="keywordtype">int</span> InstallService(); 
00035     <span class="keywordtype">int</span> RemoveService();
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 <span class="keyword">static</span> <span class="keywordtype">void</span> usage()
00039 {
00040     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *us = 
00041 <span class="stringliteral">"Usage: kloned OPTIONS ARGUMENTS                                            \n"</span>
00042 <span class="stringliteral">"Version: %s - Copyright (c) 2005-2009 KoanLogic s.r.l.                     \n"</span>
00043 <span class="stringliteral">"All rights reserved.                                                       \n"</span>
00044 <span class="stringliteral">"\n"</span>
00045 <span class="stringliteral">"    -d          turn on debugging (forces iterative mode)                  \n"</span>
00046 <span class="stringliteral">"    -f file     load an external config file                               \n"</span>
00047 <span class="stringliteral">"    -p file     save daemon PID to file                                    \n"</span>
00048 <span class="stringliteral">"    -F          run in foreground                                          \n"</span>
00049 <span class="stringliteral">"    -h          display this help                                          \n"</span>
00050 <span class="preprocessor">#ifdef OS_WIN</span>
00051 <span class="preprocessor"></span><span class="stringliteral">"    -i          install KLone Windows service                              \n"</span>
00052 <span class="stringliteral">"    -u          remove KLone Windows service                               \n"</span>
00053 <span class="preprocessor">#endif</span>
00054 <span class="preprocessor"></span><span class="stringliteral">"    -V          print KLone version and exit                               \n"</span>
00055 <span class="stringliteral">"    -n          do not chdir when daemonizing                              \n"</span>
00056 <span class="stringliteral">"\n"</span>;
00057 
00058     fprintf(stderr, us, <a class="code" href="group__ut.html#ga27">klone_version</a>());
00059 
00060     exit(1);
00061 }
00062 
00063 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_opt(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00064 {
00065     <span class="keywordtype">int</span> ret;
00066 <span class="preprocessor">#ifdef OS_WIN</span>
00067 <span class="preprocessor"></span><span class="preprocessor">        #define CMDLINE_FORMAT "nhVFdiuf:p:"</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00069 <span class="preprocessor"></span><span class="preprocessor">        #define CMDLINE_FORMAT "nhVFdf:p:"</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00071 <span class="preprocessor"></span>
00072     <span class="comment">/* set defaults */</span>
00073     ctx-&gt;daemon++;
00074 
00075     <span class="keywordflow">while</span>((ret = getopt(argc, argv, CMDLINE_FORMAT)) != -1)
00076     {
00077         <span class="keywordflow">switch</span>(ret)
00078         {
00079         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:   <span class="comment">/* source a config file */</span>
00080             ctx-&gt;ext_config = u_strdup(optarg);
00081             dbg_err_if(ctx-&gt;ext_config == NULL);
00082             dbg(<span class="stringliteral">"ext config: %s"</span>, ctx-&gt;ext_config);
00083             <span class="keywordflow">break</span>;
00084 
00085         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:   <span class="comment">/* PID file */</span>
00086             ctx-&gt;pid_file = u_strdup(optarg);
00087             dbg_err_if(ctx-&gt;pid_file == NULL);
00088             dbg(<span class="stringliteral">"PID file: %s"</span>, ctx-&gt;pid_file);
00089             <span class="keywordflow">break</span>;
00090 
00091         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:   <span class="comment">/* turn on debugging */</span>
00092             ctx-&gt;debug++;
00093             <span class="keywordflow">break</span>;
00094 
00095         <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:   <span class="comment">/* run in foreground (not as a daemon/service) */</span>
00096             ctx-&gt;daemon = 0;
00097             <span class="keywordflow">break</span>;
00098 
00099         <span class="keywordflow">case</span> <span class="charliteral">'V'</span>:   <span class="comment">/* print version and exit */</span>
00100             u_print_version_and_exit();
00101             <span class="keywordflow">break</span>;
00102 
00103         <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:   <span class="comment">/* don't chdir in daemon mode */</span>
00104             ctx-&gt;nochdir = 1;
00105             <span class="keywordflow">break</span>;
00106 
00107 <span class="preprocessor">#ifdef OS_WIN</span>
00108 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:   <span class="comment">/* install kloned service and exit */</span>
00109             ctx-&gt;serv_op = SERV_INSTALL;
00110             <span class="keywordflow">break</span>;
00111 
00112         <span class="keywordflow">case</span> <span class="charliteral">'u'</span>:   <span class="comment">/* uninstall kloned service and exit */</span>
00113             ctx-&gt;serv_op = SERV_REMOVE;
00114             <span class="keywordflow">break</span>;
00115 <span class="preprocessor">#endif</span>
00116 <span class="preprocessor"></span>
00117         <span class="keywordflow">default</span>:
00118         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>: 
00119             usage();
00120         }
00121     }
00122 
00123     ctx-&gt;narg = argc - optind;
00124     ctx-&gt;arg = argv + optind;
00125 
00126     <span class="keywordflow">return</span> 0;
00127 err:
00128     <span class="keywordflow">return</span> ~0;
00129 }
00130 
00131 <span class="preprocessor">#if defined(OS_WIN)</span>
00132 <span class="preprocessor"></span>
00133 <span class="comment">/* install the service with the service manager. after successful installation</span>
00134 <span class="comment">   you can run the service from ControlPanel-&gt;AdminTools-&gt;Services */</span>
00135 <span class="keywordtype">int</span> InstallService(<span class="keywordtype">void</span>) 
00136 {
00137     SC_HANDLE hSCM, hService;
00138     <span class="keywordtype">char</span> szModulePathname[_MAX_PATH];
00139     SERVICE_DESCRIPTION sd = { ss_desc };
00140     <span class="keywordtype">int</span> rc;
00141 
00142     <span class="comment">// Open the SCM on this machine.</span>
00143     hSCM = OpenSCManager(NULL, NULL, SC_MANAGER_CREATE_SERVICE);
00144 
00145     dbg_err_if(hSCM == NULL);
00146 
00147     dbg_err_if(GetModuleFileName(GetModuleHandle(NULL), szModulePathname, 
00148         _MAX_PATH) == 0 );
00149 
00150     <span class="comment">/* add this service to the SCM's database */</span>
00151     hService = CreateService(hSCM, ss_name, ss_name,
00152         SERVICE_CHANGE_CONFIG, SERVICE_WIN32_OWN_PROCESS, 
00153         SERVICE_DEMAND_START, SERVICE_ERROR_IGNORE,
00154         szModulePathname, NULL, NULL, NULL, NULL, NULL);
00155 
00156     dbg_err_if(hService == NULL);
00157 
00158     rc = ChangeServiceConfig2(hService, SERVICE_CONFIG_DESCRIPTION, &amp;sd);
00159 
00160     dbg_err_if(rc == 0);
00161 
00162     <span class="comment">/* success */</span>
00163     MessageBox(NULL, <span class="stringliteral">"Service installation succeded"</span>, ss_name, MB_OK);
00164 
00165     <span class="keywordflow">return</span> 0; 
00166 err:
00167     <span class="comment">/* common error handling */</span>
00168     warn_strerror(GetLastError());
00169     MessageBox(NULL, <span class="stringliteral">"Service installation error"</span>, ss_name, MB_OK);
00170     <span class="keywordflow">return</span> ~0;
00171 }
00172 
00173 <span class="comment">/* uninstall this service from the system */</span>
00174 <span class="keywordtype">int</span> RemoveService(<span class="keywordtype">void</span>) 
00175 {
00176     SC_HANDLE hSCM, hService;
00177     <span class="keywordtype">int</span> rc;
00178 
00179     hSCM = OpenSCManager(NULL, NULL, SC_MANAGER_CONNECT);
00180 
00181     dbg_err_if(hSCM == NULL);
00182 
00183     <span class="comment">/* Open this service for DELETE access */</span>
00184     hService = OpenService(hSCM, ss_name, DELETE);
00185 
00186     dbg_err_if(hService == NULL);
00187 
00188     <span class="comment">/* Remove this service from the SCM's database */</span>
00189     rc = DeleteService(hService);
00190 
00191     dbg_err_if(rc == 0);
00192 
00193     <span class="comment">/* success */</span>
00194     MessageBox(NULL, <span class="stringliteral">"Uninstall secceded"</span>, ss_name, MB_OK);
00195     <span class="keywordflow">return</span> 0;
00196 err:
00197     <span class="comment">/* common error handling */</span>
00198     warn_strerror(GetLastError());
00199     MessageBox(NULL, <span class="stringliteral">"Uninstall failed"</span>, ss_name, MB_OK);
00200     <span class="keywordflow">return</span> ~0;
00201 }
00202 
00203 <span class="comment">/* this function will be called by the SCM to request an action */</span>
00204 DWORD WINAPI HandlerEx(DWORD dwControl, DWORD dwEventType, 
00205         LPVOID lpEventData, LPVOID lpContext)
00206 {
00207     <span class="keyword">enum</span> { DENY_ACTION = 0xff };
00208 
00209     <span class="keywordflow">switch</span>(dwControl)
00210     {
00211     <span class="keywordflow">case</span> SERVICE_CONTROL_INTERROGATE:
00212         dbg(<span class="stringliteral">"SERVICE_CONTROL_INTERROGATE"</span> );
00213         SetServiceStatus(ctx-&gt;hServiceStatus, &amp;ctx-&gt;status);
00214         <span class="keywordflow">return</span> NO_ERROR;
00215 
00216     <span class="keywordflow">case</span> SERVICE_CONTROL_STOP:
00217         dbg(<span class="stringliteral">"SERVICE_CONTROL_STOP"</span>);
00218 
00219         <span class="keywordflow">if</span>(ctx-&gt;status.dwCurrentState == SERVICE_STOPPED)
00220             <span class="keywordflow">return</span> NO_ERROR; <span class="comment">/* service already stopped */</span>
00221 
00222         <span class="comment">/* start the stop procedure, move to stop_pending state */</span>
00223         ctx-&gt;status.dwCheckPoint = 1;
00224         ctx-&gt;status.dwWaitHint = 2000;
00225         ctx-&gt;status.dwCurrentState = SERVICE_STOP_PENDING; 
00226         SetServiceStatus(ctx-&gt;hServiceStatus, &amp;ctx-&gt;status);
00227 
00228         server_stop(ctx-&gt;server);
00229         <span class="keywordflow">return</span> NO_ERROR;
00230 
00231     <span class="keywordflow">case</span> SERVICE_CONTROL_PAUSE:
00232         dbg(<span class="stringliteral">"SERVICE_CONTROL_PAUSE"</span>);
00233         <span class="keywordflow">break</span>;
00234 
00235     <span class="keywordflow">case</span> SERVICE_CONTROL_CONTINUE:
00236         dbg(<span class="stringliteral">"SERVICE_CONTROL_CONTINUE"</span>);
00237         <span class="keywordflow">break</span>;
00238 
00239     <span class="keywordflow">case</span> SERVICE_CONTROL_SHUTDOWN:
00240         dbg(<span class="stringliteral">"SERVICE_CONTROL_SHUTDOWN"</span>);
00241         <span class="keywordflow">break</span>;
00242 
00243     <span class="keywordflow">case</span> SERVICE_CONTROL_PARAMCHANGE:
00244         dbg(<span class="stringliteral">"SERVICE_CONTROL_PARAMCHANGE"</span>);
00245         <span class="keywordflow">break</span>;
00246 
00247     <span class="keywordflow">default</span>:
00248         dbg(<span class="stringliteral">"SERVICE_CONTROL_UNKNOWN!!!!"</span>);
00249     }
00250     <span class="keywordflow">if</span>(dwControl &gt; 127 &amp;&amp; dwControl &lt; 255)
00251     {
00252         <span class="comment">/* user defined control code */</span>
00253         dbg(<span class="stringliteral">"SERVICE_CONTROL_USER_DEFINED"</span>);
00254     }
00255 
00256     <span class="keywordflow">return</span> ERROR_CALL_NOT_IMPLEMENTED;
00257 }
00258 
00259 <span class="comment">/* this is the main function of the service. when this function returns the</span>
00260 <span class="comment"> * service will be terminated by the SCM */</span>
00261 <span class="keywordtype">void</span> WINAPI ServiceMain(DWORD argc, PTSTR *argv)
00262 {
00263     SERVICE_STATUS *pSt = &amp;ctx-&gt;status;
00264 
00265     <span class="comment">/* register the service with the ServiceControlManager */</span>
00266     ctx-&gt;hServiceStatus = RegisterServiceCtrlHandlerEx(ss_name, HandlerEx, ctx);
00267     dbg_err_if( ctx-&gt;hServiceStatus == 0 );
00268 
00269     <span class="comment">/* init the status struct and update the service status */</span>
00270     ZeroMemory(pSt, <span class="keyword">sizeof</span>(SERVICE_STATUS));
00271     <span class="comment">/* just one service in this exe */</span>
00272     pSt-&gt;dwServiceType = SERVICE_WIN32_OWN_PROCESS; 
00273     <span class="comment">/* action supported by the service */</span>
00274     pSt-&gt;dwControlsAccepted = SERVICE_ACCEPT_STOP;
00275     <span class="comment">/* error returned while starting/stopping */</span>
00276     pSt-&gt;dwWin32ExitCode = NO_ERROR;          
00277     <span class="comment">/* service specific exit code */</span>
00278     pSt-&gt;dwServiceSpecificExitCode = 0;          
00279     <span class="comment">/* we're still initializing */</span>
00280     pSt-&gt;dwCurrentState = SERVICE_START_PENDING;
00281     <span class="comment">/* for progress operation */</span>
00282     pSt-&gt;dwCheckPoint = 1;
00283     <span class="comment">/* wait hint */</span>
00284     pSt-&gt;dwWaitHint = 1000;
00285     <span class="comment">/* set status */</span>
00286     dbg_err_if(SetServiceStatus(ctx-&gt;hServiceStatus, pSt) == 0);
00287 
00288     dbg_err_if(parse_opt(argc, argv));
00289 
00290     <span class="comment">/* load config and initialize */</span>
00291     dbg_err_if(app_init());
00292 
00293     <span class="comment">/* this should happen after initialization but I don't want to</span>
00294 <span class="comment">       mess main.c with win32-only code */</span>
00295 
00296     <span class="comment">/* notify the end of initialization */</span>
00297     dbg(<span class="stringliteral">"SERVICE_RUNNING"</span>);
00298     ctx-&gt;status.dwCurrentState = SERVICE_RUNNING;
00299     ctx-&gt;status.dwCheckPoint = ctx-&gt;status.dwWaitHint = 0;    
00300     dbg_err_if(!SetServiceStatus(ctx-&gt;hServiceStatus, &amp;ctx-&gt;status));
00301 
00302     <span class="comment">/* run the main loop */</span>
00303     app_run();
00304 
00305     <span class="comment">/* let the service terminate */</span>
00306     ctx-&gt;status.dwCurrentState = SERVICE_STOPPED;
00307     dbg_err_if(!SetServiceStatus(ctx-&gt;hServiceStatus, &amp;ctx-&gt;status));
00308 
00309     <span class="keywordflow">return</span>;
00310 
00311 err:
00312     warn_strerror(GetLastError());
00313 
00314     <span class="comment">/* let the service terminate */</span>
00315     ctx-&gt;status.dwCurrentState = SERVICE_STOPPED;
00316     dbg_err_if(!SetServiceStatus(ctx-&gt;hServiceStatus, &amp;ctx-&gt;status));
00317 }
00318 
00319 <span class="keywordtype">int</span> APIENTRY WinMain(HINSTANCE hInst, HINSTANCE hPrevInst, 
00320     LPSTR lpCmdLine, <span class="keywordtype">int</span> nCmdShow)
00321 {
00322     SERVICE_TABLE_ENTRY ServiceTable[] = 
00323     {
00324         {   ss_name, ServiceMain }, 
00325         {   NULL, NULL }    <span class="comment">/* end of list */</span>
00326     };
00327     <span class="keywordtype">int</span> rc = 0;
00328     <span class="keyword">const</span> <span class="keywordtype">char</span> *name, *desc;
00329 
00330     memset(ctx, 0, <span class="keyword">sizeof</span>(context_t));
00331 
00332     <span class="comment">/* parse command line parameters (and set ctx vars). NOTE: this work only </span>
00333 <span class="comment">       if launched by command line, for services see ServiceMain */</span>
00334     dbg_err_if(parse_opt(__argc, __argv));
00335 
00336     <span class="keywordflow">if</span>(ctx-&gt;serv_op)
00337     {
00338         <span class="comment">/* load config and initialize */</span>
00339         dbg_err_if(app_init());
00340 
00341         <span class="comment">/* set up service name and description reading from the config file */</span>
00342         name = u_config_get_subkey_value(ctx-&gt;config, <span class="stringliteral">"daemon.name"</span>);
00343         <span class="keywordflow">if</span>(name)
00344             strncpy(ss_name, name, SS_NAME_BUFSZ);
00345 
00346         desc = u_config_get_subkey_value(ctx-&gt;config, <span class="stringliteral">"daemon.description"</span>);
00347         <span class="keywordflow">if</span>(desc)
00348             strncpy(ss_desc, desc, SS_DESC_BUFSZ);
00349 
00350         <span class="keywordflow">if</span>(ctx-&gt;serv_op == SERV_INSTALL)
00351             dbg_err_if(InstallService());
00352         <span class="keywordflow">else</span>    
00353             dbg_err_if(RemoveService());
00354     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ctx-&gt;daemon) {
00355         dbg(<span class="stringliteral">"Starting in service mode..."</span>);
00356         <span class="comment">/* StartServiceCtrlDispatcher does not return until the service </span>
00357 <span class="comment">           has stopped running...  */</span>
00358         <span class="keywordflow">if</span>(!StartServiceCtrlDispatcher(ServiceTable))
00359             warn_strerror(GetLastError());
00360     } <span class="keywordflow">else</span> {
00361         <span class="comment">/* load config and initialize */</span>
00362         dbg_err_if(app_init());
00363 
00364         rc = app_run();
00365     }
00366 
00367     dbg_err_if(app_term());
00368 
00369     <span class="comment">/* if debugging then call exit(3) because it's needed to gprof to dump </span>
00370 <span class="comment">       its stats file (gmon.out) */</span>
00371     <span class="keywordflow">if</span>(ctx-&gt;debug)
00372         <span class="keywordflow">return</span> rc;
00373 
00374     <span class="comment">/* don't use return because exit(3) will be called and we don't want</span>
00375 <span class="comment">       FILE* buffers to be automatically flushed (klog_file_t will write same </span>
00376 <span class="comment">       lines more times, once by the parent process and N times by any child</span>
00377 <span class="comment">       created when FILE buffer was not empty) */</span>
00378     _exit(rc); 
00379 err:
00380     app_term();
00381 
00382     <span class="keywordflow">if</span>(ctx-&gt;debug) 
00383         <span class="keywordflow">return</span> rc;
00384     _exit(EXIT_FAILURE);
00385 }
00386 
00387 <span class="preprocessor">#elif defined(OS_UNIX)</span>
00388 <span class="preprocessor"></span>
00389 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00390 {
00391     <span class="keywordtype">int</span> rc = 0;
00392 
00393     memset(ctx, 0, <span class="keyword">sizeof</span>(context_t));
00394 
00395     <span class="comment">/* parse command line parameters (and set ctx vars) */</span>
00396     dbg_err_if(parse_opt(argc, argv));
00397 
00398     <span class="keywordflow">if</span>(getenv(<span class="stringliteral">"GATEWAY_INTERFACE"</span>))
00399         ctx-&gt;cgi = 1;
00400         
00401     <span class="comment">/* load config and initialize */</span>
00402     warn_err_ifm(app_init(), <span class="stringliteral">"kloned init error (more info in the log file)"</span>);
00403 
00404     <span class="comment">/* daemonize if not -F */</span>
00405     <span class="keywordflow">if</span>(ctx-&gt;daemon &amp;&amp; !ctx-&gt;cgi)
00406         con_err_ifm(daemon(ctx-&gt;nochdir, 0), <span class="stringliteral">"daemon error"</span>);
00407 
00408     <span class="comment">/* save the PID in a file */</span>
00409     <span class="keywordflow">if</span>(ctx-&gt;pid_file)
00410         dbg_err_if(u_savepid(ctx-&gt;pid_file));
00411 
00412     <span class="comment">/* jump to the main loop */</span>
00413     rc = app_run();
00414 
00415     dbg_err_if(app_term());
00416 
00417     <span class="comment">/* if debugging then call exit(3) because it's needed to gprof to dump </span>
00418 <span class="comment">       its stats file (gmon.out) */</span>
00419     <span class="keywordflow">if</span>(ctx-&gt;debug)
00420         <span class="keywordflow">return</span> rc;
00421 
00422     <span class="comment">/* don't use return because exit(3) will be called and we don't want</span>
00423 <span class="comment">       FILE* buffers to be automatically flushed (klog_file_t will write same </span>
00424 <span class="comment">       lines more times, once by the parent process and N times by any child</span>
00425 <span class="comment">       created when FILE buffer was not empty) */</span>
00426     _exit(rc);
00427 err:
00428     app_term();
00429     <span class="keywordflow">if</span>(ctx-&gt;debug)
00430         <span class="keywordflow">return</span> ~0;
00431     _exit(EXIT_FAILURE);
00432 }
00433 
00434 <span class="preprocessor">#else</span>
00435 <span class="preprocessor"></span><span class="preprocessor">    #error unsupported platform</span>
00436 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00437 <span class="preprocessor"></span>
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


