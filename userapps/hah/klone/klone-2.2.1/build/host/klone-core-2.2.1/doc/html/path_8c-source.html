<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KLone: path.c Source File</title>
<link href="kl.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>path.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (c) 2005, 2006, 2007 by KoanLogic s.r.l. &lt;http://www.koanlogic.com&gt;</span>
00003 <span class="comment"> * All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file is part of KLone, and as such it is subject to the license stated</span>
00006 <span class="comment"> * in the LICENSE file which you have received as part of this distribution.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: path.c,v 1.6 2008/10/29 15:21:26 tho Exp $</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#include "klone_conf.h"</span>
00012 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00014 <span class="preprocessor">#include &lt;string.h&gt;</span>
00015 <span class="preprocessor">#include &lt;u/libu.h&gt;</span>
00016 <span class="preprocessor">#include &lt;klone/emb.h&gt;</span>
00017 <span class="preprocessor">#include &lt;klone/utils.h&gt;</span>
00018 <span class="preprocessor">#ifdef HAVE_STRINGS</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#include &lt;strings.h&gt;</span>
00020 <span class="preprocessor">#endif</span>
00021 <span class="preprocessor"></span>
00036 <span class="keywordtype">int</span> u_uri_normalize(<span class="keywordtype">char</span> *path)
00037 {
00038     <span class="keyword">enum</span> { SLASH = <span class="charliteral">'/'</span>, BACKSLASH = <span class="charliteral">'\\'</span> };
00039     u_string_t *s = NULL;
00040     size_t len;
00041     <span class="keywordtype">char</span> delim[2];
00042     <span class="keywordtype">char</span> *pp, *tok, *src; 
00043     <span class="keyword">const</span> <span class="keywordtype">char</span> *cs;
00044     <span class="keywordtype">int</span> trsl = 0; <span class="comment">/* trailing slash */</span>
00045 
00046     dbg_err_if(path == NULL);
00047 
00048     <span class="comment">/* convert backslashes to slashes */</span>
00049     <span class="keywordflow">for</span>(pp = path; *pp; ++pp)
00050         <span class="keywordflow">if</span>(*pp == BACKSLASH)
00051             *pp = SLASH;
00052 
00053     <span class="comment">/* must be an absolute path (i.e. must start with a slash) */</span>
00054     dbg_err_if(path[0] != SLASH); 
00055 
00056     <span class="keywordflow">if</span>(path[strlen(path)-1] == SLASH)
00057         trsl = 1;
00058 
00059     dbg_err_if(u_snprintf(delim, <span class="keyword">sizeof</span>(delim), <span class="stringliteral">"%c"</span>, SLASH));
00060 
00061     dbg_err_if(u_string_create(NULL, 0, &amp;s));
00062 
00063     <span class="comment">/* alloc a reasonable buffer immediately */</span>
00064     dbg_err_if(u_string_reserve(s, strlen(path) + 1));
00065 
00066     <span class="comment">/* foreach name=value pair... */</span>
00067     <span class="keywordflow">for</span>(src = path; (tok = strtok_r(src, delim, &amp;pp)) != NULL; src = NULL)
00068     {
00069         <span class="keywordflow">if</span>(!strcmp(tok, <span class="stringliteral">""</span>))
00070             <span class="keywordflow">continue</span>; <span class="comment">/* double slash */</span>
00071         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(tok, <span class="stringliteral">"."</span>))
00072             <span class="keywordflow">continue</span>; <span class="comment">/* /./ */</span>
00073         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(tok, <span class="stringliteral">".."</span>)) {
00074             <span class="comment">/* eat last dir */</span>
00075             len = u_string_len(s);
00076             cs = u_string_c(s) + u_string_len(s) - 1;
00077             <span class="keywordflow">for</span>(; len &amp;&amp; *cs != SLASH; --len, --cs)
00078                 <span class="keywordflow">continue</span>;
00079             <span class="comment">/* crop */</span>
00080             dbg_err_if(u_string_set_length(s, (len ? --len : 0) ));
00081         } <span class="keywordflow">else</span> {
00082             dbg_err_if(u_string_aprintf(s, <span class="stringliteral">"%c%s"</span>, SLASH, tok));
00083         }
00084     }
00085 
00086     <span class="keywordflow">if</span>(!u_string_len(s) || trsl)
00087         dbg_err_if(u_string_aprintf(s, <span class="stringliteral">"%c"</span>, SLASH));
00088 
00089     <span class="comment">/* copy out */</span>
00090     strcpy(path, u_string_c(s));
00091 
00092     u_string_free(s);
00093 
00094     <span class="keywordflow">return</span> 0;
00095 err:
00096     <span class="keywordflow">if</span>(s)
00097         u_string_free(s);
00098     <span class="keywordflow">return</span> ~0;
00099 }
00100 
00110 <span class="keywordtype">int</span> u_path_where_art_thou (<span class="keyword">const</span> <span class="keywordtype">char</span> *fqn, <span class="keywordtype">int</span> *where)
00111 {
00112     <span class="keyword">struct </span>stat sb;
00113     embres_t *dummy;
00114 
00115     dbg_return_if (fqn == NULL, ~0);
00116     dbg_return_if (where == NULL, ~0);
00117 
00118     <span class="comment">/* check embfs first */</span>
00119     <span class="keywordflow">if</span> (emb_lookup(fqn, &amp;dummy) == 0)
00120     {
00121         *where = U_PATH_IN_EMBFS;
00122         <span class="keywordflow">return</span> 0;
00123     }
00124 
00125     <span class="comment">/* then the file system */</span>
00126     <span class="keywordflow">if</span> (stat(fqn, &amp;sb) == 0)
00127     {
00128         *where = U_PATH_IN_FS;
00129         <span class="keywordflow">return</span> 0;
00130     }
00131 
00132     <span class="comment">/* then give up */</span>
00133     *where = U_PATH_NOT_FOUND;
00134 
00135     <span class="keywordflow">return</span> 0;
00136 }
</pre></div>
    </div>

    <div id="footer">
        <p>Copyright &copy; 
    2005-2007 - <a href="http://www.koanlogic.com">KoanLogic S.r.l.</a> - All rights reserved
         | Valid <a
        href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp; <a
        href="http://validator.w3.org/">XHTML</a> | powered by <a
        href="/klone/index.html">KLone</a> </p>
    </div>
</body>

</html>


